fc2cdbcb3817f5a7fc15767fcd2dfe42
const middlewares = require('../index');

describe('Middlewares', () => {
  this.config = {
    middleware: {
      timeout: 1000,
      load: {
        before: ['responseTime', 'logger', 'cors', 'responses', 'gzip'],
        order: [],
        after: ['parser', 'router']
      },
      settings: {
        bodyParser: {
          enabled: true,
          options: {}
        },
        boom: {
          enabled: false
        },
        cors: {
          headers: ['Content-Type', 'Authorization', 'Origin', 'Accept'],
          origin: '*',
          enabled: false
        },
        gzip: {
          enabled: false,
          options: {}
        },
        router: {
          enabled: true,
          prefix: '',
          routes: {}
        },
        auth: {
          enabled: true
        },
        'firebase-auth': {
          enabled: false
        },
        'http-logger': {
          enabled: true
        },
        i18n: {
          enabled: true
        }
      }
    }
  };
  test('Should load all middlewares', async () => {
    this.middleware = {
      bodyParser: {
        loaded: false,
        defaults: {
          bodyParser: {
            enabled: true,
            options: {}
          }
        },
        load: {
          initialize: jest.fn(),
          beforeInitialize: jest.fn()
        }
      },
      boom: {
        loaded: false,
        defaults: {
          responsestatus: {
            enabled: true,
            options: {}
          }
        },
        load: {
          initialize: jest.fn()
        }
      },
      cors: {
        loaded: false,
        load: {
          initialize: jest.fn()
        }
      },
      gzip: {
        loaded: false,
        defaults: {
          gzip: {
            enabled: false,
            options: {}
          }
        },
        load: {
          initialize: jest.fn()
        }
      },
      router: {
        loaded: false,
        defaults: {
          router: {
            enabled: true,
            prefix: '',
            routes: {}
          }
        },
        load: {
          initialize: jest.fn()
        }
      },
      auth: {
        loaded: false,
        defaults: {
          auth: {
            enabled: true
          }
        },
        load: {
          initialize: jest.fn()
        }
      },
      'firebase-auth': {
        loaded: false,
        defaults: {
          'firebase-auth': {
            enabled: false
          }
        },
        load: {
          initialize: jest.fn()
        }
      },
      'http-logger': {
        loaded: false,
        defaults: {
          'http-logger': {
            enabled: true
          }
        },
        load: {
          initialize: jest.fn()
        }
      },
      i18n: {
        loaded: false,
        defaults: {
          i18n: {
            enabled: true
          }
        },
        load: {
          initialize: jest.fn()
        }
      }
    };
    await middlewares.call(this);
    expect(this.middleware.bodyParser.load.initialize).toHaveBeenCalledTimes(1);
    expect(this.middleware.boom.load.initialize).toHaveBeenCalledTimes(1);
    expect(this.middleware.cors.load.initialize).toHaveBeenCalledTimes(1);
    expect(this.middleware.router.load.initialize).toHaveBeenCalledTimes(1);
    expect(this.middleware.auth.load.initialize).toHaveBeenCalledTimes(1);
    expect(this.middleware['http-logger'].load.initialize).toHaveBeenCalledTimes(1);
    expect(this.middleware.i18n.load.initialize).toHaveBeenCalledTimes(1);
  });
  test('Should throw error if have exception', async () => {
    this.middleware = {
      i18n: {
        loaded: false,
        defaults: {
          i18n: {
            enabled: true
          }
        },
        load: {
          initialize: jest.fn(() => Promise.reject('can not load i18n'))
        }
      }
    };
    await middlewares.call(this).catch(e => {
      expect(e).toBe('can not load i18n');
    });
  });
  test('Should throw error if taking too long to load', async () => {
    this.middleware = {
      i18n: {
        loaded: false,
        defaults: {
          i18n: {
            enabled: true
          }
        },
        load: {
          initialize: jest.fn(async () => await new Promise(res => setTimeout(() => res(true), 3000)))
        }
      }
    };
    await middlewares.call(this).catch(e => {
      expect(e.message).toBe(`(middleware: i18n) is taking too long to load.`);
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRlc3QuanMiXSwibmFtZXMiOlsibWlkZGxld2FyZXMiLCJyZXF1aXJlIiwiZGVzY3JpYmUiLCJjb25maWciLCJtaWRkbGV3YXJlIiwidGltZW91dCIsImxvYWQiLCJiZWZvcmUiLCJvcmRlciIsImFmdGVyIiwic2V0dGluZ3MiLCJib2R5UGFyc2VyIiwiZW5hYmxlZCIsIm9wdGlvbnMiLCJib29tIiwiY29ycyIsImhlYWRlcnMiLCJvcmlnaW4iLCJnemlwIiwicm91dGVyIiwicHJlZml4Iiwicm91dGVzIiwiYXV0aCIsImkxOG4iLCJ0ZXN0IiwibG9hZGVkIiwiZGVmYXVsdHMiLCJpbml0aWFsaXplIiwiamVzdCIsImZuIiwiYmVmb3JlSW5pdGlhbGl6ZSIsInJlc3BvbnNlc3RhdHVzIiwiY2FsbCIsImV4cGVjdCIsInRvSGF2ZUJlZW5DYWxsZWRUaW1lcyIsIlByb21pc2UiLCJyZWplY3QiLCJjYXRjaCIsImUiLCJ0b0JlIiwicmVzIiwic2V0VGltZW91dCIsIm1lc3NhZ2UiXSwibWFwcGluZ3MiOiJBQUFBLE1BQU1BLFdBQVcsR0FBR0MsT0FBTyxDQUFDLFVBQUQsQ0FBM0I7O0FBRUFDLFFBQVEsQ0FBQyxhQUFELEVBQWdCLE1BQU07QUFDNUIsT0FBS0MsTUFBTCxHQUFjO0FBQ1pDLElBQUFBLFVBQVUsRUFBRTtBQUNWQyxNQUFBQSxPQUFPLEVBQUUsSUFEQztBQUVWQyxNQUFBQSxJQUFJLEVBQUU7QUFDSkMsUUFBQUEsTUFBTSxFQUFFLENBQUMsY0FBRCxFQUFpQixRQUFqQixFQUEyQixNQUEzQixFQUFtQyxXQUFuQyxFQUFnRCxNQUFoRCxDQURKO0FBRUpDLFFBQUFBLEtBQUssRUFBRSxFQUZIO0FBR0pDLFFBQUFBLEtBQUssRUFBRSxDQUFDLFFBQUQsRUFBVyxRQUFYO0FBSEgsT0FGSTtBQU9WQyxNQUFBQSxRQUFRLEVBQUU7QUFDUkMsUUFBQUEsVUFBVSxFQUFFO0FBQUVDLFVBQUFBLE9BQU8sRUFBRSxJQUFYO0FBQWlCQyxVQUFBQSxP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LCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBtaWRkbGV3YXJlcyA9IHJlcXVpcmUoJy4uL2luZGV4Jyk7XG5cbmRlc2NyaWJlKCdNaWRkbGV3YXJlcycsICgpID0+IHtcbiAgdGhpcy5jb25maWcgPSB7XG4gICAgbWlkZGxld2FyZToge1xuICAgICAgdGltZW91dDogMTAwMCxcbiAgICAgIGxvYWQ6IHtcbiAgICAgICAgYmVmb3JlOiBbJ3Jlc3BvbnNlVGltZScsICdsb2dnZXInLCAnY29ycycsICdyZXNwb25zZXMnLCAnZ3ppcCddLFxuICAgICAgICBvcmRlcjogW10sXG4gICAgICAgIGFmdGVyOiBbJ3BhcnNlcicsICdyb3V0ZXInXSxcbiAgICAgIH0sXG4gICAgICBzZXR0aW5nczoge1xuICAgICAgICBib2R5UGFyc2VyOiB7IGVuYWJsZWQ6IHRydWUsIG9wdGlvbnM6IHt9IH0sXG4gICAgICAgIGJvb206IHsgZW5hYmxlZDogZmFsc2UgfSxcbiAgICAgICAgY29yczoge1xuICAgICAgICAgIGhlYWRlcnM6IFsnQ29udGVudC1UeXBlJywgJ0F1dGhvcml6YXRpb24nLCAnT3JpZ2luJywgJ0FjY2VwdCddLFxuICAgICAgICAgIG9yaWdpbjogJyonLFxuICAgICAgICAgIGVuYWJsZWQ6IGZhbHNlLFxuICAgICAgICB9LFxuICAgICAgICBnemlwOiB7IGVuYWJsZWQ6IGZhbHNlLCBvcHRpb25zOiB7fSB9LFxuICAgICAgICByb3V0ZXI6IHsgZW5hYmxlZDogdHJ1ZSwgcHJlZml4OiAnJywgcm91dGVzOiB7fSB9LFxuICAgICAgICBhdXRoOiB7IGVuYWJsZWQ6IHRydWUgfSxcbiAgICAgICAgJ2ZpcmViYXNlLWF1dGgnOiB7IGVuYWJsZWQ6IGZhbHNlIH0sXG4gICAgICAgICdodHRwLWxvZ2dlcic6IHsgZW5hYmxlZDogdHJ1ZSB9LFxuICAgICAgICBpMThuOiB7IGVuYWJsZWQ6IHRydWUgfSxcbiAgICAgIH0sXG4gICAgfSxcbiAgfTtcblxuICB0ZXN0KCdTaG91bGQgbG9hZCBhbGwgbWlkZGxld2FyZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgdGhpcy5taWRkbGV3YXJlID0ge1xuICAgICAgYm9keVBhcnNlcjoge1xuICAgICAgICBsb2FkZWQ6IGZhbHNlLFxuICAgICAgICBkZWZhdWx0czoge1xuICAgICAgICAgIGJvZHlQYXJzZXI6IHtcbiAgICAgICAgICAgIGVuYWJsZWQ6IHRydWUsXG4gICAgICAgICAgICBvcHRpb25zOiB7fSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBsb2FkOiB7XG4gICAgICAgICAgaW5pdGlhbGl6ZTogamVzdC5mbigpLFxuICAgICAgICAgIGJlZm9yZUluaXRpYWxpemU6IGplc3QuZm4oKVxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIGJvb206IHtcbiAgICAgICAgbG9hZGVkOiBmYWxzZSxcbiAgICAgICAgZGVmYXVsdHM6IHtcbiAgICAgICAgICByZXNwb25zZXN0YXR1czoge1xuICAgICAgICAgICAgZW5hYmxlZDogdHJ1ZSxcbiAgICAgICAgICAgIG9wdGlvbnM6IHt9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIGxvYWQ6IHtcbiAgICAgICAgICBpbml0aWFsaXplOiBqZXN0LmZuKCksXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgY29yczoge1xuICAgICAgICBsb2FkZWQ6IGZhbHNlLFxuICAgICAgICBsb2FkOiB7XG4gICAgICAgICAgaW5pdGlhbGl6ZTogamVzdC5mbigpLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIGd6aXA6IHtcbiAgICAgICAgbG9hZGVkOiBmYWxzZSxcbiAgICAgICAgZGVmYXVsdHM6IHtcbiAgICAgICAgICBnemlwOiB7XG4gICAgICAgICAgICBlbmFibGVkOiBmYWxzZSxcbiAgICAgICAgICAgIG9wdGlvbnM6IHt9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIGxvYWQ6IHtcbiAgICAgICAgICBpbml0aWFsaXplOiBqZXN0LmZuKCksXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgcm91dGVyOiB7XG4gICAgICAgIGxvYWRlZDogZmFsc2UsXG4gICAgICAgIGRlZmF1bHRzOiB7XG4gICAgICAgICAgcm91dGVyOiB7XG4gICAgICAgICAgICBlbmFibGVkOiB0cnVlLFxuICAgICAgICAgICAgcHJlZml4OiAnJyxcbiAgICAgICAgICAgIHJvdXRlczoge30sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgbG9hZDoge1xuICAgICAgICAgIGluaXRpYWxpemU6IGplc3QuZm4oKSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBhdXRoOiB7XG4gICAgICAgIGxvYWRlZDogZmFsc2UsXG4gICAgICAgIGRlZmF1bHRzOiB7XG4gICAgICAgICAgYXV0aDoge1xuICAgICAgICAgICAgZW5hYmxlZDogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBsb2FkOiB7XG4gICAgICAgICAgaW5pdGlhbGl6ZTogamVzdC5mbigpLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgICdmaXJlYmFzZS1hdXRoJzoge1xuICAgICAgICBsb2FkZWQ6IGZhbHNlLFxuICAgICAgICBkZWZhdWx0czoge1xuICAgICAgICAgICdmaXJlYmFzZS1hdXRoJzoge1xuICAgICAgICAgICAgZW5hYmxlZDogZmFsc2UsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgbG9hZDoge1xuICAgICAgICAgIGluaXRpYWxpemU6IGplc3QuZm4oKSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICAnaHR0cC1sb2dnZXInOiB7XG4gICAgICAgIGxvYWRlZDogZmFsc2UsXG4gICAgICAgIGRlZmF1bHRzOiB7XG4gICAgICAgICAgJ2h0dHAtbG9nZ2VyJzoge1xuICAgICAgICAgICAgZW5hYmxlZDogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBsb2FkOiB7XG4gICAgICAgICAgaW5pdGlhbGl6ZTogamVzdC5mbigpLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIGkxOG46IHtcbiAgICAgICAgbG9hZGVkOiBmYWxzZSxcbiAgICAgICAgZGVmYXVsdHM6IHtcbiAgICAgICAgICBpMThuOiB7XG4gICAgICAgICAgICBlbmFibGVkOiB0cnVlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIGxvYWQ6IHtcbiAgICAgICAgICBpbml0aWFsaXplOiBqZXN0LmZuKCksXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH07XG4gICAgYXdhaXQgbWlkZGxld2FyZXMuY2FsbCh0aGlzKTtcbiAgICBleHBlY3QodGhpcy5taWRkbGV3YXJlLmJvZHlQYXJzZXIubG9hZC5pbml0aWFsaXplKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gICAgZXhwZWN0KHRoaXMubWlkZGxld2FyZS5ib29tLmxvYWQuaW5pdGlhbGl6ZSkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgIGV4cGVjdCh0aGlzLm1pZGRsZXdhcmUuY29ycy5sb2FkLmluaXRpYWxpemUpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICBleHBlY3QodGhpcy5taWRkbGV3YXJlLnJvdXRlci5sb2FkLmluaXRpYWxpemUpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICBleHBlY3QodGhpcy5taWRkbGV3YXJlLmF1dGgubG9hZC5pbml0aWFsaXplKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gICAgZXhwZWN0KFxuICAgICAgdGhpcy5taWRkbGV3YXJlWydodHRwLWxvZ2dlciddLmxvYWQuaW5pdGlhbGl6ZVxuICAgICkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgIGV4cGVjdCh0aGlzLm1pZGRsZXdhcmUuaTE4bi5sb2FkLmluaXRpYWxpemUpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgfSk7XG5cbiAgdGVzdCgnU2hvdWxkIHRocm93IGVycm9yIGlmIGhhdmUgZXhjZXB0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgIHRoaXMubWlkZGxld2FyZSA9IHtcbiAgICAgIGkxOG46IHtcbiAgICAgICAgbG9hZGVkOiBmYWxzZSxcbiAgICAgICAgZGVmYXVsdHM6IHtcbiAgICAgICAgICBpMThuOiB7XG4gICAgICAgICAgICBlbmFibGVkOiB0cnVlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIGxvYWQ6IHtcbiAgICAgICAgICBpbml0aWFsaXplOiBqZXN0LmZuKCgpID0+IFByb21pc2UucmVqZWN0KCdjYW4gbm90IGxvYWQgaTE4bicpKSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIGF3YWl0IG1pZGRsZXdhcmVzLmNhbGwodGhpcykuY2F0Y2goKGUpID0+IHtcbiAgICAgIGV4cGVjdChlKS50b0JlKCdjYW4gbm90IGxvYWQgaTE4bicpO1xuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdTaG91bGQgdGhyb3cgZXJyb3IgaWYgdGFraW5nIHRvbyBsb25nIHRvIGxvYWQnLCBhc3luYyAoKSA9PiB7XG4gICAgdGhpcy5taWRkbGV3YXJlID0ge1xuICAgICAgaTE4bjoge1xuICAgICAgICBsb2FkZWQ6IGZhbHNlLFxuICAgICAgICBkZWZhdWx0czoge1xuICAgICAgICAgIGkxOG46IHtcbiAgICAgICAgICAgIGVuYWJsZWQ6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgbG9hZDoge1xuICAgICAgICAgIGluaXRpYWxpemU6IGplc3QuZm4oXG4gICAgICAgICAgICBhc3luYyAoKSA9PlxuICAgICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzKSA9PiBzZXRUaW1lb3V0KCgpID0+IHJlcyh0cnVlKSwgMzAwMCkpXG4gICAgICAgICAgKSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIGF3YWl0IG1pZGRsZXdhcmVzLmNhbGwodGhpcykuY2F0Y2goKGUpID0+IHtcbiAgICAgIGV4cGVjdChlLm1lc3NhZ2UpLnRvQmUoYChtaWRkbGV3YXJlOiBpMThuKSBpcyB0YWtpbmcgdG9vIGxvbmcgdG8gbG9hZC5gKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdfQ==