12e330e78ef8d43dec0aa439baf7ca25
const _ = require('lodash');

const createRouteChecker = require('./routerChecker');

module.exports = app => {
  const routerChecker = createRouteChecker(sgApp);
  return (route, {
    plugin,
    router
  }) => {
    if (_.isEmpty(_.get(route, 'method')) || _.isEmpty(_.get(route, 'path'))) {
      return;
    }

    const checker = routerChecker(route, plugin);
    const {
      method,
      endpoint,
      policies,
      action
    } = checker;

    if (_.isUndefined(action) || !_.isFunction(action)) {
      // eslint-disable-next-line consistent-return
      return app.log.warn(`Ignored attempt to bind route '${route.method} ${route.path}' to unknown controller/action.`);
    }

    router[method](endpoint, policies, async (req, res, next) => {
      const resp = await action(req, res, next);

      if (resp && resp.headersSent) {
        return resp;
      }

      return res.json({
        data: resp
      });
    });
  };
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvc2VFbmRwb2ludC5qcyJdLCJuYW1lcyI6WyJfIiwicmVxdWlyZSIsImNyZWF0ZVJvdXRlQ2hlY2tlciIsIm1vZHVsZSIsImV4cG9ydHMiLCJhcHAiLCJyb3V0ZXJDaGVja2VyIiwic2dBcHAiLCJyb3V0ZSIsInBsdWdpbiIsInJvdXRlciIsImlzRW1wdHkiLCJnZXQiLCJjaGVja2VyIiwibWV0aG9kIiwiZW5kcG9pbnQiLCJwb2xpY2llcyIsImFjdGlvbiIsImlzVW5kZWZpbmVkIiwiaXNGdW5jdGlvbiIsImxvZyIsIndhcm4iLCJwYXRoIiwicmVxIiwicmVzIiwibmV4dCIsInJlc3AiLCJoZWFkZXJzU2VudCIsImpzb24iLCJkYXRhIl0sIm1hcHBpbmdzIjoiQUFBQSxNQUFNQSxDQUFDLEdBQUdDLE9BQU8sQ0FBQyxRQUFELENBQWpCOztBQUNBLE1BQU1DLGtCQUFrQixHQUFHRCxPQUFPLENBQUMsaUJBQUQsQ0FBbEM7O0FBRUFFLE1BQU0sQ0FBQ0MsT0FBUCxHQUFrQkMsR0FBRCxJQUFTO0FBQ3hCLFFBQU1DLGFBQWEsR0FBR0osa0JBQWtCLENBQUNLLEtBQUQsQ0FBeEM7QUFFQSxTQUFPLENBQUNDLEtBQUQsRUFBUTtBQUFFQyxJQUFBQSxNQUFGO0FBQVVDLElBQUFBO0FBQVYsR0FBUixLQUErQjtBQUNwQyxRQUFJVixDQUFDLENBQUNXLE9BQUYsQ0FBVVgsQ0FBQyxDQUFDWSxHQUFGLENBQU1KLEtBQU4sRUFBYSxRQUFiLENBQVYsS0FBcUNSLENBQUMsQ0FBQ1csT0FBRixDQUFVWCxDQUFDLENBQUNZLEdBQUYsQ0FBTUosS0FBTixFQUFhLE1BQWIsQ0FBVixDQUF6QyxFQUEwRTtBQUN4RTtBQUNEOztBQUVELFVBQU1LLE9BQU8sR0FBR1AsYUFBYSxDQUFDRSxLQUFELEVBQVFDLE1BQVIsQ0FBN0I7QUFDQSxVQUFNO0FBQUVLLE1BQUFBLE1BQUY7QUFBVUMsTUFBQUEsUUFBVjtBQUFvQkMsTUFBQUEsUUFBcEI7QUFBOEJDLE1BQUFBO0FBQTlCLFFBQXlDSixPQUEvQzs7QUFFQSxRQUFJYixDQUFDLENBQUNrQixXQUFGLENBQWNELE1BQWQsS0FBeUIsQ0FBQ2pCLENBQUMsQ0FBQ21CLFVBQUYsQ0FBYUYsTUFBYixDQUE5QixFQUFvRDtBQUNsRDtBQUNBLGFBQU9aLEdBQUcsQ0FBQ2UsR0FBSixDQUFRQyxJQUFSLENBQ0osa0NBQWlDYixLQUFLLENBQUNNLE1BQU8sSUFBR04sS0FBSyxDQUFDYyxJQUFLLGlDQUR4RCxDQUFQO0FBR0Q7O0FBRURaLElBQUFBLE1BQU0sQ0FBQ0ksTUFBRCxDQUFOLENBQWVDLFFBQWYsRUFBeUJDLFFBQXpCLEVBQW1DLE9BQU9PLEdBQVAsRUFBWUMsR0FBWixFQUFpQkMsSUFBakIsS0FBMEI7QUFDM0QsWUFBTUMsSUFBSSxHQUFHLE1BQU1ULE1BQU0sQ0FBQ00sR0FBRCxFQUFNQyxHQUFOLEVBQVdDLElBQVgsQ0FBekI7O0FBQ0EsVUFBSUMsSUFBSSxJQUFJQSxJQUFJLENBQUNDLFdBQWpCLEVBQThCO0FBQzVCLGVBQU9ELElBQVA7QUFDRDs7QUFDRCxhQUFPRixHQUFHLENBQUNJLElBQUosQ0FBUztBQUFFQyxRQUFBQSxJQUFJLEVBQUVIO0FBQVIsT0FBVCxDQUFQO0FBQ0QsS0FORDtBQU9ELEdBdEJEO0FBdUJELENBMUJEIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xuY29uc3QgY3JlYXRlUm91dGVDaGVja2VyID0gcmVxdWlyZSgnLi9yb3V0ZXJDaGVja2VyJyk7XG5cbm1vZHVsZS5leHBvcnRzID0gKGFwcCkgPT4ge1xuICBjb25zdCByb3V0ZXJDaGVja2VyID0gY3JlYXRlUm91dGVDaGVja2VyKHNnQXBwKTtcblxuICByZXR1cm4gKHJvdXRlLCB7IHBsdWdpbiwgcm91dGVyIH0pID0+IHtcbiAgICBpZiAoXy5pc0VtcHR5KF8uZ2V0KHJvdXRlLCAnbWV0aG9kJykpIHx8IF8uaXNFbXB0eShfLmdldChyb3V0ZSwgJ3BhdGgnKSkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBjaGVja2VyID0gcm91dGVyQ2hlY2tlcihyb3V0ZSwgcGx1Z2luKTtcbiAgICBjb25zdCB7IG1ldGhvZCwgZW5kcG9pbnQsIHBvbGljaWVzLCBhY3Rpb24gfSA9IGNoZWNrZXI7XG5cbiAgICBpZiAoXy5pc1VuZGVmaW5lZChhY3Rpb24pIHx8ICFfLmlzRnVuY3Rpb24oYWN0aW9uKSkge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNvbnNpc3RlbnQtcmV0dXJuXG4gICAgICByZXR1cm4gYXBwLmxvZy53YXJuKFxuICAgICAgICBgSWdub3JlZCBhdHRlbXB0IHRvIGJpbmQgcm91dGUgJyR7cm91dGUubWV0aG9kfSAke3JvdXRlLnBhdGh9JyB0byB1bmtub3duIGNvbnRyb2xsZXIvYWN0aW9uLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcm91dGVyW21ldGhvZF0oZW5kcG9pbnQsIHBvbGljaWVzLCBhc3luYyAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGNvbnN0IHJlc3AgPSBhd2FpdCBhY3Rpb24ocmVxLCByZXMsIG5leHQpO1xuICAgICAgaWYgKHJlc3AgJiYgcmVzcC5oZWFkZXJzU2VudCkge1xuICAgICAgICByZXR1cm4gcmVzcDtcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXMuanNvbih7IGRhdGE6IHJlc3AgfSk7XG4gICAgfSk7XG4gIH07XG59O1xuIl19