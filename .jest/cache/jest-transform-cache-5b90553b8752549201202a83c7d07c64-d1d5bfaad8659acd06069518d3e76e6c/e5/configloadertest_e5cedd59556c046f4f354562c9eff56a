ca8546e7b84b10c8eb7e6cc5893d0bae
const path = require('path');

const fs = require('fs');

const del = require('del');

const loadConfigs = require('../config-loader');

const getConfigDir = prefix => {
  const dir = process.cwd();
  const configDir = path.resolve(dir, prefix ? `${prefix}-config` : 'config');

  if (!fs.existsSync(configDir)) {
    fs.mkdirSync(configDir);
  }

  return configDir;
};

const testConfigDir = getConfigDir('test');
const configDir = getConfigDir();
describe('Run config loader', () => {
  beforeAll(() => {
    // copy all from config to test config
    const files = fs.readdirSync(configDir).filter(file => file.endsWith('.js') || file.endsWith('.json'));
    files.forEach(f => {
      fs.copyFileSync(path.join(configDir, f), path.join(testConfigDir, f));
    });
  });
  afterAll(async () => {
    await del(testConfigDir);
    await del(getConfigDir('not-exist'));
  });
  test('Should return empty object if the configuration directory does not exists', () => {
    const configDir = getConfigDir('not-exist');
    const configs = loadConfigs(configDir);
    expect(Object.keys(configs).length).toEqual(0);
  });
  test('Should load configuration file from config directory', () => {
    // load all configuration in /path/to/project/dir/config
    const configs = loadConfigs(testConfigDir);
    expect(configs).toEqual({
      database: expect.any(Object),
      email: expect.any(Object),
      middleware: expect.any(Object),
      plugins: expect.any(Object),
      server: expect.any(Object)
    });
  });
  test('should throw exception if config dir contain invalid javascript file', () => {
    // create file
    const invalidFilePath = path.join(testConfigDir, 'invalid.js');
    fs.writeFileSync(invalidFilePath, 'Not a javascript file');
    expect(() => {
      loadConfigs(testConfigDir);
    }).toThrowError();
    fs.unlinkSync(invalidFilePath);
  });
  test('Should load json config file if it exists', () => {
    // create file
    const jsonConfigFilePath = path.join(testConfigDir, 'hello.json');
    const helloConfig = {
      name: 'world'
    };
    fs.writeFileSync(jsonConfigFilePath, JSON.stringify(helloConfig));
    const configs = loadConfigs(testConfigDir);
    expect(configs.hello).toEqual(helloConfig);
    fs.unlinkSync(jsonConfigFilePath);
  });
  test('should throw exception if config dir contain invalid json file', () => {
    // create file
    const invalidFilePath = path.join(testConfigDir, 'invalid.json');
    fs.writeFileSync(invalidFilePath, 'Not a json file');
    expect(() => {
      loadConfigs(testConfigDir);
    }).toThrowError();
    fs.unlinkSync(invalidFilePath);
  });
  test("shouldn't load empty configuration for json / js file", () => {
    // create file
    const invalidFilePath = path.join(testConfigDir, 'anyfile.ext');
    fs.writeFileSync(invalidFilePath, 'Not a json / js file');
    const configs = loadConfigs(testConfigDir);
    expect(Object.keys(configs.anyfile).length).toEqual(0);
    fs.unlinkSync(invalidFilePath);
  });
  test('should load nested json configuration', () => {
    // create file
    const jsonConfigFilePath = path.join(testConfigDir, 'hello.json');
    const helloConfig = {
      name: 'world',
      profile: {
        phone: '0123456789'
      }
    };
    fs.writeFileSync(jsonConfigFilePath, JSON.stringify(helloConfig));
    const configs = loadConfigs(testConfigDir);
    expect(configs.hello).toEqual(helloConfig);
    fs.unlinkSync(jsonConfigFilePath);
  });
  test('should load json configuration with expression inside value', () => {
    // create file
    const jsonConfigFilePath = path.join(testConfigDir, 'hello.json');
    const helloConfig = {
      firstName: 'world',
      lastName: 'hello',
      // eslint-disable-next-line no-template-curly-in-string
      fullName: "${acc.firstName + ' ' + acc.lastName}"
    };
    fs.writeFileSync(jsonConfigFilePath, JSON.stringify(helloConfig));
    const configs = loadConfigs(testConfigDir);
    expect(configs.hello).toEqual({
      firstName: helloConfig.firstName,
      lastName: helloConfig.lastName,
      fullName: `${helloConfig.firstName} ${helloConfig.lastName}`
    });
    fs.unlinkSync(jsonConfigFilePath);
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbmZpZy1sb2FkZXIudGVzdC5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsImZzIiwiZGVsIiwibG9hZENvbmZpZ3MiLCJnZXRDb25maWdEaXIiLCJwcmVmaXgiLCJkaXIiLCJwcm9jZXNzIiwiY3dkIiwiY29uZmlnRGlyIiwicmVzb2x2ZSIsImV4aXN0c1N5bmMiLCJta2RpclN5bmMiLCJ0ZXN0Q29uZmlnRGlyIiwiZGVzY3JpYmUiLCJiZWZvcmVBbGwiLCJmaWxlcyIsInJlYWRkaXJTeW5jIiwiZmlsdGVyIiwiZmlsZSIsImVuZHNXaXRoIiwiZm9yRWFjaCIsImYiLCJjb3B5RmlsZVN5bmMiLCJqb2luIiwiYWZ0ZXJBbGwiLCJ0ZXN0IiwiY29uZmlncyIsImV4cGVjdCIsIk9iamVjdCIsImtleXMiLCJsZW5ndGgiLCJ0b0VxdWFsIiwiZGF0YWJhc2UiLCJhbnkiLCJlbWFpbCIsIm1pZGRsZXdhcmUiLCJwbHVnaW5zIiwic2VydmVyIiwiaW52YWxpZEZpbGVQYXRoIiwid3JpdGVGaWxlU3luYyIsInRvVGhyb3dFcnJvciIsInVubGlua1N5bmMiLCJqc29uQ29uZmlnRmlsZVBhdGgiLCJoZWxsb0NvbmZpZyIsIm5hbWUiLCJKU09OIiwic3RyaW5naWZ5IiwiaGVsbG8iLCJhbnlmaWxlIiwicHJvZmlsZSIsInBob25lIiwiZmlyc3ROYW1lIiwibGFzdE5hbWUiLCJmdWxsTmFtZSJdLCJtYXBwaW5ncyI6IkFBQUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNQyxFQUFFLEdBQUdELE9BQU8sQ0FBQyxJQUFELENBQWxCOztBQUNBLE1BQU1FLEdBQUcsR0FBR0YsT0FBTyxDQUFDLEtBQUQsQ0FBbkI7O0FBQ0EsTUFBTUcsV0FBVyxHQUFHSCxPQUFPLENBQUMsa0JBQUQsQ0FBM0I7O0FBRUEsTUFBTUksWUFBWSxHQUFJQyxNQUFELElBQVk7QUFDL0IsUUFBTUMsR0FBRyxHQUFHQyxPQUFPLENBQUNDLEdBQVIs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O0FBQ2xCUSxNQUFBQSxTQUFTLEVBQUUsT0FETztBQUVsQkMsTUFBQUEsUUFBUSxFQUFFLE9BRlE7QUFHbEI7QUFDQUMsTUFBQUEsUUFBUSxFQUFFO0FBSlEsS0FBcEI7QUFNQXJELElBQUFBLEVBQUUsQ0FBQ3VDLGFBQUgsQ0FBaUJHLGtCQUFqQixFQUFxQ0csSUFBSSxDQUFDQyxTQUFMLENBQWVILFdBQWYsQ0FBckM7QUFDQSxVQUFNakIsT0FBTyxHQUFHeEIsV0FBVyxDQUFDVSxhQUFELENBQTNCO0FBQ0FlLElBQUFBLE1BQU0sQ0FBQ0QsT0FBTyxDQUFDcUIsS0FBVCxDQUFOLENBQXNCaEIsT0FBdEIsQ0FBOEI7QUFDNUJvQixNQUFBQSxTQUFTLEVBQUVSLFdBQVcsQ0FBQ1EsU0FESztBQUU1QkMsTUFBQUEsUUFBUSxFQUFFVCxXQUFXLENBQUNTLFFBRk07QUFHNUJDLE1BQUFBLFFBQVEsRUFBRyxHQUFFVixXQUFXLENBQUNRLFNBQVUsSUFBR1IsV0FBVyxDQUFDUyxRQUFTO0FBSC9CLEtBQTlCO0FBS0FwRCxJQUFBQSxFQUFFLENBQUN5QyxVQUFILENBQWNDLGtCQUFkO0FBQ0QsR0FqQkcsQ0FBSjtBQWtCRCxDQXBHTyxDQUFSIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKTtcbmNvbnN0IGRlbCA9IHJlcXVpcmUoJ2RlbCcpO1xuY29uc3QgbG9hZENvbmZpZ3MgPSByZXF1aXJlKCcuLi9jb25maWctbG9hZGVyJyk7XG5cbmNvbnN0IGdldENvbmZpZ0RpciA9IChwcmVmaXgpID0+IHtcbiAgY29uc3QgZGlyID0gcHJvY2Vzcy5jd2QoKTtcbiAgY29uc3QgY29uZmlnRGlyID0gcGF0aC5yZXNvbHZlKGRpciwgcHJlZml4ID8gYCR7cHJlZml4fS1jb25maWdgIDogJ2NvbmZpZycpO1xuICBpZiAoIWZzLmV4aXN0c1N5bmMoY29uZmlnRGlyKSkge1xuICAgIGZzLm1rZGlyU3luYyhjb25maWdEaXIpO1xuICB9XG5cbiAgcmV0dXJuIGNvbmZpZ0Rpcjtcbn07XG5cbmNvbnN0IHRlc3RDb25maWdEaXIgPSBnZXRDb25maWdEaXIoJ3Rlc3QnKTtcbmNvbnN0IGNvbmZpZ0RpciA9IGdldENvbmZpZ0RpcigpO1xuXG5kZXNjcmliZSgnUnVuIGNvbmZpZyBsb2FkZXInLCAoKSA9PiB7XG4gIGJlZm9yZUFsbCgoKSA9PiB7XG4gICAgLy8gY29weSBhbGwgZnJvbSBjb25maWcgdG8gdGVzdCBjb25maWdcbiAgICBjb25zdCBmaWxlcyA9IGZzXG4gICAgICAucmVhZGRpclN5bmMoY29uZmlnRGlyKVxuICAgICAgLmZpbHRlcigoZmlsZSkgPT4gZmlsZS5lbmRzV2l0aCgnLmpzJykgfHwgZmlsZS5lbmRzV2l0aCgnLmpzb24nKSk7XG4gICAgZmlsZXMuZm9yRWFjaCgoZikgPT4ge1xuICAgICAgZnMuY29weUZpbGVTeW5jKHBhdGguam9pbihjb25maWdEaXIsIGYpLCBwYXRoLmpvaW4odGVzdENvbmZpZ0RpciwgZikpO1xuICAgIH0pO1xuICB9KTtcbiAgYWZ0ZXJBbGwoYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IGRlbCh0ZXN0Q29uZmlnRGlyKTtcbiAgICBhd2FpdCBkZWwoZ2V0Q29uZmlnRGlyKCdub3QtZXhpc3QnKSk7XG4gIH0pO1xuXG4gIHRlc3QoJ1Nob3VsZCByZXR1cm4gZW1wdHkgb2JqZWN0IGlmIHRoZSBjb25maWd1cmF0aW9uIGRpcmVjdG9yeSBkb2VzIG5vdCBleGlzdHMnLCAoKSA9PiB7XG4gICAgY29uc3QgY29uZmlnRGlyID0gZ2V0Q29uZmlnRGlyKCdub3QtZXhpc3QnKTtcbiAgICBjb25zdCBjb25maWdzID0gbG9hZENvbmZpZ3MoY29uZmlnRGlyKTtcbiAgICBleHBlY3QoT2JqZWN0LmtleXMoY29uZmlncykubGVuZ3RoKS50b0VxdWFsKDApO1xuICB9KTtcblxuICB0ZXN0KCdTaG91bGQgbG9hZCBjb25maWd1cmF0aW9uIGZpbGUgZnJvbSBjb25maWcgZGlyZWN0b3J5JywgKCkgPT4ge1xuICAgIC8vIGxvYWQgYWxsIGNvbmZpZ3VyYXRpb24gaW4gL3BhdGgvdG8vcHJvamVjdC9kaXIvY29uZmlnXG4gICAgY29uc3QgY29uZmlncyA9IGxvYWRDb25maWdzKHRlc3RDb25maWdEaXIpO1xuICAgIGV4cGVjdChjb25maWdzKS50b0VxdWFsKHtcbiAgICAgIGRhdGFiYXNlOiBleHBlY3QuYW55KE9iamVjdCksXG4gICAgICBlbWFpbDogZXhwZWN0LmFueShPYmplY3QpLFxuICAgICAgbWlkZGxld2FyZTogZXhwZWN0LmFueShPYmplY3QpLFxuICAgICAgcGx1Z2luczogZXhwZWN0LmFueShPYmplY3QpLFxuICAgICAgc2VydmVyOiBleHBlY3QuYW55KE9iamVjdCksXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ3Nob3VsZCB0aHJvdyBleGNlcHRpb24gaWYgY29uZmlnIGRpciBjb250YWluIGludmFsaWQgamF2YXNjcmlwdCBmaWxlJywgKCkgPT4ge1xuICAgIC8vIGNyZWF0ZSBmaWxlXG4gICAgY29uc3QgaW52YWxpZEZpbGVQYXRoID0gcGF0aC5qb2luKHRlc3RDb25maWdEaXIsICdpbnZhbGlkLmpzJyk7XG4gICAgZnMud3JpdGVGaWxlU3luYyhpbnZhbGlkRmlsZVBhdGgsICdOb3QgYSBqYXZhc2NyaXB0IGZpbGUnKTtcbiAgICBleHBlY3QoKCkgPT4ge1xuICAgICAgbG9hZENvbmZpZ3ModGVzdENvbmZpZ0Rpcik7XG4gICAgfSkudG9UaHJvd0Vycm9yKCk7XG4gICAgZnMudW5saW5rU3luYyhpbnZhbGlkRmlsZVBhdGgpO1xuICB9KTtcblxuICB0ZXN0KCdTaG91bGQgbG9hZCBqc29uIGNvbmZpZyBmaWxlIGlmIGl0IGV4aXN0cycsICgpID0+IHtcbiAgICAvLyBjcmVhdGUgZmlsZVxuICAgIGNvbnN0IGpzb25Db25maWdGaWxlUGF0aCA9IHBhdGguam9pbih0ZXN0Q29uZmlnRGlyLCAnaGVsbG8uanNvbicpO1xuICAgIGNvbnN0IGhlbGxvQ29uZmlnID0geyBuYW1lOiAnd29ybGQnIH07XG4gICAgZnMud3JpdGVGaWxlU3luYyhqc29uQ29uZmlnRmlsZVBhdGgsIEpTT04uc3RyaW5naWZ5KGhlbGxvQ29uZmlnKSk7XG4gICAgY29uc3QgY29uZmlncyA9IGxvYWRDb25maWdzKHRlc3RDb25maWdEaXIpO1xuICAgIGV4cGVjdChjb25maWdzLmhlbGxvKS50b0VxdWFsKGhlbGxvQ29uZmlnKTtcbiAgICBmcy51bmxpbmtTeW5jKGpzb25Db25maWdGaWxlUGF0aCk7XG4gIH0pO1xuXG4gIHRlc3QoJ3Nob3VsZCB0aHJvdyBleGNlcHRpb24gaWYgY29uZmlnIGRpciBjb250YWluIGludmFsaWQganNvbiBmaWxlJywgKCkgPT4ge1xuICAgIC8vIGNyZWF0ZSBmaWxlXG4gICAgY29uc3QgaW52YWxpZEZpbGVQYXRoID0gcGF0aC5qb2luKHRlc3RDb25maWdEaXIsICdpbnZhbGlkLmpzb24nKTtcbiAgICBmcy53cml0ZUZpbGVTeW5jKGludmFsaWRGaWxlUGF0aCwgJ05vdCBhIGpzb24gZmlsZScpO1xuICAgIGV4cGVjdCgoKSA9PiB7XG4gICAgICBsb2FkQ29uZmlncyh0ZXN0Q29uZmlnRGlyKTtcbiAgICB9KS50b1Rocm93RXJyb3IoKTtcbiAgICBmcy51bmxpbmtTeW5jKGludmFsaWRGaWxlUGF0aCk7XG4gIH0pO1xuXG4gIHRlc3QoXCJzaG91bGRuJ3QgbG9hZCBlbXB0eSBjb25maWd1cmF0aW9uIGZvciBqc29uIC8ganMgZmlsZVwiLCAoKSA9PiB7XG4gICAgLy8gY3JlYXRlIGZpbGVcbiAgICBjb25zdCBpbnZhbGlkRmlsZVBhdGggPSBwYXRoLmpvaW4odGVzdENvbmZpZ0RpciwgJ2FueWZpbGUuZXh0Jyk7XG4gICAgZnMud3JpdGVGaWxlU3luYyhpbnZhbGlkRmlsZVBhdGgsICdOb3QgYSBqc29uIC8ganMgZmlsZScpO1xuICAgIGNvbnN0IGNvbmZpZ3MgPSBsb2FkQ29uZmlncyh0ZXN0Q29uZmlnRGlyKTtcbiAgICBleHBlY3QoT2JqZWN0LmtleXMoY29uZmlncy5hbnlmaWxlKS5sZW5ndGgpLnRvRXF1YWwoMCk7XG4gICAgZnMudW5saW5rU3luYyhpbnZhbGlkRmlsZVBhdGgpO1xuICB9KTtcblxuICB0ZXN0KCdzaG91bGQgbG9hZCBuZXN0ZWQganNvbiBjb25maWd1cmF0aW9uJywgKCkgPT4ge1xuICAgIC8vIGNyZWF0ZSBmaWxlXG4gICAgY29uc3QganNvbkNvbmZpZ0ZpbGVQYXRoID0gcGF0aC5qb2luKHRlc3RDb25maWdEaXIsICdoZWxsby5qc29uJyk7XG4gICAgY29uc3QgaGVsbG9Db25maWcgPSB7IG5hbWU6ICd3b3JsZCcsIHByb2ZpbGU6IHsgcGhvbmU6ICcwMTIzNDU2Nzg5JyB9IH07XG4gICAgZnMud3JpdGVGaWxlU3luYyhqc29uQ29uZmlnRmlsZVBhdGgsIEpTT04uc3RyaW5naWZ5KGhlbGxvQ29uZmlnKSk7XG4gICAgY29uc3QgY29uZmlncyA9IGxvYWRDb25maWdzKHRlc3RDb25maWdEaXIpO1xuICAgIGV4cGVjdChjb25maWdzLmhlbGxvKS50b0VxdWFsKGhlbGxvQ29uZmlnKTtcbiAgICBmcy51bmxpbmtTeW5jKGpzb25Db25maWdGaWxlUGF0aCk7XG4gIH0pO1xuXG4gIHRlc3QoJ3Nob3VsZCBsb2FkIGpzb24gY29uZmlndXJhdGlvbiB3aXRoIGV4cHJlc3Npb24gaW5zaWRlIHZhbHVlJywgKCkgPT4ge1xuICAgIC8vIGNyZWF0ZSBmaWxlXG4gICAgY29uc3QganNvbkNvbmZpZ0ZpbGVQYXRoID0gcGF0aC5qb2luKHRlc3RDb25maWdEaXIsICdoZWxsby5qc29uJyk7XG4gICAgY29uc3QgaGVsbG9Db25maWcgPSB7XG4gICAgICBmaXJzdE5hbWU6ICd3b3JsZCcsXG4gICAgICBsYXN0TmFtZTogJ2hlbGxvJyxcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby10ZW1wbGF0ZS1jdXJseS1pbi1zdHJpbmdcbiAgICAgIGZ1bGxOYW1lOiBcIiR7YWNjLmZpcnN0TmFtZSArICcgJyArIGFjYy5sYXN0TmFtZX1cIixcbiAgICB9O1xuICAgIGZzLndyaXRlRmlsZVN5bmMoanNvbkNvbmZpZ0ZpbGVQYXRoLCBKU09OLnN0cmluZ2lmeShoZWxsb0NvbmZpZykpO1xuICAgIGNvbnN0IGNvbmZpZ3MgPSBsb2FkQ29uZmlncyh0ZXN0Q29uZmlnRGlyKTtcbiAgICBleHBlY3QoY29uZmlncy5oZWxsbykudG9FcXVhbCh7XG4gICAgICBmaXJzdE5hbWU6IGhlbGxvQ29uZmlnLmZpcnN0TmFtZSxcbiAgICAgIGxhc3ROYW1lOiBoZWxsb0NvbmZpZy5sYXN0TmFtZSxcbiAgICAgIGZ1bGxOYW1lOiBgJHtoZWxsb0NvbmZpZy5maXJzdE5hbWV9ICR7aGVsbG9Db25maWcubGFzdE5hbWV9YCxcbiAgICB9KTtcbiAgICBmcy51bmxpbmtTeW5jKGpzb25Db25maWdGaWxlUGF0aCk7XG4gIH0pO1xufSk7XG4iXX0=