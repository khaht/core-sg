d489a58345461c0fd5bb0c5be673379b
/**
 * The event hub is Social Gear App's event control center.
 */
const debug = require('debug')('app');

const _ = require('lodash');

const fetch = require('node-fetch');

const WorkerQueue = require('./worker-queue');

const defaultConfiguration = {
  defaultHeaders: {}
};

class WebhookRunner {
  constructor({
    eventHub,
    logger,
    configuration = {}
  }) {
    debug('Initialized webhook runer');
    this.eventHub = eventHub;
    this.logger = logger;
    this.webhooksMap = new Map();
    this.listeners = new Map();

    if (typeof configuration !== 'object') {
      throw new Error('Invalid configuration provided to the webhookRunner.\nCheck your server.json -> webhooks configuration');
    }

    this.config = _.merge(defaultConfiguration, configuration);
    this.queue = new WorkerQueue({
      logger,
      concurency: 5
    });
    this.queue.subscribe(this.executeListener.bind(this));
  }

  deleteListener(event) {
    debug(`Deleting listener for event '${event}'`);

    if (this.listeners.has(event)) {
      const fn = this.listeners.get(event);
      this.eventHub.off(event, fn);
      this.listeners.delete(event);
    }
  }

  createListener(event) {
    debug(`Creating listener for event '${event}'`);

    if (this.listeners.has(event)) {
      this.logger.error(`The webhook runner is already listening for the event '${event}'. Did you mean to call .register() ?`);
    }

    const listen = info => {
      this.queue.enqueue({
        event,
        info
      });
    };

    this.listeners.set(event, listen);
    this.eventHub.on(event, listen);
  }

  async executeListener({
    event,
    info
  }) {
    debug(`Executing webhook for event '${event}'`);
    const webhooks = this.webhooksMap.get(event) || [];
    const activeWebhooks = webhooks.filter(webhook => webhook.isEnabled === true);
    activeWebhooks.forEach(webhook => {
      this.run(webhook, event, info).then(() => this.logger.debug(`Executed webhook for event ${event}`)).catch(error => {
        this.logger.error('Error running webhook');
        this.logger.error(error);
      });
    });
  }

  run(webhook, event, info = {}) {
    const {
      url,
      headers
    } = webhook;
    return fetch(url, {
      method: 'post',
      body: JSON.stringify({
        event,
        created_at: new Date(),
        ...info
      }),
      headers: { ...this.config.defaultHeaders,
        ...headers,
        'X-App-Event': event,
        'Content-Type': 'application/json'
      },
      timeout: 10000
    }).then(async res => {
      if (res.ok) {
        return {
          statusCode: res.status
        };
      }

      return {
        statusCode: res.status,
        message: await res.text()
      };
    }).catch(err => ({
      statusCode: 500,
      message: err.message
    }));
  }

  add(webhook) {
    debug(`Registering webhook '${webhook.id}'`);
    const {
      events
    } = webhook;
    events.forEach(event => {
      if (this.webhooksMap.has(event)) {
        this.webhooksMap.get(event).push(webhook);
      } else {
        this.webhooksMap.set(event, [webhook]);
        this.createListener(event);
      }
    });
  }

  update(webhook) {
    debug(`Refreshing webhook '${webhook.id}'`);
    this.remove(webhook);
    this.add(webhook);
  }

  remove(webhook) {
    debug(`Unregistering webhook '${webhook.id}'`);
    this.webhooksMap.forEach((webhooks, event) => {
      const filteredWebhooks = webhooks.filter(value => value.id !== webhook.id); // Cleanup hanging listeners

      if (filteredWebhooks.length === 0) {
        this.webhooksMap.delete(event);
        this.deleteListener(event);
      } else {
        this.webhooksMap.set(event, filteredWebhooks);
      }
    });
  }

}
/**
 * Expose a factory function instead of the class
 */


module.exports = function createWebhookRunner(opts) {
  return new WebhookRunner(opts);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYmhvb2stcnVubmVyLmpzIl0sIm5hbWVzIjpbImRlYnVnIiwicmVxdWlyZSIsIl8iLCJmZXRjaCIsIldvcmtlclF1ZXVlIiwiZGVmYXVsdENvbmZpZ3VyYXRpb24iLCJkZWZhdWx0SGVhZGVycyIsIldlYmhvb2tSdW5uZXIiLCJjb25zdHJ1Y3RvciIsImV2ZW50SHViIiwibG9nZ2VyIiwiY29uZmlndXJhdGlvbiIsIndlYmhvb2tzTWFwIiwiTWFwIiwibGlzdGVuZXJzIiwiRXJyb3IiLCJjb25maWciLCJtZXJnZSIsInF1ZXVlIiwiY29uY3VyZW5jeSIsInN1YnNjcmliZSIsImV4ZWN1dGVMaXN0ZW5lciIsImJpbmQiLCJkZWxldGVMaXN0ZW5lciIsImV2ZW50IiwiaGFzIiwiZm4iLCJnZXQiLCJvZmYiLCJkZWxldGUiLCJjcmVhdGVMaXN0ZW5lciIsImVycm9yIiwibGlzdGVuIiwiaW5mbyIsImVucXVldWUiLCJzZXQiLCJvbiIsIndlYmhvb2tzIiwiYWN0aXZlV2ViaG9va3MiLCJmaWx0ZXIiLCJ3ZWJob29rIiwiaXNFbmFibGVkIiwiZm9yRWFjaCIsInJ1biIsInRoZW4iLCJjYXRjaCIsInVybCIsImhlYWRlcnMiLCJtZXRob2QiLCJib2R5IiwiSlNPTiIsInN0cmluZ2lmeSIsImNyZWF0ZWRfYXQiLCJEYXRlIiwidGltZW91dCIsInJlcyIsIm9rIiwic3RhdHVzQ29kZSIsInN0YXR1cyIsIm1lc3NhZ2UiLCJ0ZXh0IiwiZXJyIiwiYWRkIiwiaWQiLCJldmVudHMiLCJwdXNoIiwidXBkYXRlIiwicmVtb3ZlIiwiZmlsdGVyZWRXZWJob29rcyIsInZhbHVlIiwibGVuZ3RoIiwibW9kdWxlIiwiZXhwb3J0cyIsImNyZWF0ZVdlYmhvb2tSdW5uZXIiLCJvcHRzIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFFQSxNQUFNQSxLQUFLLEdBQUdDLE9BQU8sQ0FBQyxPQUFELENBQVAsQ0FBaUIsS0FBakIsQ0FBZDs7QUFDQSxNQUFNQyxDQUFDLEdB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QSxLQUFLLENBQUUsMEJBQXlCd0MsT0FBTyxDQUFDdUIsRUFBRyxHQUF0QyxDQUFMO0FBRUEsU0FBS25ELFdBQUwsQ0FBaUI4QixPQUFqQixDQUF5QixDQUFDTCxRQUFELEVBQVdiLEtBQVgsS0FBcUI7QUFDNUMsWUFBTTRDLGdCQUFnQixHQUFHL0IsUUFBUSxDQUFDRSxNQUFULENBQWlCOEIsS0FBRCxJQUFXQSxLQUFLLENBQUNOLEVBQU4sS0FBYXZCLE9BQU8sQ0FBQ3VCLEVBQWhELENBQXpCLENBRDRDLENBRzVDOztBQUNBLFVBQUlLLGdCQUFnQixDQUFDRSxNQUFqQixLQUE0QixDQUFoQyxFQUFtQztBQUNqQyxhQUFLMUQsV0FBTCxDQUFpQmlCLE1BQWpCLENBQXdCTCxLQUF4QjtBQUNBLGFBQUtELGNBQUwsQ0FBb0JDLEtBQXBCO0FBQ0QsT0FIRCxNQUdPO0FBQ0wsYUFBS1osV0FBTCxDQUFpQnVCLEdBQWpCLENBQXFCWCxLQUFyQixFQUE0QjRDLGdCQUE1QjtBQUNEO0FBQ0YsS0FWRDtBQVdEOztBQW5JaUI7QUFzSXBCO0FBQ0E7QUFDQTs7O0FBQ0FHLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQixTQUFTQyxtQkFBVCxDQUE2QkMsSUFBN0IsRUFBbUM7QUFDbEQsU0FBTyxJQUFJbkUsYUFBSixDQUFrQm1FLElBQWxCLENBQVA7QUFDRCxDQUZEIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBUaGUgZXZlbnQgaHViIGlzIFNvY2lhbCBHZWFyIEFwcCdzIGV2ZW50IGNvbnRyb2wgY2VudGVyLlxuICovXG5cbmNvbnN0IGRlYnVnID0gcmVxdWlyZSgnZGVidWcnKSgnYXBwJyk7XG5jb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG5jb25zdCBmZXRjaCA9IHJlcXVpcmUoJ25vZGUtZmV0Y2gnKTtcblxuY29uc3QgV29ya2VyUXVldWUgPSByZXF1aXJlKCcuL3dvcmtlci1xdWV1ZScpO1xuXG5jb25zdCBkZWZhdWx0Q29uZmlndXJhdGlvbiA9IHtcbiAgZGVmYXVsdEhlYWRlcnM6IHt9LFxufTtcblxuY2xhc3MgV2ViaG9va1J1bm5lciB7XG4gIGNvbnN0cnVjdG9yKHsgZXZlbnRIdWIsIGxvZ2dlciwgY29uZmlndXJhdGlvbiA9IHt9IH0pIHtcbiAgICBkZWJ1ZygnSW5pdGlhbGl6ZWQgd2ViaG9vayBydW5lcicpO1xuICAgIHRoaXMuZXZlbnRIdWIgPSBldmVudEh1YjtcbiAgICB0aGlzLmxvZ2dlciA9IGxvZ2dlcjtcbiAgICB0aGlzLndlYmhvb2tzTWFwID0gbmV3IE1hcCgpO1xuICAgIHRoaXMubGlzdGVuZXJzID0gbmV3IE1hcCgpO1xuXG4gICAgaWYgKHR5cGVvZiBjb25maWd1cmF0aW9uICE9PSAnb2JqZWN0Jykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnSW52YWxpZCBjb25maWd1cmF0aW9uIHByb3ZpZGVkIHRvIHRoZSB3ZWJob29rUnVubmVyLlxcbkNoZWNrIHlvdXIgc2VydmVyLmpzb24gLT4gd2ViaG9va3MgY29uZmlndXJhdGlvbicsXG4gICAgICApO1xuICAgIH1cblxuICAgIHRoaXMuY29uZmlnID0gXy5tZXJnZShkZWZhdWx0Q29uZmlndXJhdGlvbiwgY29uZmlndXJhdGlvbik7XG5cbiAgICB0aGlzLnF1ZXVlID0gbmV3IFdvcmtlclF1ZXVlKHsgbG9nZ2VyLCBjb25jdXJlbmN5OiA1IH0pO1xuICAgIHRoaXMucXVldWUuc3Vic2NyaWJlKHRoaXMuZXhlY3V0ZUxpc3RlbmVyLmJpbmQodGhpcykpO1xuICB9XG5cbiAgZGVsZXRlTGlzdGVuZXIoZXZlbnQpIHtcbiAgICBkZWJ1ZyhgRGVsZXRpbmcgbGlzdGVuZXIgZm9yIGV2ZW50ICcke2V2ZW50fSdgKTtcbiAgICBpZiAodGhpcy5saXN0ZW5lcnMuaGFzKGV2ZW50KSkge1xuICAgICAgY29uc3QgZm4gPSB0aGlzLmxpc3RlbmVycy5nZXQoZXZlbnQpO1xuXG4gICAgICB0aGlzLmV2ZW50SHViLm9mZihldmVudCwgZm4pO1xuICAgICAgdGhpcy5saXN0ZW5lcnMuZGVsZXRlKGV2ZW50KTtcbiAgICB9XG4gIH1cblxuICBjcmVhdGVMaXN0ZW5lcihldmVudCkge1xuICAgIGRlYnVnKGBDcmVhdGluZyBsaXN0ZW5lciBmb3IgZXZlbnQgJyR7ZXZlbnR9J2ApO1xuICAgIGlmICh0aGlzLmxpc3RlbmVycy5oYXMoZXZlbnQpKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYFRoZSB3ZWJob29rIHJ1bm5lciBpcyBhbHJlYWR5IGxpc3RlbmluZyBmb3IgdGhlIGV2ZW50ICcke2V2ZW50fScuIERpZCB5b3UgbWVhbiB0byBjYWxsIC5yZWdpc3RlcigpID9gLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCBsaXN0ZW4gPSAoaW5mbykgPT4ge1xuICAgICAgdGhpcy5xdWV1ZS5lbnF1ZXVlKHsgZXZlbnQsIGluZm8gfSk7XG4gICAgfTtcblxuICAgIHRoaXMubGlzdGVuZXJzLnNldChldmVudCwgbGlzdGVuKTtcbiAgICB0aGlzLmV2ZW50SHViLm9uKGV2ZW50LCBsaXN0ZW4pO1xuICB9XG5cbiAgYXN5bmMgZXhlY3V0ZUxpc3RlbmVyKHsgZXZlbnQsIGluZm8gfSkge1xuICAgIGRlYnVnKGBFeGVjdXRpbmcgd2ViaG9vayBmb3IgZXZlbnQgJyR7ZXZlbnR9J2ApO1xuICAgIGNvbnN0IHdlYmhvb2tzID0gdGhpcy53ZWJob29rc01hcC5nZXQoZXZlbnQpIHx8IFtdO1xuICAgIGNvbnN0IGFjdGl2ZVdlYmhvb2tzID0gd2ViaG9va3MuZmlsdGVyKCh3ZWJob29rKSA9PiB3ZWJob29rLmlzRW5hYmxlZCA9PT0gdHJ1ZSk7XG5cbiAgICBhY3RpdmVXZWJob29rcy5mb3JFYWNoKCh3ZWJob29rKSA9PiB7XG4gICAgICB0aGlzLnJ1bih3ZWJob29rLCBldmVudCwgaW5mbylcbiAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5sb2dnZXIuZGVidWcoYEV4ZWN1dGVkIHdlYmhvb2sgZm9yIGV2ZW50ICR7ZXZlbnR9YCkpXG4gICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHtcbiAgICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcignRXJyb3IgcnVubmluZyB3ZWJob29rJyk7XG4gICAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoZXJyb3IpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHJ1bih3ZWJob29rLCBldmVudCwgaW5mbyA9IHt9KSB7XG4gICAgY29uc3QgeyB1cmwsIGhlYWRlcnMgfSA9IHdlYmhvb2s7XG5cbiAgICByZXR1cm4gZmV0Y2godXJsLCB7XG4gICAgICBtZXRob2Q6ICdwb3N0JyxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgZXZlbnQsXG4gICAgICAgIGNyZWF0ZWRfYXQ6IG5ldyBEYXRlKCksXG4gICAgICAgIC4uLmluZm8sXG4gICAgICB9KSxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgLi4udGhpcy5jb25maWcuZGVmYXVsdEhlYWRlcnMsXG4gICAgICAgIC4uLmhlYWRlcnMsXG4gICAgICAgICdYLUFwcC1FdmVudCc6IGV2ZW50LFxuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgfSxcbiAgICAgIHRpbWVvdXQ6IDEwMDAwLFxuICAgIH0pXG4gICAgICAudGhlbihhc3luYyAocmVzKSA9PiB7XG4gICAgICAgIGlmIChyZXMub2spIHtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgc3RhdHVzQ29kZTogcmVzLnN0YXR1cyxcbiAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdGF0dXNDb2RlOiByZXMuc3RhdHVzLFxuICAgICAgICAgIG1lc3NhZ2U6IGF3YWl0IHJlcy50ZXh0KCksXG4gICAgICAgIH07XG4gICAgICB9KVxuICAgICAgLmNhdGNoKChlcnIpID0+ICh7XG4gICAgICAgIHN0YXR1c0NvZGU6IDUwMCxcbiAgICAgICAgbWVzc2FnZTogZXJyLm1lc3NhZ2UsXG4gICAgICB9KSk7XG4gIH1cblxuICBhZGQod2ViaG9vaykge1xuICAgIGRlYnVnKGBSZWdpc3RlcmluZyB3ZWJob29rICcke3dlYmhvb2suaWR9J2ApO1xuICAgIGNvbnN0IHsgZXZlbnRzIH0gPSB3ZWJob29rO1xuXG4gICAgZXZlbnRzLmZvckVhY2goKGV2ZW50KSA9PiB7XG4gICAgICBpZiAodGhpcy53ZWJob29rc01hcC5oYXMoZXZlbnQpKSB7XG4gICAgICAgIHRoaXMud2ViaG9va3NNYXAuZ2V0KGV2ZW50KS5wdXNoKHdlYmhvb2spO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy53ZWJob29rc01hcC5zZXQoZXZlbnQsIFt3ZWJob29rXSk7XG4gICAgICAgIHRoaXMuY3JlYXRlTGlzdGVuZXIoZXZlbnQpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgdXBkYXRlKHdlYmhvb2spIHtcbiAgICBkZWJ1ZyhgUmVmcmVzaGluZyB3ZWJob29rICcke3dlYmhvb2suaWR9J2ApO1xuICAgIHRoaXMucmVtb3ZlKHdlYmhvb2spO1xuICAgIHRoaXMuYWRkKHdlYmhvb2spO1xuICB9XG5cbiAgcmVtb3ZlKHdlYmhvb2spIHtcbiAgICBkZWJ1ZyhgVW5yZWdpc3RlcmluZyB3ZWJob29rICcke3dlYmhvb2suaWR9J2ApO1xuXG4gICAgdGhpcy53ZWJob29rc01hcC5mb3JFYWNoKCh3ZWJob29rcywgZXZlbnQpID0+IHtcbiAgICAgIGNvbnN0IGZpbHRlcmVkV2ViaG9va3MgPSB3ZWJob29rcy5maWx0ZXIoKHZhbHVlKSA9PiB2YWx1ZS5pZCAhPT0gd2ViaG9vay5pZCk7XG5cbiAgICAgIC8vIENsZWFudXAgaGFuZ2luZyBsaXN0ZW5lcnNcbiAgICAgIGlmIChmaWx0ZXJlZFdlYmhvb2tzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aGlzLndlYmhvb2tzTWFwLmRlbGV0ZShldmVudCk7XG4gICAgICAgIHRoaXMuZGVsZXRlTGlzdGVuZXIoZXZlbnQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy53ZWJob29rc01hcC5zZXQoZXZlbnQsIGZpbHRlcmVkV2ViaG9va3MpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG59XG5cbi8qKlxuICogRXhwb3NlIGEgZmFjdG9yeSBmdW5jdGlvbiBpbnN0ZWFkIG9mIHRoZSBjbGFzc1xuICovXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGNyZWF0ZVdlYmhvb2tSdW5uZXIob3B0cykge1xuICByZXR1cm4gbmV3IFdlYmhvb2tSdW5uZXIob3B0cyk7XG59O1xuIl19