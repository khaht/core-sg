bb1a274537c87d8b2d277c824d397f7f
const {
  uniq,
  difference,
  get,
  isUndefined,
  merge
} = require('lodash');

const requiredMiddlewares = [// 'responses',
'router', // 'logger',
'boom', 'cors' // 'cron',
// 'xframe',
// 'xss',
// 'public',
// 'favicon',
]; // eslint-disable-next-line func-names

module.exports = async function () {
  /** Utils */
  const middlewareConfig = this.config.middleware; // check if a middleware exists

  const middlewareExists = key => !isUndefined(this.middleware[key]); // check if a middleware is enabled


  const middlewareEnabled = key => requiredMiddlewares.includes(key) || get(middlewareConfig, ['settings', key, 'enabled'], false) === true; // list of enabled middlewares


  const enabledMiddlewares = Object.keys(this.middleware).filter(middlewareEnabled); // Method to initialize middlewares and emit an event.

  const initialize = middlewareKey => {
    if (this.middleware[middlewareKey].loaded === true) return;
    const module = this.middleware[middlewareKey].load; // eslint-disable-next-line consistent-return

    return new Promise((resolve, reject) => {
      const timeout = setTimeout(() => reject(new Error(`(middleware: ${middlewareKey}) is taking too long to load.`)), middlewareConfig.timeout || 1000);
      this.middleware[middlewareKey] = merge(this.middleware[middlewareKey], module);
      Promise.resolve().then(() => module.initialize()).then(() => {
        clearTimeout(timeout);
        this.middleware[middlewareKey].loaded = true;
        resolve();
      }) // eslint-disable-next-line consistent-return
      .catch(err => {
        clearTimeout(timeout);

        if (err) {
          return reject(err);
        }
      });
    });
  };
  /**
   * Run init functions
   */
  // Run beforeInitialize of every middleware

  /* eslint-disable */


  await Promise.all(enabledMiddlewares.map(key => {
    const {
      beforeInitialize
    } = this.middleware[key].load;

    if (typeof beforeInitialize === 'function') {
      return beforeInitialize();
    }
  }));
  /* eslint-disable */
  // run the initialization of an array of middlewares sequentially

  const initMiddlewaresSeq = async middlewareArr => {
    for (const key of uniq(middlewareArr)) {
      await initialize(key);
    }
  };

  const middlewaresBefore = get(middlewareConfig, 'load.before', []).filter(middlewareExists).filter(middlewareEnabled);
  const middlewaresAfter = get(middlewareConfig, 'load.after', []).filter(middlewareExists).filter(middlewareEnabled);
  const middlewaresOrder = get(middlewareConfig, 'load.order', []).filter(middlewareExists).filter(middlewareEnabled);
  const unspecifiedMiddlewares = difference(enabledMiddlewares, middlewaresBefore, middlewaresOrder, middlewaresAfter); // before

  await initMiddlewaresSeq(middlewaresBefore); // ordered // rest of middlewares

  await Promise.all([initMiddlewaresSeq(middlewaresOrder), Promise.all(unspecifiedMiddlewares.map(initialize))]); // after

  await initMiddlewaresSeq(middlewaresAfter);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbInVuaXEiLCJkaWZmZXJlbmNlIiwiZ2V0IiwiaXNVbmRlZmluZWQiLCJtZXJnZSIsInJlcXVpcmUiLCJyZXF1aXJlZE1pZGRsZXdhcmVzIiwibW9kdWxlIiwiZXhwb3J0cyIsIm1pZGRsZXdhcmVDb25maWciLCJjb25maWciLCJtaWRkbGV3YXJlIiwibWlkZGxld2FyZUV4aXN0cyIsImtleSIsIm1pZGRsZXdhcmVFbmFibGVkIiwiaW5jbHVkZXMiLCJlbmFibGVkTWlkZGxld2FyZXMiLCJPYmplY3QiLCJrZXlzIiwiZmlsdGVyIiwiaW5pdGlhbGl6ZSIsIm1pZGRsZXdhcmVLZXkiLCJsb2FkZWQiLCJsb2FkIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJ0aW1lb3V0Iiwic2V0VGltZW91dCIsIkVycm9yIiwidGhlbiIsImNsZWFyVGltZW91dCIsImNhdGNoIiwiZXJyIiwiYWxsIiwibWFwIiwiYmVmb3JlSW5pdGlhbGl6ZSIsImluaXRNaWRkbGV3YXJlc1NlcSIsIm1pZGRsZXdhcmVBcnIiLCJtaWRkbGV3YXJlc0JlZm9yZSIsIm1pZGRsZXdhcmVzQWZ0ZXIiLCJtaWRkbGV3YXJlc09yZGVyIiwidW5zcGVjaWZpZWRNaWRkbGV3YXJlcyJdLCJtYXBwaW5ncyI6IkFBQUEsTUFBTTtBQUNKQSxFQUFBQSxJQURJO0FBQ0VDLEVBQUFBLFVBREY7QUFDY0MsRUFBQUEsR0FEZDtBQUNtQkMsRUFBQUEsV0FEbkI7QUFDZ0NDLEVBQUFBO0FBRGhDLElBRUZDLE9BQU8sQ0FBQyxRQUFELENBRlg7O0FBSUEsTUFBTUMsbUJBQW1CLEdBQUcsQ0FDMUI7QUFDQSxRQUYwQixFQUcxQjtBQUNBLE1BSjBCLEVBSzFCLE1BTDBCLENBTTFCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFWMEIsQ0FBNUIsQyxDQWFBOztBQUNBQyxNQUFNLENBQUNDLE9BQVAsR0FBaUIsa0JBQWtCO0FBQ2pDO0FBQ0EsUUFBTUMsZ0JBQWdCLEdBQUcsS0FB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Z0IsQ0FBMUI7QUFJQSxRQUFNMEIsZ0JBQWdCLEdBQUd0QyxHQUFHLENBQUNPLGdCQUFELEVBQW1CLFlBQW5CLEVBQWlDLEVBQWpDLENBQUgsQ0FDdEJVLE1BRHNCLENBQ2ZQLGdCQURlLEVBRXRCTyxNQUZzQixDQUVmTCxpQkFGZSxDQUF6QjtBQUlBLFFBQU0yQixnQkFBZ0IsR0FBR3ZDLEdBQUcsQ0FBQ08sZ0JBQUQsRUFBbUIsWUFBbkIsRUFBaUMsRUFBakMsQ0FBSCxDQUN0QlUsTUFEc0IsQ0FDZlAsZ0JBRGUsRUFFdEJPLE1BRnNCLENBRWZMLGlCQUZlLENBQXpCO0FBSUEsUUFBTTRCLHNCQUFzQixHQUFHekMsVUFBVSxDQUFDZSxrQkFBRCxFQUFxQnVCLGlCQUFyQixFQUF3Q0UsZ0JBQXhDLEVBQTBERCxnQkFBMUQsQ0FBekMsQ0FqRmlDLENBbUZqQzs7QUFDQSxRQUFNSCxrQkFBa0IsQ0FBQ0UsaUJBQUQsQ0FBeEIsQ0FwRmlDLENBc0ZqQzs7QUFDQSxRQUFNZixPQUFPLENBQUNVLEdBQVIsQ0FBWSxDQUFDRyxrQkFBa0IsQ0FBQ0ksZ0JBQUQsQ0FBbkIsRUFBdUNqQixPQUFPLENBQUNVLEdBQVIsQ0FBWVEsc0JBQXNCLENBQUNQLEdBQXZCLENBQTJCZixVQUEzQixDQUFaLENBQXZDLENBQVosQ0FBTixDQXZGaUMsQ0F5RmpDOztBQUNBLFFBQU1pQixrQkFBa0IsQ0FBQ0csZ0JBQUQsQ0FBeEI7QUFDRCxDQTNGRCIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHtcbiAgdW5pcSwgZGlmZmVyZW5jZSwgZ2V0LCBpc1VuZGVmaW5lZCwgbWVyZ2UsXG59ID0gcmVxdWlyZSgnbG9kYXNoJyk7XG5cbmNvbnN0IHJlcXVpcmVkTWlkZGxld2FyZXMgPSBbXG4gIC8vICdyZXNwb25zZXMnLFxuICAncm91dGVyJyxcbiAgLy8gJ2xvZ2dlcicsXG4gICdib29tJyxcbiAgJ2NvcnMnLFxuICAvLyAnY3JvbicsXG4gIC8vICd4ZnJhbWUnLFxuICAvLyAneHNzJyxcbiAgLy8gJ3B1YmxpYycsXG4gIC8vICdmYXZpY29uJyxcbl07XG5cbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBmdW5jLW5hbWVzXG5tb2R1bGUuZXhwb3J0cyA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgLyoqIFV0aWxzICovXG4gIGNvbnN0IG1pZGRsZXdhcmVDb25maWcgPSB0aGlzLmNvbmZpZy5taWRkbGV3YXJlO1xuXG4gIC8vIGNoZWNrIGlmIGEgbWlkZGxld2FyZSBleGlzdHNcbiAgY29uc3QgbWlkZGxld2FyZUV4aXN0cyA9IChrZXkpID0+ICFpc1VuZGVmaW5lZCh0aGlzLm1pZGRsZXdhcmVba2V5XSk7XG5cbiAgLy8gY2hlY2sgaWYgYSBtaWRkbGV3YXJlIGlzIGVuYWJsZWRcbiAgY29uc3QgbWlkZGxld2FyZUVuYWJsZWQgPSAoa2V5KSA9PiByZXF1aXJlZE1pZGRsZXdhcmVzLmluY2x1ZGVzKGtleSkgfHwgZ2V0KG1pZGRsZXdhcmVDb25maWcsIFsnc2V0dGluZ3MnLCBrZXksICdlbmFibGVkJ10sIGZhbHNlKSA9PT0gdHJ1ZTtcblxuICAvLyBsaXN0IG9mIGVuYWJsZWQgbWlkZGxld2FyZXNcbiAgY29uc3QgZW5hYmxlZE1pZGRsZXdhcmVzID0gT2JqZWN0LmtleXModGhpcy5taWRkbGV3YXJlKS5maWx0ZXIobWlkZGxld2FyZUVuYWJsZWQpO1xuXG4gIC8vIE1ldGhvZCB0byBpbml0aWFsaXplIG1pZGRsZXdhcmVzIGFuZCBlbWl0IGFuIGV2ZW50LlxuICBjb25zdCBpbml0aWFsaXplID0gKG1pZGRsZXdhcmVLZXkpID0+IHtcbiAgICBpZiAodGhpcy5taWRkbGV3YXJlW21pZGRsZXdhcmVLZXldLmxvYWRlZCA9PT0gdHJ1ZSkgcmV0dXJuO1xuXG4gICAgY29uc3QgbW9kdWxlID0gdGhpcy5taWRkbGV3YXJlW21pZGRsZXdhcmVLZXldLmxvYWQ7XG5cbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgY29uc2lzdGVudC1yZXR1cm5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgdGltZW91dCA9IHNldFRpbWVvdXQoXG4gICAgICAgICgpID0+IHJlamVjdChuZXcgRXJyb3IoYChtaWRkbGV3YXJlOiAke21pZGRsZXdhcmVLZXl9KSBpcyB0YWtpbmcgdG9vIGxvbmcgdG8gbG9hZC5gKSksXG4gICAgICAgIG1pZGRsZXdhcmVDb25maWcudGltZW91dCB8fCAxMDAwLFxuICAgICAgKTtcblxuICAgICAgdGhpcy5taWRkbGV3YXJlW21pZGRsZXdhcmVLZXldID0gbWVyZ2UodGhpcy5taWRkbGV3YXJlW21pZGRsZXdhcmVLZXldLCBtb2R1bGUpO1xuXG4gICAgICBQcm9taXNlLnJlc29sdmUoKVxuICAgICAgICAudGhlbigoKSA9PiBtb2R1bGUuaW5pdGlhbGl6ZSgpKVxuICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpO1xuICAgICAgICAgIHRoaXMubWlkZGxld2FyZVttaWRkbGV3YXJlS2V5XS5sb2FkZWQgPSB0cnVlO1xuICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgfSlcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNvbnNpc3RlbnQtcmV0dXJuXG4gICAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpO1xuXG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgcmV0dXJuIHJlamVjdChlcnIpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSk7XG4gIH07XG5cbiAgLyoqXG4gICAqIFJ1biBpbml0IGZ1bmN0aW9uc1xuICAgKi9cblxuICAvLyBSdW4gYmVmb3JlSW5pdGlhbGl6ZSBvZiBldmVyeSBtaWRkbGV3YXJlXG4gIC8qIGVzbGludC1kaXNhYmxlICovXG4gIGF3YWl0IFByb21pc2UuYWxsKFxuICAgIGVuYWJsZWRNaWRkbGV3YXJlcy5tYXAoKGtleSkgPT4ge1xuICAgICAgY29uc3QgeyBiZWZvcmVJbml0aWFsaXplIH0gPSB0aGlzLm1pZGRsZXdhcmVba2V5XS5sb2FkO1xuICAgICAgaWYgKHR5cGVvZiBiZWZvcmVJbml0aWFsaXplID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIHJldHVybiBiZWZvcmVJbml0aWFsaXplKCk7XG4gICAgICB9XG4gICAgfSksXG4gICk7XG4gIC8qIGVzbGludC1kaXNhYmxlICovXG5cbiAgLy8gcnVuIHRoZSBpbml0aWFsaXphdGlvbiBvZiBhbiBhcnJheSBvZiBtaWRkbGV3YXJlcyBzZXF1ZW50aWFsbHlcbiAgY29uc3QgaW5pdE1pZGRsZXdhcmVzU2VxID0gYXN5bmMgKG1pZGRsZXdhcmVBcnIpID0+IHtcbiAgICBmb3IgKGNvbnN0IGtleSBvZiB1bmlxKG1pZGRsZXdhcmVBcnIpKSB7XG4gICAgICBhd2FpdCBpbml0aWFsaXplKGtleSk7XG4gICAgfVxuICB9O1xuXG4gIGNvbnN0IG1pZGRsZXdhcmVzQmVmb3JlID0gZ2V0KG1pZGRsZXdhcmVDb25maWcsICdsb2FkLmJlZm9yZScsIFtdKVxuICAgIC5maWx0ZXIobWlkZGxld2FyZUV4aXN0cylcbiAgICAuZmlsdGVyKG1pZGRsZXdhcmVFbmFibGVkKTtcblxuICBjb25zdCBtaWRkbGV3YXJlc0FmdGVyID0gZ2V0KG1pZGRsZXdhcmVDb25maWcsICdsb2FkLmFmdGVyJywgW10pXG4gICAgLmZpbHRlcihtaWRkbGV3YXJlRXhpc3RzKVxuICAgIC5maWx0ZXIobWlkZGxld2FyZUVuYWJsZWQpO1xuXG4gIGNvbnN0IG1pZGRsZXdhcmVzT3JkZXIgPSBnZXQobWlkZGxld2FyZUNvbmZpZywgJ2xvYWQub3JkZXInLCBbXSlcbiAgICAuZmlsdGVyKG1pZGRsZXdhcmVFeGlzdHMpXG4gICAgLmZpbHRlcihtaWRkbGV3YXJlRW5hYmxlZCk7XG5cbiAgY29uc3QgdW5zcGVjaWZpZWRNaWRkbGV3YXJlcyA9IGRpZmZlcmVuY2UoZW5hYmxlZE1pZGRsZXdhcmVzLCBtaWRkbGV3YXJlc0JlZm9yZSwgbWlkZGxld2FyZXNPcmRlciwgbWlkZGxld2FyZXNBZnRlcik7XG5cbiAgLy8gYmVmb3JlXG4gIGF3YWl0IGluaXRNaWRkbGV3YXJlc1NlcShtaWRkbGV3YXJlc0JlZm9yZSk7XG5cbiAgLy8gb3JkZXJlZCAvLyByZXN0IG9mIG1pZGRsZXdhcmVzXG4gIGF3YWl0IFByb21pc2UuYWxsKFtpbml0TWlkZGxld2FyZXNTZXEobWlkZGxld2FyZXNPcmRlciksIFByb21pc2UuYWxsKHVuc3BlY2lmaWVkTWlkZGxld2FyZXMubWFwKGluaXRpYWxpemUpKV0pO1xuXG4gIC8vIGFmdGVyXG4gIGF3YWl0IGluaXRNaWRkbGV3YXJlc1NlcShtaWRkbGV3YXJlc0FmdGVyKTtcbn07XG4iXX0=