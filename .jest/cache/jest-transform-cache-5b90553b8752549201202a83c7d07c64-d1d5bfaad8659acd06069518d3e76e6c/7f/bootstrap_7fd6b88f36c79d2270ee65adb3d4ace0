9ae1a6f1cfa30f0e9993609594fdf00b
/* eslint-disable no-param-reassign */
const _ = require('lodash');

const {
  getConfigUrls
} = require('./utils/config.util');

const getKind = obj => obj.kind || 'collectionType';

const pickSchema = model => {
  const schema = _.cloneDeep(_.pick(model, ['connection', 'collectionName', 'info', 'options', 'attributes']));

  schema.kind = getKind(model);
  return schema;
};

module.exports = sgApp => {
  // Set connections.
  sgApp.connections = {};
  const defaultConnection = sgApp.config.get('database.defaultConnection'); // Set current connections.

  sgApp.config.connections = sgApp.config.get('database.connections', {});
  sgApp.contentTypes = {};
  const apiModules = Object.keys(sgApp.api || []);
  sgApp.models = apiModules.reduce((acc, apiName) => {
    const api = sgApp.api[apiName];
    Object.keys(api.models || {}).forEach(modelName => {
      const model = sgApp.api[apiName].models[modelName];
      Object.assign(model, {
        __schema__: pickSchema(model),
        kind: getKind(model),
        modelType: 'contentType',
        uid: `application::${apiName}.${modelName}`,
        apiName,
        modelName,
        globalId: model.globalId || _.upperFirst(_.camelCase(modelName)),
        collectionName: model.collectionName || `${modelName}`.toLocaleLowerCase(),
        connection: model.connection || defaultConnection
      });
      sgApp.contentTypes[model.uid] = model; // TODO: Create core api (For example: Default route, controller, services)
      // const { service, controller } = createCoreApi({ model, api, sgApp });
      // _.set(sgApp.api[apiName], ['services', modelName], service);
      // _.set(sgApp.api[apiName], ['controllers', modelName], controller);

      acc[modelName] = model;
    });
    return acc;
  }, {}); // Set controllers.

  sgApp.controllers = apiModules.reduce((acc, key) => {
    Object.keys(sgApp.api[key].controllers || {}).forEach(index => {
      const controller = sgApp.api[key].controllers[index];
      controller.identity = controller.identity || _.upperFirst(index);
      acc[index] = controller;
    });
    return acc;
  }, {}); // Set services.

  sgApp.services = apiModules.reduce((acc, key) => {
    Object.keys(sgApp.api[key].services || {}).forEach(index => {
      acc[index] = sgApp.api[key].services[index];
    });
    return acc;
  }, {}); // Set routes.

  sgApp.config.routes = apiModules.reduce((acc, key) => acc.concat(_.get(sgApp.api[key], 'config.routes') || {}), []); // Preset config in alphabetical order.

  sgApp.config.middleware.settings = Object.keys(sgApp.middleware).reduce((acc, current) => {
    // Try to find the settings in the current environment, then in the main configurations.
    const currentSettings = _.merge(_.cloneDeep(_.get(sgApp.middleware[current], ['defaults', current], {})), sgApp.config.get(['middleware', 'settings', current], {}));

    acc[current] = !_.isObject(currentSettings) ? {} : currentSettings; // Ensure that enabled key exist by forcing to false.

    _.defaults(acc[current], {
      enabled: false
    });

    return acc;
  }, {}); // default settings

  sgApp.config.port = sgApp.config.get('server.port') || sgApp.config.port;
  sgApp.config.host = sgApp.config.get('server.host') || sgApp.config.host;
  const {
    serverUrl
  } = getConfigUrls(sgApp.config.get('server'));
  sgApp.config.server = sgApp.config.server || {};
  sgApp.config.server.url = serverUrl;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJvb3RzdHJhcC5qcyJdLCJuYW1lcyI6WyJfIiwicmVxdWlyZSIsImdldENvbmZpZ1VybHMiLCJnZXRLaW5kIiwib2JqIiwia2luZCIsInBpY2tTY2hlbWEiLCJtb2RlbCIsInNjaGVtYSIsImNsb25lRGVlcCIsInBpY2siLCJtb2R1bGUiLCJleHBvcnRzIiwic2dBcHAiLCJjb25uZWN0aW9ucyIsImRlZmF1bHRDb25uZWN0aW9uIiwiY29uZmlnIiwiZ2V0IiwiY29udGVudFR5cGVzIiwiYXBpTW9kdWxlcyIsIk9iamVjdCIsImtleXMiLCJhcGkiLCJtb2RlbHMiLCJyZWR1Y2UiLCJhY2MiLCJhcGlOYW1lIiwiZm9yRWFjaCIsIm1vZGVsTmFtZSIsImFzc2lnbiIsIl9fc2NoZW1hX18iLCJtb2RlbFR5cGUiLCJ1aWQiLCJnbG9iYWxJZCIsInVwcGVyRmlyc3QiLCJjYW1lbENhc2UiLCJjb2xsZWN0aW9uTmFtZSIsInRvTG9jYWxlTG93ZXJDYXNlIiwiY29ubmVjdGlvbiIsImNvbnRyb2xsZXJzIiwia2V5IiwiaW5kZXgiLCJjb250cm9sbGVyIiwiaWRlbnRpdHkiLCJzZXJ2aWNlcyIsInJvdXRlcyIsImNvbmNhdCIsIm1pZGRsZXdhcmUiLCJzZXR0aW5ncyIsImN1cnJlbnQiLCJjdXJyZW50U2V0dGluZ3MiLCJtZXJnZSIsImlzT2JqZWN0IiwiZGVmYXVsdHMiLCJlbmFibGVkIiwicG9ydCIsImhvc3QiLCJzZXJ2ZXJVcmwiLCJzZXJ2ZXIiLCJ1cmwiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0EsTUFBTUEsQ0FBQyxHQUFHQyxPQUFPLENBQUMsUUFBRCxDQUFqQjs7QUFFQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBb0JELE9BQU8sQ0FBQyxxQkFBRCxDQUFqQzs7QUFFQSxNQUFNRSxPQUFPLEdBQUlDLEdBQUQsSUFBU0EsR0FBRyxDQUFDQyxJQUFKLElBQVksZ0JBQXJDOztBQUVBLE1BQU1DLFVBQVUsR0FBSUMsS0FBRCxJQUFXO0FBQzVCLFFBQU1DLE1B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QUFDQTFDLEVBQUFBLEtBQUssQ0FBQ0csTUFBTixDQUFhd0MsSUFBYixHQUFvQjNDLEtBQUssQ0FBQ0csTUFBTixDQUFhQyxHQUFiLENBQWlCLGFBQWpCLEtBQW1DSixLQUFLLENBQUNHLE1BQU4sQ0FBYXdDLElBQXBFO0FBRUEsUUFBTTtBQUFFQyxJQUFBQTtBQUFGLE1BQWdCdkQsYUFBYSxDQUFDVyxLQUFLLENBQUNHLE1BQU4sQ0FBYUMsR0FBYixDQUFpQixRQUFqQixDQUFELENBQW5DO0FBRUFKLEVBQUFBLEtBQUssQ0FBQ0csTUFBTixDQUFhMEMsTUFBYixHQUFzQjdDLEtBQUssQ0FBQ0csTUFBTixDQUFhMEMsTUFBYixJQUF1QixFQUE3QztBQUNBN0MsRUFBQUEsS0FBSyxDQUFDRyxNQUFOLENBQWEwQyxNQUFiLENBQW9CQyxHQUFwQixHQUEwQkYsU0FBMUI7QUFDRCxDQW5HRCIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIG5vLXBhcmFtLXJlYXNzaWduICovXG5jb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG5cbmNvbnN0IHsgZ2V0Q29uZmlnVXJscyB9ID0gcmVxdWlyZSgnLi91dGlscy9jb25maWcudXRpbCcpO1xuXG5jb25zdCBnZXRLaW5kID0gKG9iaikgPT4gb2JqLmtpbmQgfHwgJ2NvbGxlY3Rpb25UeXBlJztcblxuY29uc3QgcGlja1NjaGVtYSA9IChtb2RlbCkgPT4ge1xuICBjb25zdCBzY2hlbWEgPSBfLmNsb25lRGVlcChcbiAgICBfLnBpY2sobW9kZWwsIFtcbiAgICAgICdjb25uZWN0aW9uJyxcbiAgICAgICdjb2xsZWN0aW9uTmFtZScsXG4gICAgICAnaW5mbycsXG4gICAgICAnb3B0aW9ucycsXG4gICAgICAnYXR0cmlidXRlcycsXG4gICAgXSlcbiAgKTtcblxuICBzY2hlbWEua2luZCA9IGdldEtpbmQobW9kZWwpO1xuICByZXR1cm4gc2NoZW1hO1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSAoc2dBcHApID0+IHtcbiAgLy8gU2V0IGNvbm5lY3Rpb25zLlxuICBzZ0FwcC5jb25uZWN0aW9ucyA9IHt9O1xuXG4gIGNvbnN0IGRlZmF1bHRDb25uZWN0aW9uID0gc2dBcHAuY29uZmlnLmdldCgnZGF0YWJhc2UuZGVmYXVsdENvbm5lY3Rpb24nKTtcblxuICAvLyBTZXQgY3VycmVudCBjb25uZWN0aW9ucy5cbiAgc2dBcHAuY29uZmlnLmNvbm5lY3Rpb25zID0gc2dBcHAuY29uZmlnLmdldCgnZGF0YWJhc2UuY29ubmVjdGlvbnMnLCB7fSk7XG5cbiAgc2dBcHAuY29udGVudFR5cGVzID0ge307XG5cbiAgY29uc3QgYXBpTW9kdWxlcyA9IE9iamVjdC5rZXlzKHNnQXBwLmFwaSB8fCBbXSk7XG5cbiAgc2dBcHAubW9kZWxzID0gYXBpTW9kdWxlcy5yZWR1Y2UoKGFjYywgYXBpTmFtZSkgPT4ge1xuICAgIGNvbnN0IGFwaSA9IHNnQXBwLmFwaVthcGlOYW1lXTtcblxuICAgIE9iamVjdC5rZXlzKGFwaS5tb2RlbHMgfHwge30pLmZvckVhY2goKG1vZGVsTmFtZSkgPT4ge1xuICAgICAgY29uc3QgbW9kZWwgPSBzZ0FwcC5hcGlbYXBpTmFtZV0ubW9kZWxzW21vZGVsTmFtZV07XG5cbiAgICAgIE9iamVjdC5hc3NpZ24obW9kZWwsIHtcbiAgICAgICAgX19zY2hlbWFfXzogcGlja1NjaGVtYShtb2RlbCksXG4gICAgICAgIGtpbmQ6IGdldEtpbmQobW9kZWwpLFxuICAgICAgICBtb2RlbFR5cGU6ICdjb250ZW50VHlwZScsXG4gICAgICAgIHVpZDogYGFwcGxpY2F0aW9uOjoke2FwaU5hbWV9LiR7bW9kZWxOYW1lfWAsXG4gICAgICAgIGFwaU5hbWUsXG4gICAgICAgIG1vZGVsTmFtZSxcbiAgICAgICAgZ2xvYmFsSWQ6IG1vZGVsLmdsb2JhbElkIHx8IF8udXBwZXJGaXJzdChfLmNhbWVsQ2FzZShtb2RlbE5hbWUpKSxcbiAgICAgICAgY29sbGVjdGlvbk5hbWU6XG4gICAgICAgICAgbW9kZWwuY29sbGVjdGlvbk5hbWUgfHwgYCR7bW9kZWxOYW1lfWAudG9Mb2NhbGVMb3dlckNhc2UoKSxcbiAgICAgICAgY29ubmVjdGlvbjogbW9kZWwuY29ubmVjdGlvbiB8fCBkZWZhdWx0Q29ubmVjdGlvbixcbiAgICAgIH0pO1xuXG4gICAgICBzZ0FwcC5jb250ZW50VHlwZXNbbW9kZWwudWlkXSA9IG1vZGVsO1xuXG4gICAgICAvLyBUT0RPOiBDcmVhdGUgY29yZSBhcGkgKEZvciBleGFtcGxlOiBEZWZhdWx0IHJvdXRlLCBjb250cm9sbGVyLCBzZXJ2aWNlcylcbiAgICAgIC8vIGNvbnN0IHsgc2VydmljZSwgY29udHJvbGxlciB9ID0gY3JlYXRlQ29yZUFwaSh7IG1vZGVsLCBhcGksIHNnQXBwIH0pO1xuXG4gICAgICAvLyBfLnNldChzZ0FwcC5hcGlbYXBpTmFtZV0sIFsnc2VydmljZXMnLCBtb2RlbE5hbWVdLCBzZXJ2aWNlKTtcbiAgICAgIC8vIF8uc2V0KHNnQXBwLmFwaVthcGlOYW1lXSwgWydjb250cm9sbGVycycsIG1vZGVsTmFtZV0sIGNvbnRyb2xsZXIpO1xuXG4gICAgICBhY2NbbW9kZWxOYW1lXSA9IG1vZGVsO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIGFjYztcbiAgfSwge30pO1xuXG4gIC8vIFNldCBjb250cm9sbGVycy5cbiAgc2dBcHAuY29udHJvbGxlcnMgPSBhcGlNb2R1bGVzLnJlZHVjZSgoYWNjLCBrZXkpID0+IHtcbiAgICBPYmplY3Qua2V5cyhzZ0FwcC5hcGlba2V5XS5jb250cm9sbGVycyB8fCB7fSkuZm9yRWFjaCgoaW5kZXgpID0+IHtcbiAgICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBzZ0FwcC5hcGlba2V5XS5jb250cm9sbGVyc1tpbmRleF07XG4gICAgICBjb250cm9sbGVyLmlkZW50aXR5ID0gY29udHJvbGxlci5pZGVudGl0eSB8fCBfLnVwcGVyRmlyc3QoaW5kZXgpO1xuICAgICAgYWNjW2luZGV4XSA9IGNvbnRyb2xsZXI7XG4gICAgfSk7XG4gICAgcmV0dXJuIGFjYztcbiAgfSwge30pO1xuXG4gIC8vIFNldCBzZXJ2aWNlcy5cbiAgc2dBcHAuc2VydmljZXMgPSBhcGlNb2R1bGVzLnJlZHVjZSgoYWNjLCBrZXkpID0+IHtcbiAgICBPYmplY3Qua2V5cyhzZ0FwcC5hcGlba2V5XS5zZXJ2aWNlcyB8fCB7fSkuZm9yRWFjaCgoaW5kZXgpID0+IHtcbiAgICAgIGFjY1tpbmRleF0gPSBzZ0FwcC5hcGlba2V5XS5zZXJ2aWNlc1tpbmRleF07XG4gICAgfSk7XG4gICAgcmV0dXJuIGFjYztcbiAgfSwge30pO1xuXG4gIC8vIFNldCByb3V0ZXMuXG4gIHNnQXBwLmNvbmZpZy5yb3V0ZXMgPSBhcGlNb2R1bGVzLnJlZHVjZShcbiAgICAoYWNjLCBrZXkpID0+IGFjYy5jb25jYXQoXy5nZXQoc2dBcHAuYXBpW2tleV0sICdjb25maWcucm91dGVzJykgfHwge30pLFxuICAgIFtdXG4gICk7XG5cbiAgLy8gUHJlc2V0IGNvbmZpZyBpbiBhbHBoYWJldGljYWwgb3JkZXIuXG4gIHNnQXBwLmNvbmZpZy5taWRkbGV3YXJlLnNldHRpbmdzID0gT2JqZWN0LmtleXMoc2dBcHAubWlkZGxld2FyZSkucmVkdWNlKFxuICAgIChhY2MsIGN1cnJlbnQpID0+IHtcbiAgICAgIC8vIFRyeSB0byBmaW5kIHRoZSBzZXR0aW5ncyBpbiB0aGUgY3VycmVudCBlbnZpcm9ubWVudCwgdGhlbiBpbiB0aGUgbWFpbiBjb25maWd1cmF0aW9ucy5cbiAgICAgIGNvbnN0IGN1cnJlbnRTZXR0aW5ncyA9IF8ubWVyZ2UoXG4gICAgICAgIF8uY2xvbmVEZWVwKFxuICAgICAgICAgIF8uZ2V0KHNnQXBwLm1pZGRsZXdhcmVbY3VycmVudF0sIFsnZGVmYXVsdHMnLCBjdXJyZW50XSwge30pXG4gICAgICAgICksXG4gICAgICAgIHNnQXBwLmNvbmZpZy5nZXQoWydtaWRkbGV3YXJlJywgJ3NldHRpbmdzJywgY3VycmVudF0sIHt9KVxuICAgICAgKTtcblxuICAgICAgYWNjW2N1cnJlbnRdID0gIV8uaXNPYmplY3QoY3VycmVudFNldHRpbmdzKSA/IHt9IDogY3VycmVudFNldHRpbmdzO1xuXG4gICAgICAvLyBFbnN1cmUgdGhhdCBlbmFibGVkIGtleSBleGlzdCBieSBmb3JjaW5nIHRvIGZhbHNlLlxuICAgICAgXy5kZWZhdWx0cyhhY2NbY3VycmVudF0sIHsgZW5hYmxlZDogZmFsc2UgfSk7XG5cbiAgICAgIHJldHVybiBhY2M7XG4gICAgfSxcbiAgICB7fVxuICApO1xuXG4gIC8vIGRlZmF1bHQgc2V0dGluZ3NcbiAgc2dBcHAuY29uZmlnLnBvcnQgPSBzZ0FwcC5jb25maWcuZ2V0KCdzZXJ2ZXIucG9ydCcpIHx8IHNnQXBwLmNvbmZpZy5wb3J0O1xuICBzZ0FwcC5jb25maWcuaG9zdCA9IHNnQXBwLmNvbmZpZy5nZXQoJ3NlcnZlci5ob3N0JykgfHwgc2dBcHAuY29uZmlnLmhvc3Q7XG5cbiAgY29uc3QgeyBzZXJ2ZXJVcmwgfSA9IGdldENvbmZpZ1VybHMoc2dBcHAuY29uZmlnLmdldCgnc2VydmVyJykpO1xuXG4gIHNnQXBwLmNvbmZpZy5zZXJ2ZXIgPSBzZ0FwcC5jb25maWcuc2VydmVyIHx8IHt9O1xuICBzZ0FwcC5jb25maWcuc2VydmVyLnVybCA9IHNlcnZlclVybDtcbn07XG4iXX0=