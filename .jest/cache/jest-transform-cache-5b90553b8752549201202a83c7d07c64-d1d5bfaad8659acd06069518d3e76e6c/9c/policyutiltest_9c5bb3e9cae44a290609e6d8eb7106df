64129748a04194d6f151aa407ddce356
const {
  get,
  createPolicyFactory
} = require('../policy.util');

const logger = require('../logger.util');

const createApp = require('../../App');

const initialize = async () => {
  // Create new app instance
  // const appInstance = createApp();
  // // start instance
  // await appInstance.start().then(() => logger.info('App started'));
  // console.log('app>> ', appInstance);
  // return appInstance;
  return Promise.resolve();
};

describe('Policy util', () => {
  // let app;
  // beforeAll(async () => {
  //   console.log('Haha');
  //   app = await initialize();
  //   console.log('app>>> ', app.api);
  // });
  // afterAll(async () => {
  //   app.server.destroy();
  // });
  const validator = jest.fn();
  global.sgApp = {
    config: {
      policies: {
        validator
      }
    },
    api: {
      auth: {
        controllers: {
          auth: [Object],
          'authenticated-user': [Object]
        },
        services: {
          auth: [Object],
          passport: [Object],
          token: [Object]
        },
        validators: {
          auth: [Object],
          user: [Object]
        },
        config: {
          routes: [Array],
          __filename__: 'routes.json'
        }
      },
      home: {
        controllers: {
          home: [Object]
        },
        services: {
          home: [Object]
        },
        config: {
          routes: [Array],
          __filename__: 'routes.json'
        }
      },
      user: {
        models: {
          user: [Object]
        },
        services: {
          user: [Object]
        }
      }
    } // policies: {
    //   isauthenticated: [Function(anonymous)],
    //   validator: [AsyncFunction(anonymous)],
    // },

  };
  describe('Get policy', () => {
    test('should get policy', () => {
      const policy = 'global::validator';
      const apiName = 'auth';
      const resp = get(policy, apiName);
      expect(resp).toEqual(validator);
    });
    test('should throw error when could not find application policy', () => {
      const policy = 'application::validator';
      const apiName = 'auth';
      expect(() => get(policy, apiName)).toThrow();
    });
    test('should throw error when could not find admin policy', () => {
      const policy = 'admin::validator';
      const apiName = 'auth';
      expect(() => get(policy, apiName)).toThrow();
    });
    test('should throw error when could not find plugins policy', () => {
      const policy = 'plugins::validator';
      const apiName = 'auth';
      expect(() => get(policy, apiName)).toThrow();
    });
  });
  describe('Create policy factory', () => {
    test('Should create policy factory', () => {
      const factoryCallback = jest.fn();
      const options = {
        validator: jest.fn(),
        name: 'home'
      };
      const args = [];
      createPolicyFactory(factoryCallback, options)(args);
      expect(options.validator).toHaveBeenCalledTimes(1);
      expect(factoryCallback).toHaveBeenCalledTimes(1);
    });
    test('Should throw error when create policy factory', () => {
      const factoryCallback = jest.fn();
      const options = {
        validator: 'home',
        name: 'home'
      };
      const args = [];
      expect(() => createPolicyFactory(factoryCallback, options)(args)).toThrow();
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBvbGljeS51dGlsLnRlc3QuanMiXSwibmFtZXMiOlsiZ2V0IiwiY3JlYXRlUG9saWN5RmFjdG9yeSIsInJlcXVpcmUiLCJsb2dnZXIiLCJjcmVhdGVBcHAiLCJpbml0aWFsaXplIiwiUHJvbWlzZSIsInJlc29sdmUiLCJkZXNjcmliZSIsInZhbGlkYXRvciIsImplc3QiLCJmbiIsImdsb2JhbCIsInNnQXBwIiwiY29uZmlnIiwicG9saWNpZXMiLCJhcGkiLCJhdXRoIiwiY29udHJvbGxlcnMiLCJPYmplY3QiLCJzZXJ2aWNlcyIsInBhc3Nwb3J0IiwidG9rZW4iLCJ2YWxpZGF0b3JzIiwidXNlciIsInJvdXRlcyIsIkFycmF5IiwiX19maWxlbmFtZV9fIiwiaG9tZSIsIm1vZGVscyIsInRlc3QiLCJwb2xpY3kiLCJhcGlOYW1lIiwicmVzcCIsImV4cGVjdCIsInRvRXF1YWwiLCJ0b1Rocm93IiwiZmFjdG9yeUNhbGxiYWNrIiwib3B0aW9ucyIsIm5hbWUiLCJhcmdzIiwidG9IYXZlQmVlbkNhbGxlZFRpbWVzIl0sIm1hcHBpbmdzIjoiQUFBQSxNQUFNO0FBQUVBLEVBQUFBLEdBQUY7QUFBT0MsRUFBQUE7QUFBUCxJQUErQkMsT0FBTyxDQUFDLGdCQUFELENBQTVDOztBQUNBLE1BQU1DLE1BQU0sR0FBR0QsT0FBTyxDQUFDLGdCQUFELENBQXRCOztBQUNBLE1BQU1FLFNBQVMsR0FBR0YsT0FBTyxDQUFDLFdBQUQsQ0FBekI7O0FBRUEsTUFBTUcsVUFBVSxHQUFHLFlBQVk7QUFDN0I7QUFDQTtBQUVBO0FBQ0E7QUFFQTtBQUNBO0FBQ0EsU0FBT0MsT0FBTyxDQUFDQyxPQUFSLEVBQVA7QUFDRCxDQVZEOztBQVlBQyxRQUFRLENBQUMsYUFBRCxFQUFnQixNQUFNO0FBQzVCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUVBO0FBQ0E7QUFDQTtBQUVBLFFBQU1DLFNBQVMsR0FBR0MsSUFBSSxDQUFDQyxFQUFMLEVBQWxCO0FBRUFDLEVBQUFBLE1BQU0sQ0FB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ImNvbnN0IHsgZ2V0LCBjcmVhdGVQb2xpY3lGYWN0b3J5IH0gPSByZXF1aXJlKCcuLi9wb2xpY3kudXRpbCcpO1xuY29uc3QgbG9nZ2VyID0gcmVxdWlyZSgnLi4vbG9nZ2VyLnV0aWwnKTtcbmNvbnN0IGNyZWF0ZUFwcCA9IHJlcXVpcmUoJy4uLy4uL0FwcCcpO1xuXG5jb25zdCBpbml0aWFsaXplID0gYXN5bmMgKCkgPT4ge1xuICAvLyBDcmVhdGUgbmV3IGFwcCBpbnN0YW5jZVxuICAvLyBjb25zdCBhcHBJbnN0YW5jZSA9IGNyZWF0ZUFwcCgpO1xuXG4gIC8vIC8vIHN0YXJ0IGluc3RhbmNlXG4gIC8vIGF3YWl0IGFwcEluc3RhbmNlLnN0YXJ0KCkudGhlbigoKSA9PiBsb2dnZXIuaW5mbygnQXBwIHN0YXJ0ZWQnKSk7XG5cbiAgLy8gY29uc29sZS5sb2coJ2FwcD4+ICcsIGFwcEluc3RhbmNlKTtcbiAgLy8gcmV0dXJuIGFwcEluc3RhbmNlO1xuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG59O1xuXG5kZXNjcmliZSgnUG9saWN5IHV0aWwnLCAoKSA9PiB7XG4gIC8vIGxldCBhcHA7XG4gIC8vIGJlZm9yZUFsbChhc3luYyAoKSA9PiB7XG4gIC8vICAgY29uc29sZS5sb2coJ0hhaGEnKTtcbiAgLy8gICBhcHAgPSBhd2FpdCBpbml0aWFsaXplKCk7XG4gIC8vICAgY29uc29sZS5sb2coJ2FwcD4+PiAnLCBhcHAuYXBpKTtcbiAgLy8gfSk7XG5cbiAgLy8gYWZ0ZXJBbGwoYXN5bmMgKCkgPT4ge1xuICAvLyAgIGFwcC5zZXJ2ZXIuZGVzdHJveSgpO1xuICAvLyB9KTtcblxuICBjb25zdCB2YWxpZGF0b3IgPSBqZXN0LmZuKCk7XG5cbiAgZ2xvYmFsLnNnQXBwID0ge1xuICAgIGNvbmZpZzogeyBwb2xpY2llczogeyB2YWxpZGF0b3IgfSB9LFxuICAgIGFwaToge1xuICAgICAgYXV0aDoge1xuICAgICAgICBjb250cm9sbGVyczogeyBhdXRoOiBbT2JqZWN0XSwgJ2F1dGhlbnRpY2F0ZWQtdXNlcic6IFtPYmplY3RdIH0sXG4gICAgICAgIHNlcnZpY2VzOiB7IGF1dGg6IFtPYmplY3RdLCBwYXNzcG9ydDogW09iamVjdF0sIHRva2VuOiBbT2JqZWN0XSB9LFxuICAgICAgICB2YWxpZGF0b3JzOiB7IGF1dGg6IFtPYmplY3RdLCB1c2VyOiBbT2JqZWN0XSB9LFxuICAgICAgICBjb25maWc6IHsgcm91dGVzOiBbQXJyYXldLCBfX2ZpbGVuYW1lX186ICdyb3V0ZXMuanNvbicgfSxcbiAgICAgIH0sXG4gICAgICBob21lOiB7XG4gICAgICAgIGNvbnRyb2xsZXJzOiB7IGhvbWU6IFtPYmplY3RdIH0sXG4gICAgICAgIHNlcnZpY2VzOiB7IGhvbWU6IFtPYmplY3RdIH0sXG4gICAgICAgIGNvbmZpZzogeyByb3V0ZXM6IFtBcnJheV0sIF9fZmlsZW5hbWVfXzogJ3JvdXRlcy5qc29uJyB9LFxuICAgICAgfSxcbiAgICAgIHVzZXI6IHsgbW9kZWxzOiB7IHVzZXI6IFtPYmplY3RdIH0sIHNlcnZpY2VzOiB7IHVzZXI6IFtPYmplY3RdIH0gfSxcbiAgICB9LFxuICAgIC8vIHBvbGljaWVzOiB7XG4gICAgLy8gICBpc2F1dGhlbnRpY2F0ZWQ6IFtGdW5jdGlvbihhbm9ueW1vdXMpXSxcbiAgICAvLyAgIHZhbGlkYXRvcjogW0FzeW5jRnVuY3Rpb24oYW5vbnltb3VzKV0sXG4gICAgLy8gfSxcbiAgfTtcblxuICBkZXNjcmliZSgnR2V0IHBvbGljeScsICgpID0+IHtcbiAgICB0ZXN0KCdzaG91bGQgZ2V0IHBvbGljeScsICgpID0+IHtcbiAgICAgIGNvbnN0IHBvbGljeSA9ICdnbG9iYWw6OnZhbGlkYXRvcic7XG4gICAgICBjb25zdCBhcGlOYW1lID0gJ2F1dGgnO1xuICAgICAgY29uc3QgcmVzcCA9IGdldChwb2xpY3ksIGFwaU5hbWUpO1xuICAgICAgZXhwZWN0KHJlc3ApLnRvRXF1YWwodmFsaWRhdG9yKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ3Nob3VsZCB0aHJvdyBlcnJvciB3aGVuIGNvdWxkIG5vdCBmaW5kIGFwcGxpY2F0aW9uIHBvbGljeScsICgpID0+IHtcbiAgICAgIGNvbnN0IHBvbGljeSA9ICdhcHBsaWNhdGlvbjo6dmFsaWRhdG9yJztcbiAgICAgIGNvbnN0IGFwaU5hbWUgPSAnYXV0aCc7XG4gICAgICBleHBlY3QoKCkgPT4gZ2V0KHBvbGljeSwgYXBpTmFtZSkpLnRvVGhyb3coKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ3Nob3VsZCB0aHJvdyBlcnJvciB3aGVuIGNvdWxkIG5vdCBmaW5kIGFkbWluIHBvbGljeScsICgpID0+IHtcbiAgICAgIGNvbnN0IHBvbGljeSA9ICdhZG1pbjo6dmFsaWRhdG9yJztcbiAgICAgIGNvbnN0IGFwaU5hbWUgPSAnYXV0aCc7XG4gICAgICBleHBlY3QoKCkgPT4gZ2V0KHBvbGljeSwgYXBpTmFtZSkpLnRvVGhyb3coKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ3Nob3VsZCB0aHJvdyBlcnJvciB3aGVuIGNvdWxkIG5vdCBmaW5kIHBsdWdpbnMgcG9saWN5JywgKCkgPT4ge1xuICAgICAgY29uc3QgcG9saWN5ID0gJ3BsdWdpbnM6OnZhbGlkYXRvcic7XG4gICAgICBjb25zdCBhcGlOYW1lID0gJ2F1dGgnO1xuICAgICAgZXhwZWN0KCgpID0+IGdldChwb2xpY3ksIGFwaU5hbWUpKS50b1Rocm93KCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdDcmVhdGUgcG9saWN5IGZhY3RvcnknLCAoKSA9PiB7XG4gICAgdGVzdCgnU2hvdWxkIGNyZWF0ZSBwb2xpY3kgZmFjdG9yeScsICgpID0+IHtcbiAgICAgIGNvbnN0IGZhY3RvcnlDYWxsYmFjayA9IGplc3QuZm4oKTtcbiAgICAgIGNvbnN0IG9wdGlvbnMgPSB7IHZhbGlkYXRvcjogamVzdC5mbigpLCBuYW1lOiAnaG9tZScgfTtcbiAgICAgIGNvbnN0IGFyZ3MgPSBbXTtcbiAgICAgIGNyZWF0ZVBvbGljeUZhY3RvcnkoZmFjdG9yeUNhbGxiYWNrLCBvcHRpb25zKShhcmdzKTtcbiAgICAgIGV4cGVjdChvcHRpb25zLnZhbGlkYXRvcikudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgICAgZXhwZWN0KGZhY3RvcnlDYWxsYmFjaykudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnU2hvdWxkIHRocm93IGVycm9yIHdoZW4gY3JlYXRlIHBvbGljeSBmYWN0b3J5JywgKCkgPT4ge1xuICAgICAgY29uc3QgZmFjdG9yeUNhbGxiYWNrID0gamVzdC5mbigpO1xuICAgICAgY29uc3Qgb3B0aW9ucyA9IHsgdmFsaWRhdG9yOiAnaG9tZScsIG5hbWU6ICdob21lJyB9O1xuICAgICAgY29uc3QgYXJncyA9IFtdO1xuICAgICAgZXhwZWN0KCgpID0+XG4gICAgICAgIGNyZWF0ZVBvbGljeUZhY3RvcnkoZmFjdG9yeUNhbGxiYWNrLCBvcHRpb25zKShhcmdzKVxuICAgICAgKS50b1Rocm93KCk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXX0=