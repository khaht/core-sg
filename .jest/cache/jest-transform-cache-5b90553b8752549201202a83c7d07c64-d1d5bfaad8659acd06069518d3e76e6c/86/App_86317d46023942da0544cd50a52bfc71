270223a7cf9ad979eee8f6218f609373
/* eslint-disable no-console, consistent-return */
const _ = require('lodash');

const chalk = require('chalk');

const CLITable = require('cli-table3');

const express = require('express');

const http = require('http');

const errorHandler = require('errorhandler');

const bootstrap = require('./bootstrap');

const loadModules = require('./loader/modules.load');

const logger = require('./utils/logger.util');

const createFs = require('./utils/fs.util');

const {
  getAbsoluteServerUrl
} = require('./utils/config.util');

const loadConfiguration = require('./configs');

const createEventHub = require('./services/event-hub');

const initializeMiddlewares = require('./middlewares');

const createWebhookRunner = require('./services/webhook-runner');

const {
  createDatabaseManager
} = require('./database');

class App {
  constructor(options = {}) {
    this.app = express();
    this.router = new express.Router();
    this.initServer(); // Logger

    this.log = logger;
    this.dir = options.dir || process.cwd();
    this.admin = {};
    this.plugins = {};
    this.config = loadConfiguration(this.dir, options);
    this.isLoaded = false; // internal services.

    this.fs = createFs(this);
    this.eventHub = createEventHub();
  }

  initServer() {
    this.server = http.createServer(this.app); // handle port in use cleanly

    this.server.on('error', err => {
      if (err.code === 'EADDRINUSE') {
        return this.stopWithError(`The port ${err.port} is already used by another application.`);
      }

      return this.log.error(err);
    }); // Close current connections to fully destroy the server

    const connections = {};
    this.server.on('connection', conn => {
      const key = `${conn.remoteAddress}:${conn.remotePort}`;
      connections[key] = conn;
      conn.on('close', () => {
        delete connections[key];
      });
    });

    this.server.destroy = cb => {
      this.server.close(cb);
      const connKeys = Object.keys(connections);
      connKeys.forEach(key => {
        connections[key].destroy();
      });
    };
  }
  /**
   * Add behaviors to the server
   */


  async listen(cb) {
    const onListen = async err => {
      if (err) return this.stopWithError(err); // Should the startup message be displayed?

      const hideStartupMessage = process.env.HIDE_STARTUP_MESSAGE ? process.env.HIDE_STARTUP_MESSAGE === 'true' : false;

      if (hideStartupMessage === false) {
        this.logStartupMessage();
      }

      if (cb && typeof cb === 'function') {
        cb();
      }
    };

    const listenSocket = this.config.get('server.socket');

    const listenErrHandler = err => onListen(err).catch(err1 => this.stopWithError(err1));

    if (listenSocket) {
      this.server.listen(listenSocket, listenErrHandler);
    } else {
      this.server.listen(this.config.get('server.port'), this.config.get('server.host'), listenErrHandler);
    }
  }

  stopWithError(err, customMessage) {
    this.log.debug("â›”ï¸ Server wasn't able to start properly.");

    if (customMessage) {
      this.log.error(customMessage);
    }

    this.log.error(err);
    return this.stop();
  }

  stop(exitCode = 1) {
    // Destroy server and available connections.
    if (_.has(this, 'server.destroy')) {
      this.server.destroy();
    } // Kill process.


    process.exit(exitCode);
  }

  async start(cb) {
    try {
      if (!this.isLoaded) {
        await this.load();
      } // router


      const routePrefix = this.config.get('middleware.settings.router.prefix', '');
      this.app.use(routePrefix, this.router); // Launch server.

      this.listen(cb);
    } catch (err) {
      this.stopWithError(err);
    }
  }

  async destroy() {
    if (_.has(this, 'server.destroy')) {
      this.server.destroy();
    }

    await Promise.all(Object.values(this.plugins).map(plugin => {
      if (_.has(plugin, 'destroy') && typeof plugin.destroy === 'function') {
        return plugin.destroy();
      }

      return Promise.resolve();
    }));

    if (_.has(this, 'admin')) {
      await this.admin.destroy();
    }

    this.eventHub.removeAllListeners();

    if (_.has(this, 'db')) {
      await this.db.destroy();
    }

    delete global.app;
  } // eslint-disable-next-line class-methods-use-this


  async health(req, res, next) {
    req.meta = {};

    if (req.url === '/_health' && ['HEAD', 'GET'].includes(req.method)) {
      return res.status(204);
    }

    await next();
  }

  serverError(err, req, res) {
    this.log.error(err);
    res.status(500).send('Server Error');
  }

  async load() {
    this.app.use(async (req, res, next) => this.health(req, res, next));

    if (process.env.NODE_ENV === 'development') {
      // only use in development
      this.app.use(errorHandler());
    } else {
      this.app.use((err, _req, res) => this.serverError(err, _req, res));
    }

    const modules = await loadModules(this);
    this.api = modules.api;
    this.modules = modules.api;
    this.plugins = modules.plugins;
    this.middleware = modules.middlewares;
    await bootstrap(this); // init webhook runner

    this.webhookRunner = createWebhookRunner({
      eventHub: this.eventHub,
      logger: this.log,
      configuration: this.config.get('server.webhooks', {})
    }); // Init core store
    // this.models['core_store'] = coreStoreModel(this.config);
    // this.models['app_webhooks'] = webhookModel(this.config);

    this.db = createDatabaseManager(this);
    await this.db.initialize(); // this.store = createCoreStore({
    //   environment: this.config.environment,
    //   db: this.db,
    // });
    // this.entityValidator = entityValidator;
    // this.entityService = createEntityService({
    //   db: this.db,
    //   eventHub: this.eventHub,
    //   entityValidator: this.entityValidator,
    // });
    // this.telemetry = createTelemetry(this);

    await initializeMiddlewares.call(this);
    await this.runBootstrapFunctions();
    await this.freeze();
    this.isLoaded = true;
    return this;
  }

  logStats() {
    const columns = Math.min(process.stderr.columns, 80) - 2;
    console.log();
    console.log(chalk.black.bgWhite(_.padEnd(' Project information', columns)));
    console.log();
    const infoTable = new CLITable({
      colWidths: [20, 50],
      chars: {
        mid: '',
        'left-mid': '',
        'mid-mid': '',
        'right-mid': ''
      }
    });
    infoTable.push([chalk.blue('Time'), `${new Date()}`], [chalk.blue('Launched in'), `${Date.now() - this.config.launchedAt} ms`], [chalk.blue('Environment'), this.config.environment], [chalk.blue('Process PID'), process.pid] // [chalk.blue('Version'), `${this.config.info.app} (node ${process.version})`]
    );
    console.log(infoTable.toString());
    console.log();
    console.log(chalk.black.bgWhite(_.padEnd(' Actions available', columns)));
    console.log();
  }

  logStartupMessage() {
    this.logStats();
    console.log(chalk.bold('Welcome back!')); // if (this.config.serveAdminPanel === true) {
    //   console.log(chalk.grey('To manage your project ðŸš€, go to the administration panel at:'));
    //   const adminUrl = getAbsoluteAdminUrl(sgApp.config);
    //   console.log(chalk.bold(adminUrl));
    //   console.log();
    // }

    console.log(chalk.grey('To access the server âš¡ï¸, go to:'));
    const serverUrl = getAbsoluteServerUrl(this.config);
    console.log(chalk.bold(serverUrl));
    console.log();
  }

  async runBootstrapFunctions() {
    const execBootstrap = async fn => {
      if (!fn) return;
      return fn();
    }; // plugins bootstrap


    const pluginBoostraps = Object.keys(this.plugins).map(plugin => execBootstrap(_.get(this.plugins[plugin], 'config.functions.bootstrap')).catch(err => {
      sgApp.log.error(`Bootstrap function in plugin "${plugin}" failed`);
      sgApp.log.error(err);
      sgApp.stop();
    }));
    await Promise.all(pluginBoostraps); // user bootstrap

    await execBootstrap(_.get(this.config, ['functions', 'bootstrap']));
  }

  async freeze() {
    Object.freeze(this.config);
    Object.freeze(this.dir);
    Object.freeze(this.admin);
    Object.freeze(this.plugins);
    Object.freeze(this.api);
  }

  getModel(modelKey, plugin) {
    return this.db.getModel(modelKey, plugin);
  }
  /**
   * Binds queries with a specific model
   * @param {string} entity - entity name
   * @param {string} plugin - plugin name or null
   */


  query(entity, plugin) {
    return this.db.query(entity, plugin);
  }

}

module.exports = options => {
  const app = new App(options);
  global.sgApp = app; // sgApp stand for social gear App

  return app;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkFwcC5qcyJdLCJuYW1lcyI6WyJfIiwicmVxdWlyZSIsImNoYWxrIiwiQ0xJVGFibGUiLCJleHByZXNzIiwiaHR0cCIsImVycm9ySGFuZGxlciIsImJvb3RzdHJhcCIsImxvYWRNb2R1bGVzIiwibG9nZ2VyIiwiY3JlYXRlRnMiLCJnZXRBYnNvbHV0ZVNlcnZlclVybCIsImxvYWRDb25maWd1cmF0aW9uIiwiY3JlYXRlRXZlbnRIdWIiLCJpbml0aWFsaXplTWlkZGxld2FyZXMiLCJjcmVhdGVXZWJob29rUnVubmVyIiwiY3JlYXRlRGF0YWJhc2VNYW5hZ2VyIiwiQXBwIiwiY29uc3RydWN0b3IiLCJvcHRpb25zIiwiYXBwIiwicm91dGVyIiwiUm91dGVyIiwiaW5pdFNlcnZlciIsImxvZyIsImRpciIsInByb2Nlc3MiLCJjd2QiLCJhZG1pbiIsInBsdWdpbnMiLCJjb25maWciLCJpc0xvYWRlZCIsImZzIiwiZXZlbnRIdWIiLCJzZXJ2ZXIiLCJjcmVhdGVTZXJ2ZXIiLCJvbiIsImVyciIsImNvZGUiLCJzdG9wV2l0aEVycm9yIiwicG9ydCIsImVycm9yIiwiY29ubmVjdGlvbnMiLCJjb25uIiwia2V5IiwicmVtb3RlQWRkcmVzcyIsInJlbW90ZVBvcnQiLCJkZXN0cm95IiwiY2IiLCJjbG9zZSIsImNvbm5LZXlzIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJsaXN0ZW4iLCJvbkxpc3RlbiIsImhpZGVTdGFydHVwTWVzc2FnZSIsImVudiIsIkhJREVfU1RBUlRVUF9NRVNTQUdFIiwibG9nU3RhcnR1cE1lc3NhZ2UiLCJsaXN0ZW5Tb2NrZXQiLCJnZXQiLCJsaXN0ZW5FcnJIYW5kbGVyIiwiY2F0Y2giLCJlcnIxIiwiY3VzdG9tTWVzc2FnZSIsImRlYnVnIiwic3RvcCIsImV4aXRDb2RlIiwiaGFzIiwiZXhpdCIsInN0YXJ0IiwibG9hZCIsInJvdXRlUHJlZml4IiwidXNlIiwiUHJvbWlzZSIsImFsbCIsInZhbHVlcyIsIm1hcCIsInBsdWdpbiIsInJlc29sdmUiLCJyZW1vdmVBbGxMaXN0ZW5lcnMiLCJkYiIsImdsb2JhbCIsImhlYWx0aCIsInJlcSIsInJlcyIsIm5leHQiLCJtZXRhIiwidXJsIiwiaW5jbHVkZXMiLCJtZXRob2QiLCJzdGF0dXMiLCJzZXJ2ZXJFcnJvciIsInNlbmQiLCJOT0RFX0VOViIsIl9yZXEiLCJtb2R1bGVzIiwiYXBpIiwibWlkZGxld2FyZSIsIm1pZGRsZXdhcmVzIiwid2ViaG9va1J1bm5lciIsImNvbmZpZ3VyYXRpb24iLCJpbml0aWFsaXplIiwiY2FsbCIsInJ1bkJvb3RzdHJhcEZ1bmN0aW9ucyIsImZyZWV6ZSIsImxvZ1N0YXRzIiwiY29sdW1ucyIsIk1hdGgiLCJtaW4iLCJzdGRlcnIiLCJjb25zb2xlIiwiYmxhY2siLCJiZ1doaXRlIiwicGFkRW5kIiwiaW5mb1RhYmxlIiwiY29sV2lkdGhzIiwiY2hhcnMiLCJtaWQiLCJwdXNoIiwiYmx1ZSIsIkRhdGUiLCJub3ciLCJsYXVuY2hlZEF0IiwiZW52aXJvbm1lbnQiLCJwaWQiLCJ0b1N0cmluZyIsImJvbGQiLCJncmV5Iiwic2VydmVyVXJsIiwiZXhlY0Jvb3RzdHJhcCIsImZuIiwicGx1Z2luQm9vc3RyYXBzIiwic2dBcHAiLCJnZXRNb2RlbCIsIm1vZGVsS2V5IiwicXVlcnkiLCJlbnRpdHkiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBLE1BQU1BLENBQUMsR0FBR0MsT0FBTyxDQUFDLFFBQUQsQ0FBakI7O0FBQ0EsTUFBTUMsS0FBSyxHQUFHRCxPQUFPLENBQUMsT0FBRCxDQUFyQjs7QUFDQSxNQUFNRSxRQUFRLEdBQUdGLE9BQU8sQ0FBQyxZQUFELENBQXhCOztBQUNBLE1BQU1HLE9BQU8sR0FBR0gsT0FBTyxDQUFDLFNBQUQsQ0FBdkI7O0FBQ0EsTUFBTUksSUFBSSxHQUFHSixPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNSyxZQUFZLEdBQUdMLE9BQU8sQ0FBQyxjQUFELENBQTVCOztBQUVBLE1BQU1NLFNBQVMsR0FB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QUFNLENBQUN1RCxNQUFQLENBQWMsS0FBSzVFLE1BQW5CO0FBQ0FxQixJQUFBQSxNQUFNLENBQUN1RCxNQUFQLENBQWMsS0FBS2pGLEdBQW5CO0FBQ0EwQixJQUFBQSxNQUFNLENBQUN1RCxNQUFQLENBQWMsS0FBSzlFLEtBQW5CO0FBQ0F1QixJQUFBQSxNQUFNLENBQUN1RCxNQUFQLENBQWMsS0FBSzdFLE9BQW5CO0FBQ0FzQixJQUFBQSxNQUFNLENBQUN1RCxNQUFQLENBQWMsS0FBS1IsR0FBbkI7QUFDRDs7QUFFRHFDLEVBQUFBLFFBQVEsQ0FBQ0MsUUFBRCxFQUFXekQsTUFBWCxFQUFtQjtBQUN6QixXQUFPLEtBQUtHLEVBQUwsQ0FBUXFELFFBQVIsQ0FBaUJDLFFBQWpCLEVBQTJCekQsTUFBM0IsQ0FBUDtBQUNEO0FBRUQ7QUFDRjtBQUNBO0FBQ0E7QUFDQTs7O0FBQ0UwRCxFQUFBQSxLQUFLLENBQUNDLE1BQUQsRUFBUzNELE1BQVQsRUFBaUI7QUFDcEIsV0FBTyxLQUFLRyxFQUFMLENBQVF1RCxLQUFSLENBQWNDLE1BQWQsRUFBc0IzRCxNQUF0QixDQUFQO0FBQ0Q7O0FBbFVPOztBQXFVVjRELE1BQU0sQ0FBQ0MsT0FBUCxHQUFrQnpILE9BQUQsSUFBYTtBQUM1QixRQUFNQyxHQUFHLEdBQUcsSUFBSUgsR0FBSixDQUFRRSxPQUFSLENBQVo7QUFDQWdFLEVBQUFBLE1BQU0sQ0FBQ21ELEtBQVAsR0FBZWxILEdBQWYsQ0FGNEIsQ0FFUjs7QUFDcEIsU0FBT0EsR0FBUDtBQUNELENBSkQiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBuby1jb25zb2xlLCBjb25zaXN0ZW50LXJldHVybiAqL1xuY29uc3QgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xuY29uc3QgY2hhbGsgPSByZXF1aXJlKCdjaGFsaycpO1xuY29uc3QgQ0xJVGFibGUgPSByZXF1aXJlKCdjbGktdGFibGUzJyk7XG5jb25zdCBleHByZXNzID0gcmVxdWlyZSgnZXhwcmVzcycpO1xuY29uc3QgaHR0cCA9IHJlcXVpcmUoJ2h0dHAnKTtcbmNvbnN0IGVycm9ySGFuZGxlciA9IHJlcXVpcmUoJ2Vycm9yaGFuZGxlcicpO1xuXG5jb25zdCBib290c3RyYXAgPSByZXF1aXJlKCcuL2Jvb3RzdHJhcCcpO1xuY29uc3QgbG9hZE1vZHVsZXMgPSByZXF1aXJlKCcuL2xvYWRlci9tb2R1bGVzLmxvYWQnKTtcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoJy4vdXRpbHMvbG9nZ2VyLnV0aWwnKTtcbmNvbnN0IGNyZWF0ZUZzID0gcmVxdWlyZSgnLi91dGlscy9mcy51dGlsJyk7XG5jb25zdCB7IGdldEFic29sdXRlU2VydmVyVXJsIH0gPSByZXF1aXJlKCcuL3V0aWxzL2NvbmZpZy51dGlsJyk7XG5jb25zdCBsb2FkQ29uZmlndXJhdGlvbiA9IHJlcXVpcmUoJy4vY29uZmlncycpO1xuY29uc3QgY3JlYXRlRXZlbnRIdWIgPSByZXF1aXJlKCcuL3NlcnZpY2VzL2V2ZW50LWh1YicpO1xuY29uc3QgaW5pdGlhbGl6ZU1pZGRsZXdhcmVzID0gcmVxdWlyZSgnLi9taWRkbGV3YXJlcycpO1xuY29uc3QgY3JlYXRlV2ViaG9va1J1bm5lciA9IHJlcXVpcmUoJy4vc2VydmljZXMvd2ViaG9vay1ydW5uZXInKTtcbmNvbnN0IHsgY3JlYXRlRGF0YWJhc2VNYW5hZ2VyIH0gPSByZXF1aXJlKCcuL2RhdGFiYXNlJyk7XG5cbmNsYXNzIEFwcCB7XG4gIGNvbnN0cnVjdG9yKG9wdGlvbnMgPSB7fSkge1xuICAgIHRoaXMuYXBwID0gZXhwcmVzcygpO1xuICAgIHRoaXMucm91dGVyID0gbmV3IGV4cHJlc3MuUm91dGVyKCk7XG5cbiAgICB0aGlzLmluaXRTZXJ2ZXIoKTtcblxuICAgIC8vIExvZ2dlclxuICAgIHRoaXMubG9nID0gbG9nZ2VyO1xuXG4gICAgdGhpcy5kaXIgPSBvcHRpb25zLmRpciB8fCBwcm9jZXNzLmN3ZCgpO1xuXG4gICAgdGhpcy5hZG1pbiA9IHt9O1xuICAgIHRoaXMucGx1Z2lucyA9IHt9O1xuICAgIHRoaXMuY29uZmlnID0gbG9hZENvbmZpZ3VyYXRpb24odGhpcy5kaXIsIG9wdGlvbnMpO1xuXG4gICAgdGhpcy5pc0xvYWRlZCA9IGZhbHNlO1xuXG4gICAgLy8gaW50ZXJuYWwgc2VydmljZXMuXG4gICAgdGhpcy5mcyA9IGNyZWF0ZUZzKHRoaXMpO1xuICAgIHRoaXMuZXZlbnRIdWIgPSBjcmVhdGVFdmVudEh1YigpO1xuICB9XG5cbiAgaW5pdFNlcnZlcigpIHtcbiAgICB0aGlzLnNlcnZlciA9IGh0dHAuY3JlYXRlU2VydmVyKHRoaXMuYXBwKTtcbiAgICAvLyBoYW5kbGUgcG9ydCBpbiB1c2UgY2xlYW5seVxuICAgIHRoaXMuc2VydmVyLm9uKCdlcnJvcicsIChlcnIpID0+IHtcbiAgICAgIGlmIChlcnIuY29kZSA9PT0gJ0VBRERSSU5VU0UnKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0b3BXaXRoRXJyb3IoXG4gICAgICAgICAgYFRoZSBwb3J0ICR7ZXJyLnBvcnR9IGlzIGFscmVhZHkgdXNlZCBieSBhbm90aGVyIGFwcGxpY2F0aW9uLmBcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMubG9nLmVycm9yKGVycik7XG4gICAgfSk7XG5cbiAgICAvLyBDbG9zZSBjdXJyZW50IGNvbm5lY3Rpb25zIHRvIGZ1bGx5IGRlc3Ryb3kgdGhlIHNlcnZlclxuICAgIGNvbnN0IGNvbm5lY3Rpb25zID0ge307XG5cbiAgICB0aGlzLnNlcnZlci5vbignY29ubmVjdGlvbicsIChjb25uKSA9PiB7XG4gICAgICBjb25zdCBrZXkgPSBgJHtjb25uLnJlbW90ZUFkZHJlc3N9OiR7Y29ubi5yZW1vdGVQb3J0fWA7XG4gICAgICBjb25uZWN0aW9uc1trZXldID0gY29ubjtcblxuICAgICAgY29ubi5vbignY2xvc2UnLCAoKSA9PiB7XG4gICAgICAgIGRlbGV0ZSBjb25uZWN0aW9uc1trZXldO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICB0aGlzLnNlcnZlci5kZXN0cm95ID0gKGNiKSA9PiB7XG4gICAgICB0aGlzLnNlcnZlci5jbG9zZShjYik7XG5cbiAgICAgIGNvbnN0IGNvbm5LZXlzID0gT2JqZWN0LmtleXMoY29ubmVjdGlvbnMpO1xuICAgICAgY29ubktleXMuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICAgIGNvbm5lY3Rpb25zW2tleV0uZGVzdHJveSgpO1xuICAgICAgfSk7XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgYmVoYXZpb3JzIHRvIHRoZSBzZXJ2ZXJcbiAgICovXG4gIGFzeW5jIGxpc3RlbihjYikge1xuICAgIGNvbnN0IG9uTGlzdGVuID0gYXN5bmMgKGVycikgPT4ge1xuICAgICAgaWYgKGVycikgcmV0dXJuIHRoaXMuc3RvcFdpdGhFcnJvcihlcnIpO1xuXG4gICAgICAvLyBTaG91bGQgdGhlIHN0YXJ0dXAgbWVzc2FnZSBiZSBkaXNwbGF5ZWQ/XG4gICAgICBjb25zdCBoaWRlU3RhcnR1cE1lc3NhZ2UgPSBwcm9jZXNzLmVudi5ISURFX1NUQVJUVVBfTUVTU0FHRVxuICAgICAgICA/IHByb2Nlc3MuZW52LkhJREVfU1RBUlRVUF9NRVNTQUdFID09PSAndHJ1ZSdcbiAgICAgICAgOiBmYWxzZTtcblxuICAgICAgaWYgKGhpZGVTdGFydHVwTWVzc2FnZSA9PT0gZmFsc2UpIHtcbiAgICAgICAgdGhpcy5sb2dTdGFydHVwTWVzc2FnZSgpO1xuICAgICAgfVxuXG4gICAgICBpZiAoY2IgJiYgdHlwZW9mIGNiID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGNiKCk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIGNvbnN0IGxpc3RlblNvY2tldCA9IHRoaXMuY29uZmlnLmdldCgnc2VydmVyLnNvY2tldCcpO1xuICAgIGNvbnN0IGxpc3RlbkVyckhhbmRsZXIgPSAoZXJyKSA9PlxuICAgICAgb25MaXN0ZW4oZXJyKS5jYXRjaCgoZXJyMSkgPT4gdGhpcy5zdG9wV2l0aEVycm9yKGVycjEpKTtcblxuICAgIGlmIChsaXN0ZW5Tb2NrZXQpIHtcbiAgICAgIHRoaXMuc2VydmVyLmxpc3RlbihsaXN0ZW5Tb2NrZXQsIGxpc3RlbkVyckhhbmRsZXIpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNlcnZlci5saXN0ZW4oXG4gICAgICAgIHRoaXMuY29uZmlnLmdldCgnc2VydmVyLnBvcnQnKSxcbiAgICAgICAgdGhpcy5jb25maWcuZ2V0KCdzZXJ2ZXIuaG9zdCcpLFxuICAgICAgICBsaXN0ZW5FcnJIYW5kbGVyXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHN0b3BXaXRoRXJyb3IoZXJyLCBjdXN0b21NZXNzYWdlKSB7XG4gICAgdGhpcy5sb2cuZGVidWcoXCLim5TvuI8gU2VydmVyIHdhc24ndCBhYmxlIHRvIHN0YXJ0IHByb3Blcmx5LlwiKTtcbiAgICBpZiAoY3VzdG9tTWVzc2FnZSkge1xuICAgICAgdGhpcy5sb2cuZXJyb3IoY3VzdG9tTWVzc2FnZSk7XG4gICAgfVxuICAgIHRoaXMubG9nLmVycm9yKGVycik7XG4gICAgcmV0dXJuIHRoaXMuc3RvcCgpO1xuICB9XG5cbiAgc3RvcChleGl0Q29kZSA9IDEpIHtcbiAgICAvLyBEZXN0cm95IHNlcnZlciBhbmQgYXZhaWxhYmxlIGNvbm5lY3Rpb25zLlxuICAgIGlmIChfLmhhcyh0aGlzLCAnc2VydmVyLmRlc3Ryb3knKSkge1xuICAgICAgdGhpcy5zZXJ2ZXIuZGVzdHJveSgpO1xuICAgIH1cblxuICAgIC8vIEtpbGwgcHJvY2Vzcy5cbiAgICBwcm9jZXNzLmV4aXQoZXhpdENvZGUpO1xuICB9XG5cbiAgYXN5bmMgc3RhcnQoY2IpIHtcbiAgICB0cnkge1xuICAgICAgaWYgKCF0aGlzLmlzTG9hZGVkKSB7XG4gICAgICAgIGF3YWl0IHRoaXMubG9hZCgpO1xuICAgICAgfVxuXG4gICAgICAvLyByb3V0ZXJcbiAgICAgIGNvbnN0IHJvdXRlUHJlZml4ID0gdGhpcy5jb25maWcuZ2V0KFxuICAgICAgICAnbWlkZGxld2FyZS5zZXR0aW5ncy5yb3V0ZXIucHJlZml4JyxcbiAgICAgICAgJydcbiAgICAgICk7XG4gICAgICB0aGlzLmFwcC51c2Uocm91dGVQcmVmaXgsIHRoaXMucm91dGVyKTtcblxuICAgICAgLy8gTGF1bmNoIHNlcnZlci5cbiAgICAgIHRoaXMubGlzdGVuKGNiKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRoaXMuc3RvcFdpdGhFcnJvcihlcnIpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGRlc3Ryb3koKSB7XG4gICAgaWYgKF8uaGFzKHRoaXMsICdzZXJ2ZXIuZGVzdHJveScpKSB7XG4gICAgICB0aGlzLnNlcnZlci5kZXN0cm95KCk7XG4gICAgfVxuXG4gICAgYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICBPYmplY3QudmFsdWVzKHRoaXMucGx1Z2lucykubWFwKChwbHVnaW4pID0+IHtcbiAgICAgICAgaWYgKF8uaGFzKHBsdWdpbiwgJ2Rlc3Ryb3knKSAmJiB0eXBlb2YgcGx1Z2luLmRlc3Ryb3kgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICByZXR1cm4gcGx1Z2luLmRlc3Ryb3koKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICB9KVxuICAgICk7XG5cbiAgICBpZiAoXy5oYXModGhpcywgJ2FkbWluJykpIHtcbiAgICAgIGF3YWl0IHRoaXMuYWRtaW4uZGVzdHJveSgpO1xuICAgIH1cblxuICAgIHRoaXMuZXZlbnRIdWIucmVtb3ZlQWxsTGlzdGVuZXJzKCk7XG5cbiAgICBpZiAoXy5oYXModGhpcywgJ2RiJykpIHtcbiAgICAgIGF3YWl0IHRoaXMuZGIuZGVzdHJveSgpO1xuICAgIH1cblxuICAgIGRlbGV0ZSBnbG9iYWwuYXBwO1xuICB9XG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNsYXNzLW1ldGhvZHMtdXNlLXRoaXNcbiAgYXN5bmMgaGVhbHRoKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgcmVxLm1ldGEgPSB7fTtcbiAgICBpZiAocmVxLnVybCA9PT0gJy9faGVhbHRoJyAmJiBbJ0hFQUQnLCAnR0VUJ10uaW5jbHVkZXMocmVxLm1ldGhvZCkpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDIwNCk7XG4gICAgfVxuICAgIGF3YWl0IG5leHQoKTtcbiAgfVxuXG4gIHNlcnZlckVycm9yKGVyciwgcmVxLCByZXMpIHtcbiAgICB0aGlzLmxvZy5lcnJvcihlcnIpO1xuICAgIHJlcy5zdGF0dXMoNTAwKS5zZW5kKCdTZXJ2ZXIgRXJyb3InKTtcbiAgfVxuXG4gIGFzeW5jIGxvYWQoKSB7XG4gICAgdGhpcy5hcHAudXNlKGFzeW5jIChyZXEsIHJlcywgbmV4dCkgPT4gdGhpcy5oZWFsdGgocmVxLCByZXMsIG5leHQpKTtcblxuICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ2RldmVsb3BtZW50Jykge1xuICAgICAgLy8gb25seSB1c2UgaW4gZGV2ZWxvcG1lbnRcbiAgICAgIHRoaXMuYXBwLnVzZShlcnJvckhhbmRsZXIoKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYXBwLnVzZSgoZXJyLCBfcmVxLCByZXMpID0+IHRoaXMuc2VydmVyRXJyb3IoZXJyLCBfcmVxLCByZXMpKTtcbiAgICB9XG5cbiAgICBjb25zdCBtb2R1bGVzID0gYXdhaXQgbG9hZE1vZHVsZXModGhpcyk7XG5cbiAgICB0aGlzLmFwaSA9IG1vZHVsZXMuYXBpO1xuICAgIHRoaXMubW9kdWxlcyA9IG1vZHVsZXMuYXBpO1xuICAgIHRoaXMucGx1Z2lucyA9IG1vZHVsZXMucGx1Z2lucztcbiAgICB0aGlzLm1pZGRsZXdhcmUgPSBtb2R1bGVzLm1pZGRsZXdhcmVzO1xuXG4gICAgYXdhaXQgYm9vdHN0cmFwKHRoaXMpO1xuXG4gICAgLy8gaW5pdCB3ZWJob29rIHJ1bm5lclxuICAgIHRoaXMud2ViaG9va1J1bm5lciA9IGNyZWF0ZVdlYmhvb2tSdW5uZXIoe1xuICAgICAgZXZlbnRIdWI6IHRoaXMuZXZlbnRIdWIsXG4gICAgICBsb2dnZXI6IHRoaXMubG9nLFxuICAgICAgY29uZmlndXJhdGlvbjogdGhpcy5jb25maWcuZ2V0KCdzZXJ2ZXIud2ViaG9va3MnLCB7fSksXG4gICAgfSk7XG5cbiAgICAvLyBJbml0IGNvcmUgc3RvcmVcbiAgICAvLyB0aGlzLm1vZGVsc1snY29yZV9zdG9yZSddID0gY29yZVN0b3JlTW9kZWwodGhpcy5jb25maWcpO1xuICAgIC8vIHRoaXMubW9kZWxzWydhcHBfd2ViaG9va3MnXSA9IHdlYmhvb2tNb2RlbCh0aGlzLmNvbmZpZyk7XG5cbiAgICB0aGlzLmRiID0gY3JlYXRlRGF0YWJhc2VNYW5hZ2VyKHRoaXMpO1xuICAgIGF3YWl0IHRoaXMuZGIuaW5pdGlhbGl6ZSgpO1xuXG4gICAgLy8gdGhpcy5zdG9yZSA9IGNyZWF0ZUNvcmVTdG9yZSh7XG4gICAgLy8gICBlbnZpcm9ubWVudDogdGhpcy5jb25maWcuZW52aXJvbm1lbnQsXG4gICAgLy8gICBkYjogdGhpcy5kYixcbiAgICAvLyB9KTtcblxuICAgIC8vIHRoaXMuZW50aXR5VmFsaWRhdG9yID0gZW50aXR5VmFsaWRhdG9yO1xuXG4gICAgLy8gdGhpcy5lbnRpdHlTZXJ2aWNlID0gY3JlYXRlRW50aXR5U2VydmljZSh7XG4gICAgLy8gICBkYjogdGhpcy5kYixcbiAgICAvLyAgIGV2ZW50SHViOiB0aGlzLmV2ZW50SHViLFxuICAgIC8vICAgZW50aXR5VmFsaWRhdG9yOiB0aGlzLmVudGl0eVZhbGlkYXRvcixcbiAgICAvLyB9KTtcblxuICAgIC8vIHRoaXMudGVsZW1ldHJ5ID0gY3JlYXRlVGVsZW1ldHJ5KHRoaXMpO1xuXG4gICAgYXdhaXQgaW5pdGlhbGl6ZU1pZGRsZXdhcmVzLmNhbGwodGhpcyk7XG5cbiAgICBhd2FpdCB0aGlzLnJ1bkJvb3RzdHJhcEZ1bmN0aW9ucygpO1xuICAgIGF3YWl0IHRoaXMuZnJlZXplKCk7XG5cbiAgICB0aGlzLmlzTG9hZGVkID0gdHJ1ZTtcblxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgbG9nU3RhdHMoKSB7XG4gICAgY29uc3QgY29sdW1ucyA9IE1hdGgubWluKHByb2Nlc3Muc3RkZXJyLmNvbHVtbnMsIDgwKSAtIDI7XG4gICAgY29uc29sZS5sb2coKTtcbiAgICBjb25zb2xlLmxvZyhjaGFsay5ibGFjay5iZ1doaXRlKF8ucGFkRW5kKCcgUHJvamVjdCBpbmZvcm1hdGlvbicsIGNvbHVtbnMpKSk7XG4gICAgY29uc29sZS5sb2coKTtcblxuICAgIGNvbnN0IGluZm9UYWJsZSA9IG5ldyBDTElUYWJsZSh7XG4gICAgICBjb2xXaWR0aHM6IFsyMCwgNTBdLFxuICAgICAgY2hhcnM6IHtcbiAgICAgICAgbWlkOiAnJyxcbiAgICAgICAgJ2xlZnQtbWlkJzogJycsXG4gICAgICAgICdtaWQtbWlkJzogJycsXG4gICAgICAgICdyaWdodC1taWQnOiAnJyxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBpbmZvVGFibGUucHVzaChcbiAgICAgIFtjaGFsay5ibHVlKCdUaW1lJyksIGAke25ldyBEYXRlKCl9YF0sXG4gICAgICBbY2hhbGsuYmx1ZSgnTGF1bmNoZWQgaW4nKSwgYCR7RGF0ZS5ub3coKSAtIHRoaXMuY29uZmlnLmxhdW5jaGVkQXR9IG1zYF0sXG4gICAgICBbY2hhbGsuYmx1ZSgnRW52aXJvbm1lbnQnKSwgdGhpcy5jb25maWcuZW52aXJvbm1lbnRdLFxuICAgICAgW2NoYWxrLmJsdWUoJ1Byb2Nlc3MgUElEJyksIHByb2Nlc3MucGlkXVxuICAgICAgLy8gW2NoYWxrLmJsdWUoJ1ZlcnNpb24nKSwgYCR7dGhpcy5jb25maWcuaW5mby5hcHB9IChub2RlICR7cHJvY2Vzcy52ZXJzaW9ufSlgXVxuICAgICk7XG5cbiAgICBjb25zb2xlLmxvZyhpbmZvVGFibGUudG9TdHJpbmcoKSk7XG4gICAgY29uc29sZS5sb2coKTtcbiAgICBjb25zb2xlLmxvZyhjaGFsay5ibGFjay5iZ1doaXRlKF8ucGFkRW5kKCcgQWN0aW9ucyBhdmFpbGFibGUnLCBjb2x1bW5zKSkpO1xuICAgIGNvbnNvbGUubG9nKCk7XG4gIH1cblxuICBsb2dTdGFydHVwTWVzc2FnZSgpIHtcbiAgICB0aGlzLmxvZ1N0YXRzKCk7XG5cbiAgICBjb25zb2xlLmxvZyhjaGFsay5ib2xkKCdXZWxjb21lIGJhY2shJykpO1xuXG4gICAgLy8gaWYgKHRoaXMuY29uZmlnLnNlcnZlQWRtaW5QYW5lbCA9PT0gdHJ1ZSkge1xuICAgIC8vICAgY29uc29sZS5sb2coY2hhbGsuZ3JleSgnVG8gbWFuYWdlIHlvdXIgcHJvamVjdCDwn5qALCBnbyB0byB0aGUgYWRtaW5pc3RyYXRpb24gcGFuZWwgYXQ6JykpO1xuICAgIC8vICAgY29uc3QgYWRtaW5VcmwgPSBnZXRBYnNvbHV0ZUFkbWluVXJsKHNnQXBwLmNvbmZpZyk7XG4gICAgLy8gICBjb25zb2xlLmxvZyhjaGFsay5ib2xkKGFkbWluVXJsKSk7XG4gICAgLy8gICBjb25zb2xlLmxvZygpO1xuICAgIC8vIH1cblxuICAgIGNvbnNvbGUubG9nKGNoYWxrLmdyZXkoJ1RvIGFjY2VzcyB0aGUgc2VydmVyIOKaoe+4jywgZ28gdG86JykpO1xuICAgIGNvbnN0IHNlcnZlclVybCA9IGdldEFic29sdXRlU2VydmVyVXJsKHRoaXMuY29uZmlnKTtcbiAgICBjb25zb2xlLmxvZyhjaGFsay5ib2xkKHNlcnZlclVybCkpO1xuICAgIGNvbnNvbGUubG9nKCk7XG4gIH1cblxuICBhc3luYyBydW5Cb290c3RyYXBGdW5jdGlvbnMoKSB7XG4gICAgY29uc3QgZXhlY0Jvb3RzdHJhcCA9IGFzeW5jIChmbikgPT4ge1xuICAgICAgaWYgKCFmbikgcmV0dXJuO1xuXG4gICAgICByZXR1cm4gZm4oKTtcbiAgICB9O1xuXG4gICAgLy8gcGx1Z2lucyBib290c3RyYXBcbiAgICBjb25zdCBwbHVnaW5Cb29zdHJhcHMgPSBPYmplY3Qua2V5cyh0aGlzLnBsdWdpbnMpLm1hcCgocGx1Z2luKSA9PlxuICAgICAgZXhlY0Jvb3RzdHJhcChcbiAgICAgICAgXy5nZXQodGhpcy5wbHVnaW5zW3BsdWdpbl0sICdjb25maWcuZnVuY3Rpb25zLmJvb3RzdHJhcCcpXG4gICAgICApLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgc2dBcHAubG9nLmVycm9yKGBCb290c3RyYXAgZnVuY3Rpb24gaW4gcGx1Z2luIFwiJHtwbHVnaW59XCIgZmFpbGVkYCk7XG4gICAgICAgIHNnQXBwLmxvZy5lcnJvcihlcnIpO1xuICAgICAgICBzZ0FwcC5zdG9wKCk7XG4gICAgICB9KVxuICAgICk7XG4gICAgYXdhaXQgUHJvbWlzZS5hbGwocGx1Z2luQm9vc3RyYXBzKTtcblxuICAgIC8vIHVzZXIgYm9vdHN0cmFwXG4gICAgYXdhaXQgZXhlY0Jvb3RzdHJhcChfLmdldCh0aGlzLmNvbmZpZywgWydmdW5jdGlvbnMnLCAnYm9vdHN0cmFwJ10pKTtcbiAgfVxuXG4gIGFzeW5jIGZyZWV6ZSgpIHtcbiAgICBPYmplY3QuZnJlZXplKHRoaXMuY29uZmlnKTtcbiAgICBPYmplY3QuZnJlZXplKHRoaXMuZGlyKTtcbiAgICBPYmplY3QuZnJlZXplKHRoaXMuYWRtaW4pO1xuICAgIE9iamVjdC5mcmVlemUodGhpcy5wbHVnaW5zKTtcbiAgICBPYmplY3QuZnJlZXplKHRoaXMuYXBpKTtcbiAgfVxuXG4gIGdldE1vZGVsKG1vZGVsS2V5LCBwbHVnaW4pIHtcbiAgICByZXR1cm4gdGhpcy5kYi5nZXRNb2RlbChtb2RlbEtleSwgcGx1Z2luKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCaW5kcyBxdWVyaWVzIHdpdGggYSBzcGVjaWZpYyBtb2RlbFxuICAgKiBAcGFyYW0ge3N0cmluZ30gZW50aXR5IC0gZW50aXR5IG5hbWVcbiAgICogQHBhcmFtIHtzdHJpbmd9IHBsdWdpbiAtIHBsdWdpbiBuYW1lIG9yIG51bGxcbiAgICovXG4gIHF1ZXJ5KGVudGl0eSwgcGx1Z2luKSB7XG4gICAgcmV0dXJuIHRoaXMuZGIucXVlcnkoZW50aXR5LCBwbHVnaW4pO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gKG9wdGlvbnMpID0+IHtcbiAgY29uc3QgYXBwID0gbmV3IEFwcChvcHRpb25zKTtcbiAgZ2xvYmFsLnNnQXBwID0gYXBwOyAvLyBzZ0FwcCBzdGFuZCBmb3Igc29jaWFsIGdlYXIgQXBwXG4gIHJldHVybiBhcHA7XG59O1xuIl19