{"version":3,"sources":["App.js"],"names":["_","require","chalk","CLITable","express","http","errorHandler","bootstrap","loadModules","logger","createFs","getAbsoluteServerUrl","loadConfiguration","createEventHub","initializeMiddlewares","createWebhookRunner","createDatabaseManager","App","constructor","options","app","router","Router","initServer","log","dir","process","cwd","admin","plugins","config","isLoaded","fs","eventHub","server","createServer","on","err","code","stopWithError","port","error","connections","conn","key","remoteAddress","remotePort","destroy","cb","close","connKeys","Object","keys","forEach","listen","onListen","hideStartupMessage","env","HIDE_STARTUP_MESSAGE","logStartupMessage","listenSocket","get","listenErrHandler","catch","err1","customMessage","debug","stop","exitCode","has","exit","start","load","routePrefix","use","Promise","all","values","map","plugin","resolve","removeAllListeners","db","global","health","req","res","next","meta","url","includes","method","status","serverError","send","NODE_ENV","_req","modules","api","middleware","middlewares","webhookRunner","configuration","initialize","call","runBootstrapFunctions","freeze","logStats","columns","Math","min","stderr","console","black","bgWhite","padEnd","infoTable","colWidths","chars","mid","push","blue","Date","now","launchedAt","environment","pid","toString","bold","grey","serverUrl","execBootstrap","fn","pluginBoostraps","sgApp","getModel","modelKey","query","entity","module","exports"],"mappings":"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","sourcesContent":["/* eslint-disable no-console, consistent-return */\nconst _ = require('lodash');\nconst chalk = require('chalk');\nconst CLITable = require('cli-table3');\nconst express = require('express');\nconst http = require('http');\nconst errorHandler = require('errorhandler');\n\nconst bootstrap = require('./bootstrap');\nconst loadModules = require('./loader/modules.load');\nconst logger = require('./utils/logger.util');\nconst createFs = require('./utils/fs.util');\nconst { getAbsoluteServerUrl } = require('./utils/config.util');\nconst loadConfiguration = require('./configs');\nconst createEventHub = require('./services/event-hub');\nconst initializeMiddlewares = require('./middlewares');\nconst createWebhookRunner = require('./services/webhook-runner');\nconst { createDatabaseManager } = require('./database');\n\nclass App {\n  constructor(options = {}) {\n    this.app = express();\n    this.router = new express.Router();\n\n    this.initServer();\n\n    // Logger\n    this.log = logger;\n\n    this.dir = options.dir || process.cwd();\n\n    this.admin = {};\n    this.plugins = {};\n    this.config = loadConfiguration(this.dir, options);\n\n    this.isLoaded = false;\n\n    // internal services.\n    this.fs = createFs(this);\n    this.eventHub = createEventHub();\n  }\n\n  initServer() {\n    this.server = http.createServer(this.app);\n    // handle port in use cleanly\n    this.server.on('error', (err) => {\n      if (err.code === 'EADDRINUSE') {\n        return this.stopWithError(\n          `The port ${err.port} is already used by another application.`\n        );\n      }\n\n      return this.log.error(err);\n    });\n\n    // Close current connections to fully destroy the server\n    const connections = {};\n\n    this.server.on('connection', (conn) => {\n      const key = `${conn.remoteAddress}:${conn.remotePort}`;\n      connections[key] = conn;\n\n      conn.on('close', () => {\n        delete connections[key];\n      });\n    });\n\n    this.server.destroy = (cb) => {\n      this.server.close(cb);\n\n      const connKeys = Object.keys(connections);\n      connKeys.forEach((key) => {\n        connections[key].destroy();\n      });\n    };\n  }\n\n  /**\n   * Add behaviors to the server\n   */\n  async listen(cb) {\n    const onListen = async (err) => {\n      if (err) return this.stopWithError(err);\n\n      // Should the startup message be displayed?\n      const hideStartupMessage = process.env.HIDE_STARTUP_MESSAGE\n        ? process.env.HIDE_STARTUP_MESSAGE === 'true'\n        : false;\n\n      if (hideStartupMessage === false) {\n        this.logStartupMessage();\n      }\n\n      if (cb && typeof cb === 'function') {\n        cb();\n      }\n    };\n\n    const listenSocket = this.config.get('server.socket');\n    const listenErrHandler = (err) =>\n      onListen(err).catch((err1) => this.stopWithError(err1));\n\n    if (listenSocket) {\n      this.server.listen(listenSocket, listenErrHandler);\n    } else {\n      this.server.listen(\n        this.config.get('server.port'),\n        this.config.get('server.host'),\n        listenErrHandler\n      );\n    }\n  }\n\n  stopWithError(err, customMessage) {\n    this.log.debug(\"â›”ï¸ Server wasn't able to start properly.\");\n    if (customMessage) {\n      this.log.error(customMessage);\n    }\n    this.log.error(err);\n    return this.stop();\n  }\n\n  stop(exitCode = 1) {\n    // Destroy server and available connections.\n    if (_.has(this, 'server.destroy')) {\n      this.server.destroy();\n    }\n\n    // Kill process.\n    process.exit(exitCode);\n  }\n\n  async start(cb) {\n    try {\n      if (!this.isLoaded) {\n        await this.load();\n      }\n\n      // router\n      const routePrefix = this.config.get(\n        'middleware.settings.router.prefix',\n        ''\n      );\n      this.app.use(routePrefix, this.router);\n\n      // Launch server.\n      this.listen(cb);\n    } catch (err) {\n      this.stopWithError(err);\n    }\n  }\n\n  async destroy() {\n    if (_.has(this, 'server.destroy')) {\n      this.server.destroy();\n    }\n\n    await Promise.all(\n      Object.values(this.plugins).map((plugin) => {\n        if (_.has(plugin, 'destroy') && typeof plugin.destroy === 'function') {\n          return plugin.destroy();\n        }\n        return Promise.resolve();\n      })\n    );\n\n    if (_.has(this, 'admin')) {\n      await this.admin.destroy();\n    }\n\n    this.eventHub.removeAllListeners();\n\n    if (_.has(this, 'db')) {\n      await this.db.destroy();\n    }\n\n    delete global.app;\n  }\n\n  // eslint-disable-next-line class-methods-use-this\n  async health(req, res, next) {\n    req.meta = {};\n    if (req.url === '/_health' && ['HEAD', 'GET'].includes(req.method)) {\n      return res.status(204);\n    }\n    await next();\n  }\n\n  serverError(err, req, res) {\n    this.log.error(err);\n    res.status(500).send('Server Error');\n  }\n\n  async load() {\n    this.app.use(async (req, res, next) => this.health(req, res, next));\n\n    if (process.env.NODE_ENV === 'development') {\n      // only use in development\n      this.app.use(errorHandler());\n    } else {\n      this.app.use((err, _req, res) => this.serverError(err, _req, res));\n    }\n\n    const modules = await loadModules(this);\n\n    this.api = modules.api;\n    this.modules = modules.api;\n    this.plugins = modules.plugins;\n    this.middleware = modules.middlewares;\n\n    await bootstrap(this);\n\n    // init webhook runner\n    this.webhookRunner = createWebhookRunner({\n      eventHub: this.eventHub,\n      logger: this.log,\n      configuration: this.config.get('server.webhooks', {}),\n    });\n\n    // Init core store\n    // this.models['core_store'] = coreStoreModel(this.config);\n    // this.models['app_webhooks'] = webhookModel(this.config);\n\n    this.db = createDatabaseManager(this);\n    await this.db.initialize();\n\n    // this.store = createCoreStore({\n    //   environment: this.config.environment,\n    //   db: this.db,\n    // });\n\n    // this.entityValidator = entityValidator;\n\n    // this.entityService = createEntityService({\n    //   db: this.db,\n    //   eventHub: this.eventHub,\n    //   entityValidator: this.entityValidator,\n    // });\n\n    // this.telemetry = createTelemetry(this);\n\n    await initializeMiddlewares.call(this);\n\n    await this.runBootstrapFunctions();\n    await this.freeze();\n\n    this.isLoaded = true;\n\n    return this;\n  }\n\n  logStats() {\n    const columns = Math.min(process.stderr.columns, 80) - 2;\n    console.log();\n    console.log(chalk.black.bgWhite(_.padEnd(' Project information', columns)));\n    console.log();\n\n    const infoTable = new CLITable({\n      colWidths: [20, 50],\n      chars: {\n        mid: '',\n        'left-mid': '',\n        'mid-mid': '',\n        'right-mid': '',\n      },\n    });\n\n    infoTable.push(\n      [chalk.blue('Time'), `${new Date()}`],\n      [chalk.blue('Launched in'), `${Date.now() - this.config.launchedAt} ms`],\n      [chalk.blue('Environment'), this.config.environment],\n      [chalk.blue('Process PID'), process.pid]\n      // [chalk.blue('Version'), `${this.config.info.app} (node ${process.version})`]\n    );\n\n    console.log(infoTable.toString());\n    console.log();\n    console.log(chalk.black.bgWhite(_.padEnd(' Actions available', columns)));\n    console.log();\n  }\n\n  logStartupMessage() {\n    this.logStats();\n\n    console.log(chalk.bold('Welcome back!'));\n\n    // if (this.config.serveAdminPanel === true) {\n    //   console.log(chalk.grey('To manage your project ðŸš€, go to the administration panel at:'));\n    //   const adminUrl = getAbsoluteAdminUrl(sgApp.config);\n    //   console.log(chalk.bold(adminUrl));\n    //   console.log();\n    // }\n\n    console.log(chalk.grey('To access the server âš¡ï¸, go to:'));\n    const serverUrl = getAbsoluteServerUrl(this.config);\n    console.log(chalk.bold(serverUrl));\n    console.log();\n  }\n\n  async runBootstrapFunctions() {\n    const execBootstrap = async (fn) => {\n      if (!fn) return;\n\n      return fn();\n    };\n\n    // plugins bootstrap\n    const pluginBoostraps = Object.keys(this.plugins).map((plugin) =>\n      execBootstrap(\n        _.get(this.plugins[plugin], 'config.functions.bootstrap')\n      ).catch((err) => {\n        sgApp.log.error(`Bootstrap function in plugin \"${plugin}\" failed`);\n        sgApp.log.error(err);\n        sgApp.stop();\n      })\n    );\n    await Promise.all(pluginBoostraps);\n\n    // user bootstrap\n    await execBootstrap(_.get(this.config, ['functions', 'bootstrap']));\n  }\n\n  async freeze() {\n    Object.freeze(this.config);\n    Object.freeze(this.dir);\n    Object.freeze(this.admin);\n    Object.freeze(this.plugins);\n    Object.freeze(this.api);\n  }\n\n  getModel(modelKey, plugin) {\n    return this.db.getModel(modelKey, plugin);\n  }\n\n  /**\n   * Binds queries with a specific model\n   * @param {string} entity - entity name\n   * @param {string} plugin - plugin name or null\n   */\n  query(entity, plugin) {\n    return this.db.query(entity, plugin);\n  }\n}\n\nmodule.exports = (options) => {\n  const app = new App(options);\n  global.sgApp = app; // sgApp stand for social gear App\n  return app;\n};\n"]}