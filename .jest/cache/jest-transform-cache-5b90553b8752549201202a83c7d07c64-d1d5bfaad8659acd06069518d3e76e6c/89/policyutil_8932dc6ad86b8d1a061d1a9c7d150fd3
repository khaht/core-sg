f83eecef70c981364c08377fc2ef3bdb
/**
 * Policies util
 */
const _ = require('lodash');

const GLOBAL_PREFIX = 'global::';
const PLUGIN_PREFIX = 'plugins::';
const ADMIN_PREFIX = 'admin::';
const APPLICATION_PREFIX = 'application::';
const isPolicyFactory = _.isArray;

const getPolicyIn = (container, policy) => _.get(container, ['config', 'policies', _.toLower(policy)]);

const policyExistsIn = (container, policy) => !_.isUndefined(getPolicyIn(container, policy));

const stripPolicy = (policy, prefix) => policy.replace(prefix, '');

const createPolicy = (policyName, ...args) => ({
  policyName,
  args
});

const resolveHandler = policy => _.isFunction(policy) ? policy : policy.handler;

const policyResolvers = [{
  name: 'api',

  is(policy) {
    return _.startsWith(policy, APPLICATION_PREFIX);
  },

  exists(policy) {
    return this.is(policy) && !_.isUndefined(this.get(policy));
  },

  get: policy => {
    const [, policyWithoutPrefix] = policy.split('::');
    const [api = '', policyName = ''] = policyWithoutPrefix.split('.');
    return getPolicyIn(_.get(sgApp, ['api', api]), policyName);
  }
}, {
  name: 'admin',

  is(policy) {
    return _.startsWith(policy, ADMIN_PREFIX);
  },

  exists(policy) {
    return this.is(policy) && !_.isUndefined(this.get(policy));
  },

  get: policy => getPolicyIn(_.get(sgApp, 'admin'), stripPolicy(policy, ADMIN_PREFIX))
}, {
  name: 'plugin',

  is(policy) {
    return _.startsWith(policy, PLUGIN_PREFIX);
  },

  exists(policy) {
    return this.is(policy) && !_.isUndefined(this.get(policy));
  },

  get(policy) {
    const [plugin = '', policyName = ''] = stripPolicy(policy, PLUGIN_PREFIX).split('.');
    return getPolicyIn(_.get(sgApp, ['plugins', plugin]), policyName);
  }

}, {
  name: 'global',

  is(policy) {
    return _.startsWith(policy, GLOBAL_PREFIX);
  },

  exists(policy) {
    return this.is(policy) && !_.isUndefined(this.get(policy));
  },

  get(policy) {
    return getPolicyIn(sgApp, stripPolicy(policy, GLOBAL_PREFIX));
  }

}]; // eslint-disable-next-line max-len

const parsePolicy = policy => isPolicyFactory(policy) ? createPolicy(...policy) : createPolicy(policy);

const resolvePolicy = policyName => {
  const resolver = policyResolvers.find(r => r.exists(policyName));
  return resolver ? resolveHandler(resolver.get)(policyName) : undefined;
};

const searchLocalPolicy = (policy, apiName) => {
  const [absoluteApiName, policyName] = policy.split('.');

  const absoluteApi = _.get(sgApp.api, absoluteApiName);

  if (policyExistsIn(absoluteApi, policyName)) {
    return resolveHandler(getPolicyIn(absoluteApi, policyName));
  }

  const api = _.get(sgApp.api, apiName);

  if (api && policyExistsIn(api, policy)) {
    return resolveHandler(getPolicyIn(api, policy));
  }

  return undefined;
};

const globalPolicy = ({
  method,
  endpoint,
  controller,
  action,
  plugin
}) => async (req, _res, next) => {
  req.route = {
    endpoint: `${method} ${endpoint}`,
    controller: _.toLower(controller),
    action: _.toLower(action),
    verb: _.toLower(method),
    plugin
  };
  req.params = _.defaults({}, req.query, req.params, req.body);
  await next();
};

const get = (policy, apiName) => {
  const {
    policyName,
    args
  } = parsePolicy(policy);
  const resolvedPolicy = resolvePolicy(policyName);

  if (resolvedPolicy !== undefined) {
    return isPolicyFactory(policy) ? resolvedPolicy(...args) : resolvedPolicy;
  }

  const localPolicy = searchLocalPolicy(policy, apiName);

  if (localPolicy !== undefined) {
    return localPolicy;
  }

  throw new Error(`Could not find policy "${policy}"`);
};

const createPolicyFactory = (factoryCallback, options) => {
  const {
    validator,
    name = 'unnamed'
  } = options;

  const validate = (...args) => {
    try {
      validator(...args);
    } catch (e) {
      throw new Error(`Invalid objects submitted to "${name}" policy.`);
    }
  };

  return (...args) => {
    if (validator) {
      validate(...args);
    }

    return factoryCallback(...args);
  };
};

module.exports = {
  get,
  globalPolicy,
  createPolicyFactory
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBvbGljeS51dGlsLmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwiR0xPQkFMX1BSRUZJWCIsIlBMVUdJTl9QUkVGSVgiLCJBRE1JTl9QUkVGSVgiLCJBUFBMSUNBVElPTl9QUkVGSVgiLCJpc1BvbGljeUZhY3RvcnkiLCJpc0FycmF5IiwiZ2V0UG9saWN5SW4iLCJjb250YWluZXIiLCJwb2xpY3kiLCJnZXQiLCJ0b0xvd2VyIiwicG9saWN5RXhpc3RzSW4iLCJpc1VuZGVmaW5lZCIsInN0cmlwUG9saWN5IiwicHJlZml4IiwicmVwbGFjZSIsImNyZWF0ZVBvbGljeSIsInBvbGljeU5hbWUiLCJhcmdzIiwicmVzb2x2ZUhhbmRsZXIiLCJpc0Z1bmN0aW9uIiwiaGFuZGxlciIsInBvbGljeVJlc29sdmVycyIsIm5hbWUiLCJpcyIsInN0YXJ0c1dpdGgiLCJleGlzdHMiLCJwb2xpY3lXaXRob3V0UHJlZml4Iiwic3BsaXQiLCJhcGkiLCJzZ0FwcCIsInBsdWdpbiIsInBhcnNlUG9saWN5IiwicmVzb2x2ZVBvbGljeSIsInJlc29sdmVyIiwiZmluZCIsInIiLCJ1bmRlZmluZWQiLCJzZWFyY2hMb2NhbFBvbGljeSIsImFwaU5hbWUiLCJhYnNvbHV0ZUFwaU5hbWUiLCJhYnNvbHV0ZUFwaSIsImdsb2JhbFBvbGljeSIsIm1ldGhvZCIsImVuZHBvaW50IiwiY29udHJvbGxlciIsImFjdGlvbiIsInJlcSIsIl9yZXMiLCJuZXh0Iiwicm91dGUiLCJ2ZXJiIiwicGFyYW1zIiwiZGVmYXVsdHMiLCJxdWVyeSIsImJvZHkiLCJyZXNvbHZlZFBvbGljeSIsImxvY2FsUG9saWN5IiwiRXJyb3IiLCJjcmVhdGVQb2xpY3lGYWN0b3J5IiwiZmFjdG9yeUNhbGxiYWNrIiwib3B0aW9ucyIsInZhbGlkYXRvciIsInZhbGlkYXRlIiwiZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUVBLE1BQU1BLENBQUMsR0FBR0MsT0FBTyxD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OlsiLyoqXG4gKiBQb2xpY2llcyB1dGlsXG4gKi9cblxuY29uc3QgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xuXG5jb25zdCBHTE9CQUxfUFJFRklYID0gJ2dsb2JhbDo6JztcbmNvbnN0IFBMVUdJTl9QUkVGSVggPSAncGx1Z2luczo6JztcbmNvbnN0IEFETUlOX1BSRUZJWCA9ICdhZG1pbjo6JztcbmNvbnN0IEFQUExJQ0FUSU9OX1BSRUZJWCA9ICdhcHBsaWNhdGlvbjo6JztcblxuY29uc3QgaXNQb2xpY3lGYWN0b3J5ID0gXy5pc0FycmF5O1xuXG5jb25zdCBnZXRQb2xpY3lJbiA9IChjb250YWluZXIsIHBvbGljeSkgPT5cbiAgXy5nZXQoY29udGFpbmVyLCBbJ2NvbmZpZycsICdwb2xpY2llcycsIF8udG9Mb3dlcihwb2xpY3kpXSk7XG5cbmNvbnN0IHBvbGljeUV4aXN0c0luID0gKGNvbnRhaW5lciwgcG9saWN5KSA9PlxuICAhXy5pc1VuZGVmaW5lZChnZXRQb2xpY3lJbihjb250YWluZXIsIHBvbGljeSkpO1xuXG5jb25zdCBzdHJpcFBvbGljeSA9IChwb2xpY3ksIHByZWZpeCkgPT4gcG9saWN5LnJlcGxhY2UocHJlZml4LCAnJyk7XG5cbmNvbnN0IGNyZWF0ZVBvbGljeSA9IChwb2xpY3lOYW1lLCAuLi5hcmdzKSA9PiAoeyBwb2xpY3lOYW1lLCBhcmdzIH0pO1xuXG5jb25zdCByZXNvbHZlSGFuZGxlciA9IChwb2xpY3kpID0+XG4gIF8uaXNGdW5jdGlvbihwb2xpY3kpID8gcG9saWN5IDogcG9saWN5LmhhbmRsZXI7XG5cbmNvbnN0IHBvbGljeVJlc29sdmVycyA9IFtcbiAge1xuICAgIG5hbWU6ICdhcGknLFxuICAgIGlzKHBvbGljeSkge1xuICAgICAgcmV0dXJuIF8uc3RhcnRzV2l0aChwb2xpY3ksIEFQUExJQ0FUSU9OX1BSRUZJWCk7XG4gICAgfSxcbiAgICBleGlzdHMocG9saWN5KSB7XG4gICAgICByZXR1cm4gdGhpcy5pcyhwb2xpY3kpICYmICFfLmlzVW5kZWZpbmVkKHRoaXMuZ2V0KHBvbGljeSkpO1xuICAgIH0sXG4gICAgZ2V0OiAocG9saWN5KSA9PiB7XG4gICAgICBjb25zdCBbLCBwb2xpY3lXaXRob3V0UHJlZml4XSA9IHBvbGljeS5zcGxpdCgnOjonKTtcbiAgICAgIGNvbnN0IFthcGkgPSAnJywgcG9saWN5TmFtZSA9ICcnXSA9IHBvbGljeVdpdGhvdXRQcmVmaXguc3BsaXQoJy4nKTtcbiAgICAgIHJldHVybiBnZXRQb2xpY3lJbihfLmdldChzZ0FwcCwgWydhcGknLCBhcGldKSwgcG9saWN5TmFtZSk7XG4gICAgfSxcbiAgfSxcbiAge1xuICAgIG5hbWU6ICdhZG1pbicsXG4gICAgaXMocG9saWN5KSB7XG4gICAgICByZXR1cm4gXy5zdGFydHNXaXRoKHBvbGljeSwgQURNSU5fUFJFRklYKTtcbiAgICB9LFxuICAgIGV4aXN0cyhwb2xpY3kpIHtcbiAgICAgIHJldHVybiB0aGlzLmlzKHBvbGljeSkgJiYgIV8uaXNVbmRlZmluZWQodGhpcy5nZXQocG9saWN5KSk7XG4gICAgfSxcbiAgICBnZXQ6IChwb2xpY3kpID0+XG4gICAgICBnZXRQb2xpY3lJbihfLmdldChzZ0FwcCwgJ2FkbWluJyksIHN0cmlwUG9saWN5KHBvbGljeSwgQURNSU5fUFJFRklYKSksXG4gIH0sXG4gIHtcbiAgICBuYW1lOiAncGx1Z2luJyxcbiAgICBpcyhwb2xpY3kpIHtcbiAgICAgIHJldHVybiBfLnN0YXJ0c1dpdGgocG9saWN5LCBQTFVHSU5fUFJFRklYKTtcbiAgICB9LFxuICAgIGV4aXN0cyhwb2xpY3kpIHtcbiAgICAgIHJldHVybiB0aGlzLmlzKHBvbGljeSkgJiYgIV8uaXNVbmRlZmluZWQodGhpcy5nZXQocG9saWN5KSk7XG4gICAgfSxcbiAgICBnZXQocG9saWN5KSB7XG4gICAgICBjb25zdCBbcGx1Z2luID0gJycsIHBvbGljeU5hbWUgPSAnJ10gPSBzdHJpcFBvbGljeShcbiAgICAgICAgcG9saWN5LFxuICAgICAgICBQTFVHSU5fUFJFRklYXG4gICAgICApLnNwbGl0KCcuJyk7XG4gICAgICByZXR1cm4gZ2V0UG9saWN5SW4oXy5nZXQoc2dBcHAsIFsncGx1Z2lucycsIHBsdWdpbl0pLCBwb2xpY3lOYW1lKTtcbiAgICB9LFxuICB9LFxuICB7XG4gICAgbmFtZTogJ2dsb2JhbCcsXG4gICAgaXMocG9saWN5KSB7XG4gICAgICByZXR1cm4gXy5zdGFydHNXaXRoKHBvbGljeSwgR0xPQkFMX1BSRUZJWCk7XG4gICAgfSxcbiAgICBleGlzdHMocG9saWN5KSB7XG4gICAgICByZXR1cm4gdGhpcy5pcyhwb2xpY3kpICYmICFfLmlzVW5kZWZpbmVkKHRoaXMuZ2V0KHBvbGljeSkpO1xuICAgIH0sXG4gICAgZ2V0KHBvbGljeSkge1xuICAgICAgcmV0dXJuIGdldFBvbGljeUluKHNnQXBwLCBzdHJpcFBvbGljeShwb2xpY3ksIEdMT0JBTF9QUkVGSVgpKTtcbiAgICB9LFxuICB9LFxuXTtcblxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG1heC1sZW5cbmNvbnN0IHBhcnNlUG9saWN5ID0gKHBvbGljeSkgPT5cbiAgaXNQb2xpY3lGYWN0b3J5KHBvbGljeSkgPyBjcmVhdGVQb2xpY3koLi4ucG9saWN5KSA6IGNyZWF0ZVBvbGljeShwb2xpY3kpO1xuXG5jb25zdCByZXNvbHZlUG9saWN5ID0gKHBvbGljeU5hbWUpID0+IHtcbiAgY29uc3QgcmVzb2x2ZXIgPSBwb2xpY3lSZXNvbHZlcnMuZmluZCgocikgPT4gci5leGlzdHMocG9saWN5TmFtZSkpO1xuXG4gIHJldHVybiByZXNvbHZlciA/IHJlc29sdmVIYW5kbGVyKHJlc29sdmVyLmdldCkocG9saWN5TmFtZSkgOiB1bmRlZmluZWQ7XG59O1xuXG5jb25zdCBzZWFyY2hMb2NhbFBvbGljeSA9IChwb2xpY3ksIGFwaU5hbWUpID0+IHtcbiAgY29uc3QgW2Fic29sdXRlQXBpTmFtZSwgcG9saWN5TmFtZV0gPSBwb2xpY3kuc3BsaXQoJy4nKTtcbiAgY29uc3QgYWJzb2x1dGVBcGkgPSBfLmdldChzZ0FwcC5hcGksIGFic29sdXRlQXBpTmFtZSk7XG5cbiAgaWYgKHBvbGljeUV4aXN0c0luKGFic29sdXRlQXBpLCBwb2xpY3lOYW1lKSkge1xuICAgIHJldHVybiByZXNvbHZlSGFuZGxlcihnZXRQb2xpY3lJbihhYnNvbHV0ZUFwaSwgcG9saWN5TmFtZSkpO1xuICB9XG5cbiAgY29uc3QgYXBpID0gXy5nZXQoc2dBcHAuYXBpLCBhcGlOYW1lKTtcbiAgaWYgKGFwaSAmJiBwb2xpY3lFeGlzdHNJbihhcGksIHBvbGljeSkpIHtcbiAgICByZXR1cm4gcmVzb2x2ZUhhbmRsZXIoZ2V0UG9saWN5SW4oYXBpLCBwb2xpY3kpKTtcbiAgfVxuXG4gIHJldHVybiB1bmRlZmluZWQ7XG59O1xuXG5jb25zdCBnbG9iYWxQb2xpY3kgPSAoe1xuICBtZXRob2QsXG4gIGVuZHBvaW50LFxuICBjb250cm9sbGVyLFxuICBhY3Rpb24sXG4gIHBsdWdpbixcbn0pID0+IGFzeW5jIChyZXEsIF9yZXMsIG5leHQpID0+IHtcbiAgcmVxLnJvdXRlID0ge1xuICAgIGVuZHBvaW50OiBgJHttZXRob2R9ICR7ZW5kcG9pbnR9YCxcbiAgICBjb250cm9sbGVyOiBfLnRvTG93ZXIoY29udHJvbGxlciksXG4gICAgYWN0aW9uOiBfLnRvTG93ZXIoYWN0aW9uKSxcbiAgICB2ZXJiOiBfLnRvTG93ZXIobWV0aG9kKSxcbiAgICBwbHVnaW4sXG4gIH07XG5cbiAgcmVxLnBhcmFtcyA9IF8uZGVmYXVsdHMoe30sIHJlcS5xdWVyeSwgcmVxLnBhcmFtcywgcmVxLmJvZHkpO1xuXG4gIGF3YWl0IG5leHQoKTtcbn07XG5cbmNvbnN0IGdldCA9IChwb2xpY3ksIGFwaU5hbWUpID0+IHtcbiAgY29uc3QgeyBwb2xpY3lOYW1lLCBhcmdzIH0gPSBwYXJzZVBvbGljeShwb2xpY3kpO1xuXG4gIGNvbnN0IHJlc29sdmVkUG9saWN5ID0gcmVzb2x2ZVBvbGljeShwb2xpY3lOYW1lKTtcblxuICBpZiAocmVzb2x2ZWRQb2xpY3kgIT09IHVuZGVmaW5lZCkge1xuICAgIHJldHVybiBpc1BvbGljeUZhY3RvcnkocG9saWN5KSA/IHJlc29sdmVkUG9saWN5KC4uLmFyZ3MpIDogcmVzb2x2ZWRQb2xpY3k7XG4gIH1cblxuICBjb25zdCBsb2NhbFBvbGljeSA9IHNlYXJjaExvY2FsUG9saWN5KHBvbGljeSwgYXBpTmFtZSk7XG5cbiAgaWYgKGxvY2FsUG9saWN5ICE9PSB1bmRlZmluZWQpIHtcbiAgICByZXR1cm4gbG9jYWxQb2xpY3k7XG4gIH1cblxuICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBmaW5kIHBvbGljeSBcIiR7cG9saWN5fVwiYCk7XG59O1xuXG5jb25zdCBjcmVhdGVQb2xpY3lGYWN0b3J5ID0gKGZhY3RvcnlDYWxsYmFjaywgb3B0aW9ucykgPT4ge1xuICBjb25zdCB7IHZhbGlkYXRvciwgbmFtZSA9ICd1bm5hbWVkJyB9ID0gb3B0aW9ucztcblxuICBjb25zdCB2YWxpZGF0ZSA9ICguLi5hcmdzKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIHZhbGlkYXRvciguLi5hcmdzKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgb2JqZWN0cyBzdWJtaXR0ZWQgdG8gXCIke25hbWV9XCIgcG9saWN5LmApO1xuICAgIH1cbiAgfTtcblxuICByZXR1cm4gKC4uLmFyZ3MpID0+IHtcbiAgICBpZiAodmFsaWRhdG9yKSB7XG4gICAgICB2YWxpZGF0ZSguLi5hcmdzKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZmFjdG9yeUNhbGxiYWNrKC4uLmFyZ3MpO1xuICB9O1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGdldCxcbiAgZ2xvYmFsUG9saWN5LFxuICBjcmVhdGVQb2xpY3lGYWN0b3J5LFxufTtcbiJdfQ==