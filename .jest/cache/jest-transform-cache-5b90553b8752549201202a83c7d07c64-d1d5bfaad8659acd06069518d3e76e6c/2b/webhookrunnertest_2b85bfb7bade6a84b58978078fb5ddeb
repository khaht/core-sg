8467eaea9b4ab18372d282f62f8d1e68
_getJestObj().mock('node-fetch', () => jest.fn().mockImplementationOnce(() => Promise.resolve({
  ok: 'Ok',
  status: 200,
  text: jest.fn(() => Promise.resolve('text'))
})).mockImplementationOnce(() => Promise.resolve({
  status: 200,
  text: jest.fn(() => Promise.resolve('text'))
})).mockImplementationOnce(() => Promise.reject(false)));

function _getJestObj() {
  const {
    jest
  } = require("@jest/globals");

  _getJestObj = () => jest;

  return jest;
}

const createWebhookRunner = require('../webhook-runner');

const createEventHub = require('../event-hub');

const logger = require('utils/logger.util');

const _ = require('lodash');

describe('Create webhook runner', () => {
  test('Should return constructor object', () => {
    const opts = {
      eventHub: createEventHub(),
      logger
    };

    const _webhookRunner = createWebhookRunner(opts);

    _webhookRunner.queue.enqueue([]);

    expect(Object.keys(_webhookRunner)).toEqual(['eventHub', 'logger', 'webhooksMap', 'listeners', 'config', 'queue']);
  });
  test('Should pop worker queue and execute', () => {
    const opts = {
      eventHub: createEventHub(),
      logger,
      configuration: {}
    };

    const _webhookRunner = createWebhookRunner(opts);

    _webhookRunner.queue.concurrency = 0;

    _webhookRunner.queue.enqueue([{
      event: 'test',
      info: 'info'
    }]);

    _webhookRunner.queue.pop();

    expect(_webhookRunner.queue.queue).toEqual([]);
  });
  test('Should configuration does not object', () => {
    const opts = {
      eventHub: createEventHub(),
      logger,
      configuration: 'configuration'
    };
    expect(() => createWebhookRunner(opts)).toThrow();
  });
  test('Should create or delete event', () => {
    const opts = {
      eventHub: createEventHub(),
      logger,
      configuration: {}
    };

    const _webhookRunner = createWebhookRunner(opts);

    _webhookRunner.createListener('test');

    _webhookRunner.eventHub._events.test();

    expect(_webhookRunner.listeners.has('test')).toBe(true);

    _webhookRunner.deleteListener('test');

    _webhookRunner.deleteListener('test'); // else branch


    expect(_webhookRunner.listeners.has('test')).toBe(false);
  });
  test('Should not create event if existed', () => {
    const opts = {
      eventHub: createEventHub(),
      logger,
      configuration: {}
    };

    const _webhookRunner = createWebhookRunner(opts);

    _webhookRunner.createListener('test');

    expect(_webhookRunner.listeners.has('test')).toBe(true);

    const resp = _webhookRunner.createListener('test');

    expect(resp).toBeUndefined();
  });
  test('Should add update delete executeListener a webhook', async () => {
    const opts = {
      eventHub: createEventHub(),
      logger,
      configuration: {}
    };

    const _webhookRunner = createWebhookRunner(opts);

    _webhookRunner.add({
      id: 'webhookId',
      events: ['test', 'test']
    });

    expect(_webhookRunner.webhooksMap.has('test')).toBe(true);

    _webhookRunner.add({
      id: 'webhookId1',
      events: ['test1']
    });

    _webhookRunner.remove({
      id: 'webhookId1',
      events: ['test1']
    });

    expect(_webhookRunner.webhooksMap.has('test1')).toBe(false);

    _webhookRunner.update({
      id: 'webhookId',
      events: ['test1'],
      isEnabled: true,
      url: 'url',
      headers: {}
    });

    expect(_webhookRunner.webhooksMap.has('test1')).toBe(true);
    await _webhookRunner.executeListener({
      event: 'test1'
    });
    expect(require('node-fetch')).toHaveBeenCalledTimes(1);
    await _webhookRunner.executeListener({
      event: 'test1',
      info: 'info'
    });
    expect(require('node-fetch')).toHaveBeenCalledTimes(2);
    await _webhookRunner.executeListener({
      event: 'test1',
      info: 'info'
    });
    expect(require('node-fetch')).toHaveBeenCalledTimes(3);
  });
  test('Should log error after executeListener', async () => {
    const opts = {
      eventHub: createEventHub(),
      logger,
      configuration: {}
    };

    const _webhookRunner = createWebhookRunner(opts);

    _webhookRunner.add({
      id: 'webhookId',
      events: ['test']
    });

    _webhookRunner.update({
      id: 'webhookId',
      events: ['test1'],
      isEnabled: true,
      url: 'url',
      headers: {}
    });

    _webhookRunner.run = jest.fn(() => Promise.reject(false));
    await _webhookRunner.executeListener({
      event: 'test1',
      info: 'info'
    });
    expect(_webhookRunner.run).toHaveBeenCalledTimes(1);
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYmhvb2stcnVubmVyLnRlc3QuanMiXSwibmFtZXMiOlsibW9jayIsImplc3QiLCJmbiIsIm1vY2tJbXBsZW1lbnRhdGlvbk9uY2UiLCJQcm9taXNlIiwicmVzb2x2ZSIsIm9rIiwic3RhdHVzIiwidGV4dCIsInJlamVjdCIsImNyZWF0ZVdlYmhvb2tSdW5uZXIiLCJyZXF1aXJlIiwiY3JlYXRlRXZlbnRIdWIiLCJsb2dnZXIiLCJfIiwiZGVzY3JpYmUiLCJ0ZXN0Iiwib3B0cyIsImV2ZW50SHViIiwiX3dlYmhvb2tSdW5uZXIiLCJxdWV1ZSIsImVucXVldWUiLCJleHBlY3QiLCJPYmplY3QiLCJrZXlzIiwidG9FcXVhbCIsImNvbmZpZ3VyYXRpb24iLCJjb25jdXJyZW5jeSIsImV2ZW50IiwiaW5mbyIsInBvcCIsInRvVGhyb3ciLCJjcmVhdGVMaXN0ZW5lciIsIl9ldmVudHMiLCJsaXN0ZW5lcnMiLCJoYXMiLCJ0b0JlIiwiZGVsZXRlTGlzdGVuZXIiLCJyZXNwIiwidG9CZVVuZGVmaW5lZCIsImFkZCIsImlkIiwiZXZlbnRzIiwid2ViaG9va3NNYXAiLCJyZW1vdmUiLCJ1cGRhdGUiLCJpc0VuYWJsZWQiLCJ1cmwiLCJoZWFkZXJzIiwiZXhlY3V0ZUxpc3RlbmVyIiwidG9IYXZlQmVlbkNhbGxlZFRpbWVzIiwicnVuIl0sIm1hcHBpbmdzIjoiQUFLQSxjQUFLQSxJQUFMLENBQVUsWUFBVixFQUF3QixNQUN0QkMsSUFBSSxDQUNEQyxFQURILEdBRUdDLHNCQUZILENBRTBCLE1BQ3RCQyxPQUFPLENBQUNDLE9BQVIsQ0FBZ0I7QUFDZEMsRUFBQUEsRUFBRSxFQUFFLElBRFU7QUFFZEMsRUFBQUEsTUFBTSxFQUFFLEdBRk07QUFHZEMsRUFBQUEsSUFBSSxFQUFFUCxJQUFJLENBQUNDLEVBQUwsQ0FBUSxNQUFNRSxPQUFPLENBQUNDLE9BQVIsQ0FBZ0IsTUFBaEIsQ0FBZDtBQUhRLENBQWhCLENBSEosRUFTR0Ysc0JBVEgsQ0FTMEIsTUFDdEJDLE9BQU8s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QUFDMEIsTUFBZixDQUFzQjtBQUNwQkosTUFBQUEsRUFBRSxFQUFFLFdBRGdCO0FBRXBCQyxNQUFBQSxNQUFNLEVBQUUsQ0FBQyxPQUFELENBRlk7QUFHcEJJLE1BQUFBLFNBQVMsRUFBRSxJQUhTO0FBSXBCQyxNQUFBQSxHQUFHLEVBQUUsS0FKZTtBQUtwQkMsTUFBQUEsT0FBTyxFQUFFO0FBTFcsS0FBdEI7O0FBT0E3QixJQUFBQSxjQUFjLENBQUNnQyxHQUFmLEdBQXFCbEQsSUFBSSxDQUFDQyxFQUFMLENBQVEsTUFBTUUsT0FBTyxDQUFDSyxNQUFSLENBQWUsS0FBZixDQUFkLENBQXJCO0FBQ0EsVUFBTVUsY0FBYyxDQUFDOEIsZUFBZixDQUErQjtBQUFFckIsTUFBQUEsS0FBSyxFQUFFLE9BQVQ7QUFBa0JDLE1BQUFBLElBQUksRUFBRTtBQUF4QixLQUEvQixDQUFOO0FBQ0FQLElBQUFBLE1BQU0sQ0FBQ0gsY0FBYyxDQUFDZ0MsR0FBaEIsQ0FBTixDQUEyQkQscUJBQTNCLENBQWlELENBQWpEO0FBQ0QsR0FkRyxDQUFKO0FBZUQsQ0FyR08sQ0FBUiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGNyZWF0ZVdlYmhvb2tSdW5uZXIgPSByZXF1aXJlKCcuLi93ZWJob29rLXJ1bm5lcicpO1xuY29uc3QgY3JlYXRlRXZlbnRIdWIgPSByZXF1aXJlKCcuLi9ldmVudC1odWInKTtcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoJ3V0aWxzL2xvZ2dlci51dGlsJyk7XG5jb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG5cbmplc3QubW9jaygnbm9kZS1mZXRjaCcsICgpID0+XG4gIGplc3RcbiAgICAuZm4oKVxuICAgIC5tb2NrSW1wbGVtZW50YXRpb25PbmNlKCgpID0+XG4gICAgICBQcm9taXNlLnJlc29sdmUoe1xuICAgICAgICBvazogJ09rJyxcbiAgICAgICAgc3RhdHVzOiAyMDAsXG4gICAgICAgIHRleHQ6IGplc3QuZm4oKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCd0ZXh0JykpLFxuICAgICAgfSlcbiAgICApXG4gICAgLm1vY2tJbXBsZW1lbnRhdGlvbk9uY2UoKCkgPT5cbiAgICAgIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICAgIHN0YXR1czogMjAwLFxuICAgICAgICB0ZXh0OiBqZXN0LmZuKCgpID0+IFByb21pc2UucmVzb2x2ZSgndGV4dCcpKSxcbiAgICAgIH0pXG4gICAgKVxuICAgIC5tb2NrSW1wbGVtZW50YXRpb25PbmNlKCgpID0+XG4gICAgICBQcm9taXNlLnJlamVjdChmYWxzZSlcbiAgICApXG4pO1xuXG5kZXNjcmliZSgnQ3JlYXRlIHdlYmhvb2sgcnVubmVyJywgKCkgPT4ge1xuICB0ZXN0KCdTaG91bGQgcmV0dXJuIGNvbnN0cnVjdG9yIG9iamVjdCcsICgpID0+IHtcbiAgICBjb25zdCBvcHRzID0geyBldmVudEh1YjogY3JlYXRlRXZlbnRIdWIoKSwgbG9nZ2VyIH07XG4gICAgY29uc3QgX3dlYmhvb2tSdW5uZXIgPSBjcmVhdGVXZWJob29rUnVubmVyKG9wdHMpO1xuICAgIF93ZWJob29rUnVubmVyLnF1ZXVlLmVucXVldWUoW10pO1xuXG4gICAgZXhwZWN0KE9iamVjdC5rZXlzKF93ZWJob29rUnVubmVyKSkudG9FcXVhbChbXG4gICAgICAnZXZlbnRIdWInLFxuICAgICAgJ2xvZ2dlcicsXG4gICAgICAnd2ViaG9va3NNYXAnLFxuICAgICAgJ2xpc3RlbmVycycsXG4gICAgICAnY29uZmlnJyxcbiAgICAgICdxdWV1ZScsXG4gICAgXSk7XG4gIH0pO1xuXG4gIHRlc3QoJ1Nob3VsZCBwb3Agd29ya2VyIHF1ZXVlIGFuZCBleGVjdXRlJywgKCkgPT4ge1xuICAgIGNvbnN0IG9wdHMgPSB7IGV2ZW50SHViOiBjcmVhdGVFdmVudEh1YigpLCBsb2dnZXIsIGNvbmZpZ3VyYXRpb246IHt9IH07XG4gICAgY29uc3QgX3dlYmhvb2tSdW5uZXIgPSBjcmVhdGVXZWJob29rUnVubmVyKG9wdHMpO1xuICAgIF93ZWJob29rUnVubmVyLnF1ZXVlLmNvbmN1cnJlbmN5ID0gMDtcbiAgICBfd2ViaG9va1J1bm5lci5xdWV1ZS5lbnF1ZXVlKFt7IGV2ZW50OiAndGVzdCcsIGluZm86ICdpbmZvJyB9XSk7XG4gICAgX3dlYmhvb2tSdW5uZXIucXVldWUucG9wKCk7XG4gICAgZXhwZWN0KF93ZWJob29rUnVubmVyLnF1ZXVlLnF1ZXVlKS50b0VxdWFsKFtdKTtcbiAgfSk7XG5cbiAgdGVzdCgnU2hvdWxkIGNvbmZpZ3VyYXRpb24gZG9lcyBub3Qgb2JqZWN0JywgKCkgPT4ge1xuICAgIGNvbnN0IG9wdHMgPSB7XG4gICAgICBldmVudEh1YjogY3JlYXRlRXZlbnRIdWIoKSxcbiAgICAgIGxvZ2dlcixcbiAgICAgIGNvbmZpZ3VyYXRpb246ICdjb25maWd1cmF0aW9uJyxcbiAgICB9O1xuICAgIGV4cGVjdCgoKSA9PiBjcmVhdGVXZWJob29rUnVubmVyKG9wdHMpKS50b1Rocm93KCk7XG4gIH0pO1xuXG4gIHRlc3QoJ1Nob3VsZCBjcmVhdGUgb3IgZGVsZXRlIGV2ZW50JywgKCkgPT4ge1xuICAgIGNvbnN0IG9wdHMgPSB7IGV2ZW50SHViOiBjcmVhdGVFdmVudEh1YigpLCBsb2dnZXIsIGNvbmZpZ3VyYXRpb246IHt9IH07XG4gICAgY29uc3QgX3dlYmhvb2tSdW5uZXIgPSBjcmVhdGVXZWJob29rUnVubmVyKG9wdHMpO1xuXG4gICAgX3dlYmhvb2tSdW5uZXIuY3JlYXRlTGlzdGVuZXIoJ3Rlc3QnKTtcbiAgICBfd2ViaG9va1J1bm5lci5ldmVudEh1Yi5fZXZlbnRzLnRlc3QoKTtcbiAgICBleHBlY3QoX3dlYmhvb2tSdW5uZXIubGlzdGVuZXJzLmhhcygndGVzdCcpKS50b0JlKHRydWUpO1xuXG4gICAgX3dlYmhvb2tSdW5uZXIuZGVsZXRlTGlzdGVuZXIoJ3Rlc3QnKTtcbiAgICBfd2ViaG9va1J1bm5lci5kZWxldGVMaXN0ZW5lcigndGVzdCcpOy8vIGVsc2UgYnJhbmNoXG4gICAgZXhwZWN0KF93ZWJob29rUnVubmVyLmxpc3RlbmVycy5oYXMoJ3Rlc3QnKSkudG9CZShmYWxzZSk7XG4gIH0pO1xuXG4gIHRlc3QoJ1Nob3VsZCBub3QgY3JlYXRlIGV2ZW50IGlmIGV4aXN0ZWQnLCAoKSA9PiB7XG4gICAgY29uc3Qgb3B0cyA9IHsgZXZlbnRIdWI6IGNyZWF0ZUV2ZW50SHViKCksIGxvZ2dlciwgY29uZmlndXJhdGlvbjoge30gfTtcbiAgICBjb25zdCBfd2ViaG9va1J1bm5lciA9IGNyZWF0ZVdlYmhvb2tSdW5uZXIob3B0cyk7XG5cbiAgICBfd2ViaG9va1J1bm5lci5jcmVhdGVMaXN0ZW5lcigndGVzdCcpO1xuICAgIGV4cGVjdChfd2ViaG9va1J1bm5lci5saXN0ZW5lcnMuaGFzKCd0ZXN0JykpLnRvQmUodHJ1ZSk7XG5cbiAgICBjb25zdCByZXNwID0gX3dlYmhvb2tSdW5uZXIuY3JlYXRlTGlzdGVuZXIoJ3Rlc3QnKTtcbiAgICBleHBlY3QocmVzcCkudG9CZVVuZGVmaW5lZCgpO1xuICB9KTtcblxuICB0ZXN0KCdTaG91bGQgYWRkIHVwZGF0ZSBkZWxldGUgZXhlY3V0ZUxpc3RlbmVyIGEgd2ViaG9vaycsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBvcHRzID0geyBldmVudEh1YjogY3JlYXRlRXZlbnRIdWIoKSwgbG9nZ2VyLCBjb25maWd1cmF0aW9uOiB7fSB9O1xuICAgIGNvbnN0IF93ZWJob29rUnVubmVyID0gY3JlYXRlV2ViaG9va1J1bm5lcihvcHRzKTtcblxuICAgIF93ZWJob29rUnVubmVyLmFkZCh7IGlkOiAnd2ViaG9va0lkJywgZXZlbnRzOiBbJ3Rlc3QnLCAndGVzdCddIH0pO1xuICAgIGV4cGVjdChfd2ViaG9va1J1bm5lci53ZWJob29rc01hcC5oYXMoJ3Rlc3QnKSkudG9CZSh0cnVlKTtcblxuICAgIF93ZWJob29rUnVubmVyLmFkZCh7IGlkOiAnd2ViaG9va0lkMScsIGV2ZW50czogWyd0ZXN0MSddIH0pO1xuICAgIF93ZWJob29rUnVubmVyLnJlbW92ZSh7IGlkOiAnd2ViaG9va0lkMScsIGV2ZW50czogWyd0ZXN0MSddIH0pO1xuICAgIGV4cGVjdChfd2ViaG9va1J1bm5lci53ZWJob29rc01hcC5oYXMoJ3Rlc3QxJykpLnRvQmUoZmFsc2UpO1xuXG4gICAgX3dlYmhvb2tSdW5uZXIudXBkYXRlKHtcbiAgICAgIGlkOiAnd2ViaG9va0lkJyxcbiAgICAgIGV2ZW50czogWyd0ZXN0MSddLFxuICAgICAgaXNFbmFibGVkOiB0cnVlLFxuICAgICAgdXJsOiAndXJsJyxcbiAgICAgIGhlYWRlcnM6IHt9LFxuICAgIH0pO1xuICAgIGV4cGVjdChfd2ViaG9va1J1bm5lci53ZWJob29rc01hcC5oYXMoJ3Rlc3QxJykpLnRvQmUodHJ1ZSk7XG5cbiAgICBhd2FpdCBfd2ViaG9va1J1bm5lci5leGVjdXRlTGlzdGVuZXIoeyBldmVudDogJ3Rlc3QxJyB9KTtcbiAgICBleHBlY3QocmVxdWlyZSgnbm9kZS1mZXRjaCcpKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gICAgYXdhaXQgX3dlYmhvb2tSdW5uZXIuZXhlY3V0ZUxpc3RlbmVyKHsgZXZlbnQ6ICd0ZXN0MScsIGluZm86ICdpbmZvJyB9KTtcbiAgICBleHBlY3QocmVxdWlyZSgnbm9kZS1mZXRjaCcpKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMik7XG4gICAgYXdhaXQgX3dlYmhvb2tSdW5uZXIuZXhlY3V0ZUxpc3RlbmVyKHsgZXZlbnQ6ICd0ZXN0MScsIGluZm86ICdpbmZvJyB9KTtcbiAgICBleHBlY3QocmVxdWlyZSgnbm9kZS1mZXRjaCcpKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMyk7XG4gIH0pO1xuXG4gIHRlc3QoJ1Nob3VsZCBsb2cgZXJyb3IgYWZ0ZXIgZXhlY3V0ZUxpc3RlbmVyJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IG9wdHMgPSB7IGV2ZW50SHViOiBjcmVhdGVFdmVudEh1YigpLCBsb2dnZXIsIGNvbmZpZ3VyYXRpb246IHt9IH07XG4gICAgY29uc3QgX3dlYmhvb2tSdW5uZXIgPSBjcmVhdGVXZWJob29rUnVubmVyKG9wdHMpO1xuICAgIF93ZWJob29rUnVubmVyLmFkZCh7IGlkOiAnd2ViaG9va0lkJywgZXZlbnRzOiBbJ3Rlc3QnXSB9KTtcbiAgICBfd2ViaG9va1J1bm5lci51cGRhdGUoe1xuICAgICAgaWQ6ICd3ZWJob29rSWQnLFxuICAgICAgZXZlbnRzOiBbJ3Rlc3QxJ10sXG4gICAgICBpc0VuYWJsZWQ6IHRydWUsXG4gICAgICB1cmw6ICd1cmwnLFxuICAgICAgaGVhZGVyczoge30sXG4gICAgfSk7XG4gICAgX3dlYmhvb2tSdW5uZXIucnVuID0gamVzdC5mbigoKSA9PiBQcm9taXNlLnJlamVjdChmYWxzZSkpO1xuICAgIGF3YWl0IF93ZWJob29rUnVubmVyLmV4ZWN1dGVMaXN0ZW5lcih7IGV2ZW50OiAndGVzdDEnLCBpbmZvOiAnaW5mbycgfSk7XG4gICAgZXhwZWN0KF93ZWJob29rUnVubmVyLnJ1bikudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICB9KTtcbn0pO1xuIl19